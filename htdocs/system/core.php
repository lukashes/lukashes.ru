<? $stopwatch=microtime(); define('E2_VERSION',2445); define('E2_VERSION_NAME','Эгея Бета'); define('E2_RELEASE','2.0&beta;'); define('E2_VERSION_DETAILS','(релиз '. E2_RELEASE .', v'. E2_VERSION .')'); define('E2_VERSION_DESCRIPTION',E2_VERSION_NAME .' '. E2_VERSION_DETAILS); define('E2_UA_STRING','E2 (v'.E2_VERSION.'; Aegea Beta)'); header('X-Powered-By: E2 '. E2_VERSION_DESCRIPTION); setlocale(LC_CTYPE,'ru_RU.CP1251'); if(function_exists('date_default_timezone_set'))date_default_timezone_set('GMT'); error_reporting(E_ALL); define('RUN_ID',chr(rand(65,90))); define('DEV_TRACK_TIME',false); define('DEV_HOST','e2'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); define('YEAR_DISPLAY_THRESH',7884000); define('KILO_THRESH',768); define('BYTES_DECIMALS',1); define('FILE_READ_BUFFER',64*1024); define('KEYWORDS_MANY_THRESH',50); define('NEW_FILES_RIGHTS',0777); define('DOWNLOAD_UPDATES',false); define('ROOT_FOLDER',$_SERVER['DOCUMENT_ROOT'] . (($_SERVER['DOCUMENT_ROOT']!='/')?'/':'')); define('CACHES_FOLDER','caches/'); define('TEMPLATES_FOLDER','themes/'); define('PICTURES_FOLDER','pictures/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('DEFAULT_TEMPLATE_FOLDER','system/theme/'); define('DEFAULTS_FOLDER','system/default/'); define('USER_FOLDER','user/'); define('EXTRAS_FOLDER','user/extras/'); define('BACKUP_FOLDER','backups/'); define('MTMPL_FOLDER','system/default/mail/'); define('NO_REASON',''); define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_RSS',CACHES_FOLDER.'index.xml'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('IMPORT_DB_SETTINGS',true); define('DB_PASSWORD_RECOVER_AND_SHOW',false); define('RSS_LANGUAGE','ru'); define('OUTPUT_CHARSET','Windows-1251'); define('DEFAULT_BLOG_TITLE','Мой блог'); define('DEFAULT_BLOG_AUTHOR','Автор блога'); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('DB_CANNOT_FIND', -1); define('DB_CANNOT_CONNECT', -2); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('CSS_CLASS_HIGHLIGHT','e2-marked'); define('THUMB_WIDTH',86); define('THUMB_HEIGHT',64); define('THUMB_JPG_QUALITY',80); define('TRANS_TAGS_UTF8_URLS',false); @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); if($_config['write_log']) { define('__LOG',1); } else { define('__LOG',0); } $ra57c1=substr($_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php')); $p57de2=$_SERVER['SERVER_NAME']; if(80!=$_SERVER['SERVER_PORT'])$p57de2.=':'. $_SERVER['SERVER_PORT']; $kf97aa='http://'. $p57de2.$ra57c1; $l097cc='http://'. $p57de2.$_SERVER['REQUEST_URI']; $w5269f=@$_SERVER['HTTP_USER_AGENT'] or $w5269f=''; $_ios=strstr($w5269f,'iPhone') || strstr($w5269f,'iPad'); $_macintosh=strstr($w5269f,'Macintosh'); $_opera=strstr($w5269f,'Opera'); error_reporting(E_ALL); $_db_error=false; $_fp_error=false; $user_globals=array(); $s589b3=true; if(strstr(__FILE__,'all.php'))$s589b3=false; function __log($p1cb25,$cc9e9a=0){ global$_live_log,$stopwatch; $r605ac=str_pad(round(e7f78(),5),19,' ',STR_PAD_RIGHT); $zaf240=str_pad(round(e7f78()-$stopwatch,5),10,' ',STR_PAD_RIGHT); $_live_log[] = array (time(),$zaf240,$p1cb25,$cc9e9a); $m8e13f=$r605ac .' <'. RUN_ID .'> '. $zaf240 .' '. $p1cb25."\n"; if(function_exists('file_put_contents')) { @file_put_contents(USER_FOLDER.'log.txt',$m8e13f,FILE_APPEND); @chmod(USER_FOLDER.'log.txt',NEW_FILES_RIGHTS); } } function e2_go_to($h56790=''){ global $p57de2,$ra57c1; @session_start(); $_SESSION['errors']=nf8d8(); if(substr($h56790,0,7)!='http://'){ header('Location: http://'. $p57de2.$ra57c1 .'/'. $h56790); } else { header('Location: '. $h56790); } flush(); return TRUE; } function f4930(){ $t469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($t469bb); } function w4924($h56790){ if($_SERVER['HTTP_REFERER'])$h56790=$_SERVER['HTTP_REFERER']; return e2_go_to($h56790); } function w8c3b($eb2145=''){ $e9dd4e=substr_count($_SERVER['SERVER_NAME'],'.'); $s2cb9d=@str_repeat('_',$e9dd4e).$eb2145; return $s2cb9d; } function gc64a($eb2145,$v2063c='',$kb0b70=true){ $fcd91e=$kb0b70? (time()+3600*24*365) : (0); $gad5f8=$_SERVER['SERVER_NAME']; $ie9c6c=substr_count($gad5f8,'.'); if ($ie9c6c < 3)$gad5f8=str_repeat('.',3-$ie9c6c).$gad5f8; $e9dd4e=setcookie(w8c3b($eb2145),$v2063c,$fcd91e,'/'); } function n163d($j183d6,$mb45cf,$dcadc8=''){ if(trim($mb45cf)!=''){ $mb45cf=explode($j183d6,$mb45cf); foreach ($mb45cf as $m865c0 => $f8ce4b)$mb45cf[$m865c0]=trim($f8ce4b); foreach ($mb45cf as $m865c0 => $f8ce4b) if ($f8ce4b=='') unset ($mb45cf[$m865c0]); $o7b774=array_unique($mb45cf); if ('sort'==$dcadc8)sort($o7b774); return $o7b774; } else return array (); } function ebb8d($mb45cf){ global$_macintosh,$_opera,$_ios; if($_ios) return ''; $x902bc='<span class="tsp">&nbsp;</span>'; $jd7d18=$x902bc .'+'. $x902bc; $x902bc=''; if ($mb45cf=='submit'){ if($_opera and $_macintosh){ return '&#x2318;'. $x902bc .'&#x21a9;'; } elseif($_macintosh){ return '&#x2303;'. $x902bc .'&#x21a9;'; } else { return 'Ctrl'. $jd7d18 .'Enter'; } } if ($mb45cf=='login'){ return 'L'; } if ($mb45cf=='livesave'){ if($_opera and $_macintosh){ return '&#x2303;'. $x902bc .'S'; } elseif($_macintosh){ return '&#x2318;'. $x902bc .'S'; } else { return 'Ctrl'. $jd7d18 .'S'; } } if ($mb45cf=='navigation'){ if($_opera and $_macintosh){ return '&#x2318;'. $x902bc .'&#x21e7;'; } elseif($_macintosh){ return '&#x2303;'; } else { return 'Ctrl'; } } } function e2_htmlentities($mb45cf){ for ($m865c0=0; $m865c0<strlen($mb45cf); $m865c0++) $s2cb9d.='&#'.ord($mb45cf{$m865c0}).';'; return $s2cb9d; } function e2_unhtmlentities($mb45cf){ $mb45cf=preg_replace('/\&\#([0-9]+?)\;/e','chr ($1)',$mb45cf); if(function_exists('mb_convert_encoding')) $mb45cf=mb_convert_encoding($mb45cf,'ascii'); return $mb45cf; } function v01d3($mb45cf){ $a2db95=strlen($mb45cf); return strspn($mb45cf,'abcdefghijklmnopqrstuvwxyz-1234567890')==$a2db95 and $a2db95 > 0; } function d7b91($p1cb25){ $p1cb25=str_replace('<','&lt;',$p1cb25); $p1cb25=str_replace('>','&gt;',$p1cb25); return $p1cb25; } function kc4b6($p1cb25){ $p1cb25=str_replace('"','&quot;',$p1cb25); return $p1cb25; } function e2_preserve_string($a03c7c){ $a03c7c=$a03c7c[1]; $a03c7c=str_replace('<br />',"\n",$a03c7c); $a03c7c=htmlspecialchars($a03c7c,ENT_NOQUOTES); return '<font color="#dd0000">'.$a03c7c.'</font>'; } function e2_unpreserve_string($a03c7c){ $a03c7c=$a03c7c[1]; $a03c7c=mce9b($a03c7c); return $a03c7c; } function gc198($pe358e){ $pe358e=highlight_string($pe358e,true); $pe358e=preg_replace('/\<font color\=\"\#ff8000\"\>(.*?)\<\/font\>/i','',$pe358e); $pe358e=preg_replace_callback('/\<font color\=\"\#dd0000\"\>(.*?)\<\/font\>/i','e2_preserve_string',$pe358e); $pe358e=preg_replace('/(\<br \/\>|\s)+/',' ',$pe358e); $pe358e=preg_replace_callback('/\<font color\=\"\#dd0000\"\>(.*?)\<\/font\>/i','e2_unpreserve_string',$pe358e); $pe358e=preg_replace('/\<(?!\?)(.*?)(?<!\?)\>/','',$pe358e); $pe358e=str_replace('&nbsp;',' ',$pe358e); $pe358e=mce9b($pe358e); $pe358e=trim($pe358e); return $pe358e; } function rd738($icbb11){ $icbb11=iconv('CP1251','UTF-8',$icbb11); header('Content-type: text/html; charset=utf-8'); echo $icbb11; } function gd056($v2063c,$l5d6db){ return str_replace('.',',',round($v2063c,$l5d6db)); } function iada7($mb45cf){ $s2cb9d=''; for ($m865c0==0; $m865c0 <= strlen($mb45cf); ++ $m865c0){ $s2cb9d.='\\'. $mb45cf[$m865c0]; } return $s2cb9d; } function v0786($x957b5){ return sprintf('%u',ip2long($x957b5)); } function d7c85($mb1bc2){ return long2ip(sprintf('%d',$mb1bc2)); } function eace2($p1cb25,$mb1bc2=null){ $a2f713=$p1cb25; if ($mb1bc2===null){ $mb1bc2=substr($p1cb25,0,strpos($p1cb25,' ')); $a2f713=substr($p1cb25,strpos($p1cb25,' ')+1); } $af07c9=strpos($a2f713,'('); $p46901=strpos($a2f713,')'); if ($p46901 > $af07c9)$s22b9f=substr($a2f713,$af07c9,$p46901-$af07c9+1); $a93da6=explode(',',trim(@$s22b9f,'()')); if(count($a93da6)==2)array_unshift($a93da6,''); $bc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($mb1bc2%100 > 10 and $mb1bc2%100 < 20)$acd14c=2; else $acd14c=$bc78bd[$mb1bc2%10]; $tef3e3=$a93da6[$acd14c]; $p1cb25=str_replace($s22b9f,$tef3e3,$p1cb25); if(strstr($p1cb25,'(') and strstr($p1cb25,')')) { return eace2($p1cb25,$mb1bc2); } else { return $p1cb25; } } define('_SIZE_UNIT', -1); define('_SIZE_AUTO',0); define('_SIZE_B', 1); define('_SIZE_KB', 2); define('_SIZE_MB', 3); define('_SIZE_GB', 4); define('_SIZE_TB', 5); function q2d88($g4a202,$ee5431=_SIZE_AUTO){ global$_format_size_latest_unit; if ($g4a202==_SIZE_UNIT) return$_format_size_latest_unit; $l4b3a6=$g4a202; $cb98b3=array ('Б','КБ','МБ','ГБ','ТБ'); for ($m865c0=0; $m865c0 < count($cb98b3)-1; ++ $m865c0){ if ( (!$ee5431 and $l4b3a6 < KILO_THRESH) or ($ee5431 and $m865c0==$ee5431-1) ) break; $l4b3a6 /= 1024; } $v2063c=str_replace('.',',',round($l4b3a6,BYTES_DECIMALS)); if ($ee5431!=_SIZE_AUTO){ if (!strstr($v2063c,','))$v2063c.=','; $v2063c=str_pad($v2063c,strpos($v2063c,',')+1+BYTES_DECIMALS,'0'); } $_format_size_latest_unit=$cb98b3[$m865c0]; return $v2063c; } function pc5a6($pf2ce1){ $r87e9e=glob($pf2ce1,GLOB_NOSORT); if(is_array($r87e9e)) { foreach ($r87e9e as $j435ed){ @unlink($j435ed); } } } function f74dc($x73600){ $r87e9e=glob($x73600 .'*',GLOB_NOSORT); if(is_array($r87e9e)) { foreach ($r87e9e as $j435ed){ if(basename($j435ed)!='.' and basename($j435ed)!='..'){ if(is_dir($j435ed)) { if (f74dc($j435ed .'/')) { if (!rmdir($j435ed)) { return false; } } else { return false; } } else { @unlink($j435ed); } } } return true; } else { return false; } } function jcc38($b572d4){ global $p57de2,$ra57c1; if(__LOG)__log('Spawn '. $b572d4 .'...'); $b572d4=str_replace('http://'. $p57de2,'',$b572d4); $v0666f=@fsockopen($_SERVER['SERVER_NAME'],$_SERVER['SERVER_PORT'],$b70106,$n809b1,1); if(__LOG)__log('Spawn fsockopen returns '. $v0666f .', (errno='. $b70106 .', errstr='. $n809b1 .')...'); if ($v0666f){ @socket_set_timeout($v0666f,1); $b8d777 = 'GET '. $b572d4 ." HTTP/1.0\r\n". 'Host: '. $p57de2 ."\r\n". 'User-Agent: '. E2_UA_STRING ."\r\n". eff2e(); $p5e369=@fwrite($v0666f,$b8d777 ."\r\n"); $p5e369=@fclose($v0666f); return true; } else { return false; } } function baf42($ld6fe1){ $ld6fe1=trim($ld6fe1,'/'); $ld6fe1=explode('/',$ld6fe1); $x73600=''; foreach ($ld6fe1 as $k83878){ $x73600=$x73600.$k83878; if (!is_dir($x73600)) { if (@mkdir($x73600)) { @chmod($x73600,NEW_FILES_RIGHTS); } else { return false; } } $x73600=$x73600.'/'; } return true; } function v4d36($ld6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$ld6fe1); } function mce9b($mb45cf){ $qcee6f=get_html_translation_table(HTML_ENTITIES); $qcee6f=array_flip($qcee6f); return strtr($mb45cf,$qcee6f); } function e7f78($i32c11=NULL){ if(NULL==$i32c11)$i32c11=microtime(); list ($l6021b,$g74459)=explode(' ',$i32c11); return ((float)$l6021b + (float)$g74459); } $stopwatch=e7f78($stopwatch); function wedd9($re98a6,$w98df3=false){ $s80a41=''; $rf5a8e=strlen($re98a6); for ($m865c0=0; $m865c0 < 256; ++ $m865c0){ $xf3d13[$m865c0]=0; $h0fc3c=$m865c0; while ($h0fc3c & 0x00000080){ $h0fc3c <<= 1; ++ $xf3d13[$m865c0]; } } for ($m865c0=0xd090; $m865c0 <= 0xd0bf; $m865c0++)$k84a26[$m865c0]=chr(($m865c0 & 0x000000ff)+48); for ($m865c0=0xd180; $m865c0 <= 0xd18f; $m865c0++)$k84a26[$m865c0]=chr(($m865c0 & 0x000000ff)+112); $k84a26[0xd081]="\xa8"; $k84a26[0xd191]="\xb8"; $k84a26[0xc299]="\x99"; $k84a26[0xc2a9]="\xa9"; $k84a26[0xc2ae]="\xae"; $k84a26[0xc2ab]="\xab"; $k84a26[0xc2bb]="\xbb"; $k84a26[0xc2a0]="\xa0"; $m865c0=0; while ($m865c0 < $rf5a8e){ $yac558=$re98a6{$m865c0}; $jc267c=ord($yac558); if ($xf3d13[$jc267c]==0){ $s80a41.=$yac558; ++ $m865c0; } elseif ($xf3d13[$jc267c]==2){ $l06214=$k84a26[($jc267c << 8) | ord($re98a6{$m865c0+1})]; $s80a41 .= ($l06214!=null)? $l06214 : ( $w98df3? ('((html '. oebe5(substr($re98a6,$m865c0,2)) .'))'):'?' ); $m865c0+=2; } else { $rdfbc9=substr($re98a6,$m865c0,$xf3d13[$jc267c]); if ($rdfbc9=="\xe2\x84\x96")$s80a41.="\xb9"; elseif ($rdfbc9=="\xe2\x80\x93")$s80a41.="\x96"; elseif ($rdfbc9=="\xe2\x80\x94")$s80a41.="\x97"; elseif ($rdfbc9=="\xe2\x80\x98")$s80a41.="\x91"; elseif ($rdfbc9=="\xe2\x80\x99")$s80a41.="\x92"; elseif ($rdfbc9=="\xe2\x80\x9a")$s80a41.="\x82"; elseif ($rdfbc9=="\xe2\x80\x9c")$s80a41.="\x93"; elseif ($rdfbc9=="\xe2\x80\x9d")$s80a41.="\x94"; elseif ($rdfbc9=="\xe2\x80\x9e")$s80a41.="\x84"; elseif ($rdfbc9=="\xe2\x80\xa6")$s80a41.="\x85"; elseif ($rdfbc9=="\xe2\x80\xb9")$s80a41.="\x8b"; elseif ($rdfbc9=="\xe2\x80\xba")$s80a41.="\x9b"; elseif ($rdfbc9=="\xe2\x82\xac")$s80a41.="\x88"; elseif ($rdfbc9=="\xe2\x84\xa2")$s80a41.="\x99"; else $s80a41.=$w98df3? ('((html '. oebe5($rdfbc9) .'))'):'?'; $m865c0+=$xf3d13[$jc267c]; } } return $s80a41; } function oebe5($q4a8a0){ $qcc411=''; $rf5a8e=strlen($q4a8a0); for ($m865c0=0; $m865c0 < $rf5a8e; ++ $m865c0){ $qcc411.=preg_replace('/^1*0/','',decbin(ord($q4a8a0{$m865c0}))); } return '&#'. bindec($qcc411) .';'; } function nfd97($d341be) { $s2cb9d=$d341be; $s2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$s2cb9d); return $s2cb9d; } function e2_utf_from_windows_1251_char($q4a8a0){ list (, $q4a8a0)=$q4a8a0; if ($q4a8a0=="\xA8") return "\xD0\x81"; if ($q4a8a0=="\xB8") return "\xD1\x91"; if ($q4a8a0 >= "\xC0" && $q4a8a0 <= "\xEF") return "\xD0".chr(ord($q4a8a0)-48); if ($q4a8a0 >= "\xF0") return "\xD1".chr(ord($q4a8a0)-112); if ($q4a8a0=="\x85") return "&#8230;"; if ($q4a8a0=="\x96") return "&#8211;"; if ($q4a8a0=="\x97") return "&#8212;"; if ($q4a8a0=="\xAB") return "&#0171;"; if ($q4a8a0=="\xBB") return "&#0187;"; if ($q4a8a0=="\x91") return "&#8216;"; if ($q4a8a0=="\x92") return "&#8217;"; if ($q4a8a0=="\x93") return "&#8220;"; if ($q4a8a0=="\x94") return "&#8221;"; if ($q4a8a0=="\x84") return "&#8222;"; if ($q4a8a0=="\x99") return "&#8482;"; if ($q4a8a0=="\xb9") return "&#8470;"; if ($q4a8a0=="\xa0") return "&#0160;"; return '?'; }; function ocdf0($c8c7dd){ if(function_exists('file_get_contents')) { return @file_get_contents($c8c7dd); } else { $d8fa14=fopen($c8c7dd,"rb"); clearstatcache(); $pe358e=fread($d8fa14,filesize($c8c7dd)); fclose($d8fa14); return $pe358e; } } function k6e52($c8c7dd,$mb45cf){ if(function_exists('file_put_contents')) { if (!file_put_contents($c8c7dd,$mb45cf,LOCK_EX)) { return false; } } else { if ($v0666f=@fopen($c8c7dd,'a+b')) { flock($v0666f,LOCK_EX); ftruncate($v0666f,0); fseek($v0666f,0); fwrite($v0666f,$mb45cf); fclose($v0666f); } else { return false; } } @chmod($c8c7dd,NEW_FILES_RIGHTS); return true; } function vcd2d($c8c7dd,$mb45cf){ if(function_exists('file_put_contents')) { $s2cb9d=@file_put_contents($c8c7dd,$mb45cf); @chmod($c8c7dd,NEW_FILES_RIGHTS); return $s2cb9d; } else { $d8fa14=@fopen($c8c7dd,'ab'); if ($d8fa14){ if (@flock($d8fa14,LOCK_EX)) { $wb92d9=ignore_user_abort(1); @ftruncate($d8fa14,0); @fseek($d8fa14,0); fwrite($d8fa14,$mb45cf); fflush($d8fa14); @flock($d8fa14,LOCK_UN); fclose($d8fa14); @chmod($c8c7dd,NEW_FILES_RIGHTS); ignore_user_abort($wb92d9); return true; } else { fclose($d8fa14); return false; } } else { return false; } } } function x1825($v96704){ $k89484='абвгдеёжзийклмнопрстуфхцчшщъыьэюяАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ'; if(strspn($v96704,$k89484) > 0){ $v96704=strtr($v96704,$k89484,'abvgdеёжzijklmnoprstufhcчшщъyьeюяABVGDЕЁЖZIJKLMNOPRSTUFHCЧШЩЪYЬEЮЯ'); $v96704=strtr($v96704, array ( 'е' => 'je', 'ё' => 'jo', 'ж' => 'zh', 'ч' => 'ch', 'ш' => 'sh', 'щ' => 'sch', 'ъ' => '\'', 'ь' => '\'', 'ю' => 'ju', 'я' => 'ja', 'Е' => 'Je', 'Ё' => 'Jo', 'Ж' => 'Zh', 'Ч' => 'Ch', 'Ш' => 'Sh', 'Щ' => 'Sch', 'Ъ' => '\'', 'Ь' => '\'', 'Ю' => 'Ju', 'Я' => 'Ja', )); d8a40('В имени файла использовались русские буквы. Во избежание проблем, они были заменены латинскими: "'.$v96704.'"'); } if(strstr($v96704,' ')) { $v96704=strtr($v96704, array (' ' => '-')); d8a40('В имени файла использовались пробелы. Во избежание проблем, они были заменены дефисами: "'.$v96704.'"'); } if(is_file(PICTURES_FOLDER.$v96704)) { $k5c917=substr($v96704,0,strrpos($v96704,'.')); $eabf77=substr($v96704,strrpos($v96704,'.')); $m865c0=0; while (is_file($k5c917.'_'.++$m865c0.$eabf77)); $v96704=$k5c917.'_'.$m865c0.$eabf77; d8a40('Файл с таким именем уже есть, поэтому новый файл был закачан под именем "'.$v96704.'"'); } return $v96704; } function r291d($vaf721){ global$_config; $qa93b8=pathinfo($vaf721); $eabf77=$qa93b8['extension']; if(in_array(strtolower($eabf77), array ('jpg','gif','png'))) { $vf1210=THUMBNAILS_FOLDER.str_replace($eabf77,'thumb.'. $eabf77,$vaf721); if (!is_file($vf1210)) { if (@baf42(THUMBNAILS_FOLDER)) { h15e4( PICTURES_FOLDER.$vaf721, THUMB_WIDTH,THUMB_HEIGHT,THUMB_JPG_QUALITY,$vf1210 ); if(is_file($vf1210)) { chmod($vf1210,$_config['uploaded_files_mode']); } else { return false; } } } return $vf1210; } return false; } function e2j_file_upload(){ global$_config; @baf42(PICTURES_FOLDER); @chmod(PICTURES_FOLDER,$_config['uploaded_files_mode']); foreach($_FILES as $c8c7dd){ if (!$c8c7dd['error']) { if(__LOG)__log('Ajax file upload: <'. $c8c7dd['name'].'>'); $v96704=x1825($c8c7dd['name']); move_uploaded_file($c8c7dd['tmp_name'],PICTURES_FOLDER.$v96704); @chmod(PICTURES_FOLDER.$v96704,$_config['uploaded_files_mode']); if ($vf1210=r291d($v96704)) { if(__LOG)__log('Ajax file upload: thumbnail, done'); die ('image|'. $v96704 .'|'. $vf1210); } else { @unlink(PICTURES_FOLDER.$v96704); die ('error|could-not-create-thumbnail'); } } elseif(4!=$c8c7dd['error']) { if ($c8c7dd['error']==1){ die ('error|too-big'); } elseif ($c8c7dd['error']==2){ die ('error|too-big'); } elseif ($c8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $c8c7dd['error']); } } } if(__LOG)__log('Ajax file upload error: no files'); die ('error|no-files'); } function e2j_file_remove(){ $c8c7dd=$vf1210=''; if(array_key_exists('file',$_POST))$c8c7dd=$_POST['file']; if(array_key_exists('thumb',$_POST))$vf1210=$_POST['thumb']; if ($c8c7dd){ $rf6347=@unlink(PICTURES_FOLDER.$c8c7dd); $i8f458=@unlink($vf1210); if ($rf6347 and $i8f458) die ('done-file-and-thumb'); if ($rf6347) die ('done-file'); if ($i8f458) die ('done-thumb'); die ('nothing'); } die ('error|no-filename-passed'); } function r74e0(){ global $n2e5d8; if (!isset ($n2e5d8))$n2e5d8=array(); if(is_file(USER_FOLDER.'settings.psa')) { $pfa816=unserialize(ocdf0(USER_FOLDER.'settings.psa')); if (!is_array($pfa816))$pfa816=array(); $n2e5d8=array_merge($n2e5d8,$pfa816); } if ( !is_numeric(@$n2e5d8['appearance']['notes_per_page']) or @$n2e5d8['appearance']['notes_per_page'] < 1 ){ $n2e5d8['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$n2e5d8['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $n2e5d8['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$n2e5d8) or !array_key_exists('on', @$n2e5d8['comments']) ) { $n2e5d8['comments']['on']=true; } return true; } function e2m_name_and_author(){ global $n2e5d8,$_template; $s2cb9d['title']='Название и автор'; $s2cb9d['heading']='Название и автор'; $s2cb9d['form']='form-name-and-author'; $s2cb9d['form-name-and-author'] = array ( 'form-action' => f83c8('e2s_name_and_author'), 'blog-title-default' => htmlspecialchars(DEFAULT_BLOG_TITLE,ENT_NOQUOTES), 'blog-title' => htmlspecialchars(t6f51(),ENT_NOQUOTES), 'blog-description' => htmlspecialchars(@$n2e5d8['description'],ENT_NOQUOTES), 'blog-author-default' => htmlspecialchars(DEFAULT_BLOG_AUTHOR,ENT_NOQUOTES), 'blog-author' => htmlspecialchars(@$n2e5d8['author'],ENT_NOQUOTES), 'submit-text' => 'Сохранить изменения', ); return $s2cb9d; } function e2s_name_and_author(){ global $n2e5d8; $q05df2=$x67daf=''; if(array_key_exists('blog-title',$_POST)) $q05df2=trim($_POST['blog-title']); if(array_key_exists('blog-description',$_POST))$x67daf = trim($_POST['blog-description']); if(array_key_exists('blog-author',$_POST)) $n02bd9=trim($_POST['blog-author']); $n2e5d8['site_title']=$q05df2; $n2e5d8['site_title']=t6f51(); $n2e5d8['description']=$x67daf; $n2e5d8['author']=$n02bd9; pc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!k6e52(USER_FOLDER.'settings.psa',serialize($n2e5d8))) { d8a40('Не получается сохранить информацию'); } e2_go_to(f83c8('e2m_frontpage')) and die; } function e2m_settings(){ global $n2e5d8,$_template; $s2cb9d['title']='Настройка'; $s2cb9d['heading']='Настройка'; $s2cb9d['form']='form-preferences'; $s2cb9d['form-preferences'] = array ( 'form-action' => f83c8('e2s_settings_save'), 'notes-per-page' => $n2e5d8['appearance']['notes_per_page'], 'email-notify?' => (bool) @$n2e5d8['notifications']['new_comments'], 'email' => htmlspecialchars(@$n2e5d8['user']['email'],ENT_NOQUOTES), 'comments-on?' => (bool) @$n2e5d8['comments']['on'], 'comments-fresh-only?' => (bool) @$n2e5d8['comments']['fresh_only'], 'hot-block?' => (bool) (@$n2e5d8['appearance']['hot_frontpage']), 'favourites-block?' => (bool) @$n2e5d8['appearance']['favourites_frontpage'], 'template-name' => $_template['name'], 'templates' => x94dd(), 'submit-text' => 'Сохранить изменения', ); return $s2cb9d; } function e2s_settings_save(){ global $n2e5d8; $q05df2=$x67daf=''; if(array_key_exists('email',$_POST)) $z0c83f=trim($_POST['email']); if(array_key_exists('template',$_POST)) $i66f61=trim($_POST['template']); $n2e5d8['user']['email']=$z0c83f; $f0c2bd=(int)$_POST['notes-per-page']; if ( $n2e5d8['appearance']['notes_per_page']!=$f0c2bd or $n2e5d8['comments']['on'] != isset ($_POST['comments-on']) or $n2e5d8['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $n2e5d8['appearance']['notes_per_page']=$f0c2bd; $n2e5d8['comments']['on'] = isset ($_POST['comments-on']); $n2e5d8['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } $n2e5d8['notifications']['new_comments'] = isset ($_POST['email-notify']); $n2e5d8['appearance']['favourites_frontpage'] = isset ($_POST['favourites-block']); $n2e5d8['appearance']['hot_frontpage'] = isset ($_POST['hot-block']); $n2e5d8['template']=$i66f61; if (!k6e52(USER_FOLDER.'settings.psa',serialize($n2e5d8))) { d8a40('Не получается сохранить настройку'); } e2_go_to(f83c8('e2m_frontpage')) and die; } function e2m_database(){ global $n2e5d8; $s2cb9d['title']='База данных'; $s2cb9d['heading']='База данных'; $s2cb9d['form']='form-database'; $s2cb9d['form-database'] = array ( 'form-action' => f83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$n2e5d8['db']['server']? $n2e5d8['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$n2e5d8['db']['user_name']? $n2e5d8['db']['user_name']:'root'), 'db-password' => htmlspecialchars(@$n2e5d8['db']['passw']), 'db-database' => htmlspecialchars(@$n2e5d8['db']['name']), 'db-prefix' => htmlspecialchars(@$n2e5d8['db']['table_prefix']? $n2e5d8['db']['table_prefix']:'e2Blog'), 'submit-text' => 'Подключиться к базе с этими параметрами', ); return $s2cb9d; } function e2s_database_save(){ global $n2e5d8; if(array_key_exists('db-server',$_POST)) { $n2e5d8['db']['server'] = @$_POST['db-server']; $n2e5d8['db']['user_name'] = @$_POST['db-user']; $n2e5d8['db']['passw'] = @$_POST['db-password']; $n2e5d8['db']['name'] = @$_POST['db-database']; $n2e5d8['db']['table_prefix'] = @$_POST['db-prefix']; if (!k6e52(USER_FOLDER.'settings.psa',serialize($n2e5d8))) { d8a40('Не получается сохранить настройку'); } e2_drop_all_kinds_of_cache(); } e2_go_to(f83c8('e2m_settings')) and die; } r74e0(); function d8a40($x67daf,$y599dc='error'){ global$errors,$n2e5d8,$_config; $j90f2d='Не удалось сформировать backtrace. Функция не поддерживается вашей версией PHP (необходима 4.3 или выше)'; if(function_exists('debug_backtrace'))$j90f2d=debug_backtrace(); $errors[] = array ( 'description' => $x67daf, 'location' => NULL, 'backtrace' => $j90f2d, 'type' => $j90f2d, ); if(count($errors) == @$_config['max_errors']) { d8a40('Слишком много ошибок'); echo mec07(); die; } return true; } function ce1c4($ec1336,$x67daf){ if(0==error_reporting() or ($ec1336 & 8)) return; global$errors; d8a40('PHP ('.$ec1336.'): '.$x67daf); $errors[count($errors)-1]['phpcode']=$ec1336; } function u4193(){ global$errors; return (count($errors) > 0); } function nf8d8(){ global$errors; return$errors; } function j2616($l69206){ global $ra57c1; $l69206=array_reverse($l69206); $l69206=array_splice($l69206,0,count($l69206)-1); $he1671='<div style="background: #fea; padding: .25em .5em; margin: .5em 1em 1em 0; line-height: 1em; overflow: hidden">'; foreach ($l69206 as $m865c0 => $pe358e){ $b195df=@$pe358e['args'] or $b195df=array(); $ja956a=array(); foreach ($b195df as $l5919c){ $ja956a[] = var_export($l5919c,true); } $c8c7dd=@$pe358e['file']; $c8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$c8c7dd); $l6438c=(@$pe358e['line']? (' #'. $pe358e['line']) : '?'); $he1671.='<div style="margin: .25em 0 .5em '. $m865c0*3 .'em">'; $he1671.='<span style="float: right; color: #666"> '. $c8c7dd.$l6438c .'</span>'; $he1671.='<tt><b>'. @$pe358e['function'] .' (</b>'; if(count($ja956a)) { $ieb84a=str_replace("array (\n)",'array ()',$ja956a); $ieb84a=implode(', ',$ieb84a); if(0){ $ieb84a=highlight_string('<?'. $ieb84a .'?'.'>',true); $ieb84a=substr($ieb84a,77, -28); } $ieb84a=str_replace('&nbsp;',' ',$ieb84a); $ieb84a=nl2br($ieb84a); $he1671.='<div style="margin: 0 0 0 1.12em">'. $ieb84a .'</div>'; } $he1671.='<b>)</b> &rarr;</tt></div>'; } $he1671.='</div>'; return $he1671; } function mec07(){ global$errors,$n2e5d8,$_config; @session_start(); if(is_array(@$_SESSION['errors'])) { $he1671=array_merge(@$_SESSION['errors'],$errors); } else { $he1671=$errors; } $f1897a=(!qe852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $f1897a and $he1671!=NULL){ k6e52('backtrace.psa',serialize($he1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); if(count($he1671) > 0){ foreach ($he1671 as $m865c0 => $h08a44){ $he1671[$m865c0]='<li><b>'.$h08a44['description'].'</b>'; if ($f1897a){ $he1671[$m865c0].='<br /><small>'. j2616($h08a44['backtrace']). '</small>'; } $he1671[$m865c0].='</li>'; } if (@$_config['store_backtrace'] and $f1897a and is_file('debug.php')) return @('<ul>'.implode('<br />',$he1671).'</ul>').'<p><a href="debug.php">Отладка</a></p>'; else return @('<ul>'.implode('<br />',$he1671).'</ul>'); } else { return ''; } } set_error_handler('ce1c4'); function e2_error404_mode(){ global$_strings; header('HTTP/1.1 404 Not found'); $se70c4['error-404-description']=$_strings['gs--page-not-found']; $se70c4['title']=$se70c4['error-404-description']; return $se70c4; } define('HEL_VERSION','1.54'); define('HEL_SPECIAL_CHAR',"\x1"); define('HEL_SPECIAL_SEQUENCE_LENGTH',6); define('HEL_ADVANCED_FORMATTING',false); define( 'HEL_GLUE_WORDS', '(а|в|во|въ|и|к|ко|къ|о|об|обо|объ|с|со|cъ|у|я|без|безо|безъ|для|до|за|из|изъ|или|на|над|надъ|не|ни|но|от|отъ|по|под|подъ|при|про|a|an|as|and|\&|at|but|by|for|in|no|not|of|on|or|per|the|to)' ); define('HEL_TAG','\\'.HEL_SPECIAL_CHAR .'\d{'. HEL_SPECIAL_SEQUENCE_LENGTH .'}'); define('HEL_TAGS','('. HEL_TAG .')*'); define('HEL_CODEPAGE','win-1251'); function hel_version(){ return HEL_VERSION; } function hel_expand_index($p6a992){ return str_pad($p6a992,HEL_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT); } function hel_savetag($le4d23){ global $n16234; $p6a992=count($n16234); $n16234[$p6a992]=$le4d23[0]; return HEL_SPECIAL_CHAR.hel_expand_index($p6a992).HEL_SPECIAL_CHAR; } function hel_restore_tags($p1cb25){ global $n16234; if ($n16234){ foreach ($n16234 as $p6a992 => $v2063c){ $p1cb25=str_replace(HEL_SPECIAL_CHAR. hel_expand_index($p6a992).HEL_SPECIAL_CHAR,$v2063c,$p1cb25); } } return $p1cb25; } function hel_kavychki($p1cb25){ global $n16234; if(HEL_ADVANCED_FORMATTING)$ff5613=hel_savetag(array (0 => "<span class=\"tsp\">&nbsp;</span>")); $hf2119=hel_savetag(array (0 => "<nobr>")); $f63637=hel_savetag(array (0 => "</nobr>")); $p1cb25=trim($p1cb25); $p1cb25=preg_replace_callback( "/(?:(?:\<(script|style|pre|code|tt|textarea|e2\:preserve)[^\>]*\>.*?\<\/\\1\>)". "|(?:\<\!\-\-.*?\-\-\>)|(?:\<[^\>]+\>)|(?:\&\#.*?;))+/isx", 'hel_savetag', $p1cb25 ); $p1cb25=str_replace('<br />',"<br />\n",$p1cb25); $p1cb25=preg_replace("/ {2,}/is",' ',$p1cb25); $p1cb25=preg_replace("/((^|\s|\&nbsp\;)". HEL_TAGS .")\\\"(?!". HEL_TAGS ."($|\&nbsp\;|\s))/m",'$1&laquo;',$p1cb25); $p1cb25=preg_replace("/(?<!^|\s|\&nbsp\;)(". HEL_TAGS ."\\\")(?=". HEL_TAGS ."($|\&nbsp\;|\s))/m",'$2&raquo;',$p1cb25); $rf5a8e=strlen('&laquo;'); $od3ecf=0; for ($m865c0=0; $m865c0 < strlen($p1cb25)-1; ++ $m865c0){ $u53aef=substr($p1cb25,$m865c0,$rf5a8e); if ($u53aef=='&laquo;'){ $od3ecf ++; if ($od3ecf > 1)$p1cb25=substr($p1cb25,0,$m865c0) .'&bdquo;'. substr($p1cb25,$m865c0+$rf5a8e); $m865c0+=$rf5a8e; } if ($u53aef=='&raquo;'){ if ($od3ecf > 1)$p1cb25=substr($p1cb25,0,$m865c0) .'&ldquo;'. substr($p1cb25,$m865c0+$rf5a8e); $od3ecf --; $m865c0+=$rf5a8e; } if ($m865c0 > strlen($p1cb25)-1) break; if ($p1cb25{$m865c0} == '"'){ if ($od3ecf > 0){ if ($od3ecf > 1) $p1cb25=substr($p1cb25,0,$m865c0) .'&ldquo;'. substr($p1cb25,$m865c0+1); else $p1cb25=substr($p1cb25,0,$m865c0) .'&raquo;'. substr($p1cb25,$m865c0+1); -- $od3ecf; } else { $p1cb25=substr($p1cb25,0,$m865c0) .'&laquo;'. substr($p1cb25,$m865c0+1); ++ $od3ecf; } } } if(HEL_CODEPAGE=='win-1251'){ $p1cb25=str_replace("\xab","&laquo;",$p1cb25); $p1cb25=str_replace("\xbb","&raquo;",$p1cb25); } if(HEL_CODEPAGE=='utf-8'){ } if(HEL_ADVANCED_FORMATTING){ $p1cb25=preg_replace( "/(?<=\d)(\%|\\$|\°C|\°F|\&deg\;C|\&deg\;F)/", $ff5613 ."$1", $p1cb25 ); $p1cb25=preg_replace( "/(\#|\№|\\$|\§|\&sect\;)(?=\d)/", "$1". $ff5613, $p1cb25 ); $p1cb25=preg_replace( "/(?<=[A-ZА-Я][a-zа-я])((\/|\+|\=|\–|\@|\&times\;|\&minus\;|\&ndash\;)+)(?=\w)/", $ff5613 ."$1". $ff5613, $p1cb25 ); } if(HEL_ADVANCED_FORMATTING){ $p1cb25=str_replace('и т.д.',$hf2119 .'и т.'. $ff5613 .'д.'. $f63637,$p1cb25); $p1cb25=str_replace('и т.п.',$hf2119 .'и т.'. $ff5613 .'п.'. $f63637,$p1cb25); $p1cb25=str_replace('т.к.',$hf2119 .'т.'. $ff5613 .'к.'. $f63637,$p1cb25); $p1cb25=str_replace('т.е.',$hf2119 .'т.'. $ff5613 .'е.'. $f63637,$p1cb25); $p1cb25=str_replace('т.о.',$hf2119 .'т.'. $ff5613 .'о.'. $f63637,$p1cb25); $p1cb25=str_replace('т.н.',$hf2119 .'т.'. $ff5613 .'н.'. $f63637,$p1cb25); $p1cb25=str_replace('Т.к.',$hf2119 .'Т.'. $ff5613 .'к.'. $f63637,$p1cb25); $p1cb25=str_replace('Т.е.',$hf2119 .'Т.'. $ff5613 .'е.'. $f63637,$p1cb25); $p1cb25=str_replace('Т.о.',$hf2119 .'Т.'. $ff5613 .'о.'. $f63637,$p1cb25); $p1cb25=str_replace('Т.н.',$hf2119 .'Т.'. $ff5613 .'н.'. $f63637,$p1cb25); $p1cb25=preg_replace( "/([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я][a-zа-я]+)/" . ((HEL_CODEPAGE=='utf-8')? "u":''), $hf2119 .'$1$2'. $ff5613 .'$3$4$5&nbsp;$6$7'. $f63637, $p1cb25 ); $p1cb25=preg_replace( "/([A-ZА-Я][a-zа-я]+)(". HEL_TAG .")? +(". HEL_TAG .")?([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я]\.)/" . ((HEL_CODEPAGE=='utf-8')? "u":''), $hf2119 .'$1$2&nbsp;$3$4$5'. $ff5613 .'$6$7'. $f63637, $p1cb25 ); } else { $p1cb25=str_replace('и т.д.',$hf2119 .'и т.&nbsp;д.'. $f63637,$p1cb25); $p1cb25=str_replace('и т.п.',$hf2119 .'и т.&nbsp;п.'. $f63637,$p1cb25); $p1cb25=str_replace('т.к.',$hf2119 .'т.&nbsp;к.'. $f63637,$p1cb25); $p1cb25=str_replace('т.е.',$hf2119 .'т.&nbsp;е.'. $f63637,$p1cb25); $p1cb25=str_replace('т.о.',$hf2119 .'т.&nbsp;о.'. $f63637,$p1cb25); $p1cb25=str_replace('т.н.',$hf2119 .'т.&nbsp;н.'. $f63637,$p1cb25); $p1cb25=str_replace('Т.к.',$hf2119 .'Т.&nbsp;к.'. $f63637,$p1cb25); $p1cb25=str_replace('Т.е.',$hf2119 .'Т.&nbsp;е.'. $f63637,$p1cb25); $p1cb25=str_replace('Т.о.',$hf2119 .'Т.&nbsp;о.'. $f63637,$p1cb25); $p1cb25=str_replace('Т.н.',$hf2119 .'Т.&nbsp;н.'. $f63637,$p1cb25); $p1cb25=preg_replace( "/([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я][a-zа-я]+)/" . ((HEL_CODEPAGE=='utf-8')? "u":''), $hf2119 .'$1$2&nbsp;$3$4$5&nbsp;$6$7'. $f63637, $p1cb25 ); $p1cb25=preg_replace( "/([A-ZА-Я][a-zа-я]+)(". HEL_TAG .")? +(". HEL_TAG .")?([A-ZА-Я]\.)(". HEL_TAG .")? *(". HEL_TAG .")?([A-ZА-Я]\.)/" . ((HEL_CODEPAGE=='utf-8')? "u":''), $hf2119 .'$1$2&nbsp;$3$4$5&nbsp;$6$7'. $f63637, $p1cb25 ); } $p1cb25=preg_replace("/(([A-ZА-Я][a-zа-я]+)\-([A-ZА-Я][a-zа-я]+))/" . ((HEL_CODEPAGE=='utf-8')? "u":''),$hf2119 .'$0'. $f63637,$p1cb25); $p1cb25=preg_replace( "/([^A-ZА-Я])". HEL_TAGS.HEL_GLUE_WORDS.HEL_TAGS."\s+". HEL_TAGS ."([A-ZА-Я]{3,})/is" . ((HEL_CODEPAGE=='utf-8')? "u":''), '$1$2$3$4&nbsp;$5$6', $p1cb25 ); $p1cb25=preg_replace("/(?<=\s)(\d+)\s+([A-ZА-Я]+)/". ((HEL_CODEPAGE=='utf-8')? "u":''),'\\1&nbsp;\\2',$p1cb25); $p1cb25=str_replace('(c)','&copy;',$p1cb25); $p1cb25=str_replace('(r)','&reg;',$p1cb25); $p1cb25=str_replace('(tm)','&trade;',$p1cb25); $p1cb25=str_replace('(C)','&copy;',$p1cb25); $p1cb25=str_replace('(R)','&reg;',$p1cb25); $p1cb25=str_replace('(TM)','&trade;',$p1cb25); $p1cb25=str_replace("'",'&rsquo;',$p1cb25); $p1cb25=str_replace('--&gt;','&rarr;',$p1cb25); $p1cb25=str_replace('&lt;--','&larr;',$p1cb25); $p1cb25=preg_replace('/( |\&nbsp\;)\-( |\&nbsp\;)/m','\\1&mdash;\\2',$p1cb25); $p1cb25=preg_replace('/^('. HEL_TAGS .')\- /m','$1&mdash; ',$p1cb25); $p1cb25=preg_replace('/ \-('. HEL_TAGS .')$/m','&nbsp;&mdash;$1',$p1cb25); $p1cb25=str_replace('–','&mdash;',$p1cb25); $p1cb25=str_replace(' &mdash;','&nbsp;&mdash;',$p1cb25); $p1cb25=str_replace('--','&mdash;',$p1cb25); $p1cb25=hel_restore_tags($p1cb25); $p1cb25=trim($p1cb25); return $p1cb25; } function u6f10($p1cb25){ return hel_kavychki($p1cb25); } function r154e($vf2ffc,$p1cb25,$e5c18e){ if ($vf2ffc=='calliope'){ return y5599($p1cb25,$e5c18e); } else { return $p1cb25; } } function ib7f1($p1cb25,$e5c18e){ global$_config; return r154e($_config['default_formatter'],$p1cb25,$e5c18e); } function y5599($p1cb25,$e5c18e){ global$_config,$kf97aa; @ (list ($e5c18e,$se8fab)=explode('|',$e5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$e5c18e)$iad910=WF_FULL_MODE; elseif ('simple'==$e5c18e)$iad910=WF_SIMPLE_MODE; else return $p1cb25; $e0a1d3=new WikiFormatter(); $e0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $e0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $kf97aa .'/'. PICTURES_FOLDER, 'mode' => $iad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $se8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); if (@$_config['link_redirect']) { $b1c55c=v4d36($kf97aa .'/'. trim($_config['link_redirect'],'/')); $e0a1d3 -> settings['extLinkHrefPrefix']=''; $e0a1d3 -> settings['linkredirValue']=$b1c55c .'?'; $e0a1d3 -> settings['ljUserTag'] = ( '<a href="http://livejournal.com/users/{name}/" linkredir="'. $b1c55c .'" >{name}</a>' ); } $p1cb25=$e0a1d3 -> Wiki2HTML($p1cb25); if($_config['autotypography']) { $p1cb25=u6f10($p1cb25); } return $p1cb25; } function e2m_timezone(){ global $n2e5d8; $ode2fd=array ( 'form-action' => f83c8('e2s_select_timezone'), 'submit-text' => 'Выбрать', 'timezone-selector' => e2_timezone_selector($n2e5d8['timezone']['offset'],1), 'dst?' => $n2e5d8['timezone']['is_dst'], ); return array ( 'title' => 'Часовой пояс по умолчанию', 'heading' => 'Часовой пояс по умолчанию', 'form' => 'form-timezone', 'form-timezone' => $ode2fd, ); } function e2_timezones(){ $u5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => '', -420 => '', -360 => '', -300 => '', -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => 'Время по Гринвичу', 60 => 'Центрально-европейское время', 120 => 'Восточно-европейское время', 180 => 'Московское время', 210 => '', 240 => '', 270 => '', 300 => 'Челябинское время', 330 => '', 345 => '', 360 => '', 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $u5cacd; } function e2_timezone_name_by_offset($a7a86c){ $u5cacd=e2_timezones(); return @$u5cacd[(int)$a7a86c/SECONDS_IN_A_MINUTE]; } function e2_format_timezone_offset($a7a86c){ $x04b29='+'; if ($a7a86c < 0)$x04b29='&ndash;'; $d73cdd=str_pad((int) (abs($a7a86c)/3600),2,'0',STR_PAD_LEFT); $e640fd=str_pad(abs($a7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $x04b29.$d73cdd .':'. $e640fd; } function e2_timezone_selector($b0743a,$o5784d=''){ $u5cacd=e2_timezones(); $s2cb9d=''; if (!$o5784d)$o5784d=count($u5cacd); $s2cb9d.='<select name="offset" size="'. $o5784d .'">'; foreach ($u5cacd as $a7a86c => $m83bce){ $cc03a8=''; if ($a7a86c*SECONDS_IN_A_MINUTE==$b0743a)$cc03a8=' selected="selected"'; $s2cb9d.='<option'. $cc03a8 .' value="'.$a7a86c.'">'; $d73cdd=(int) (abs($a7a86c*SECONDS_IN_A_MINUTE)/3600); $e640fd=(int) (abs($a7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($d73cdd)$s2cb9d.=$x04b29.$d73cdd .' ч '. ($e640fd? ($e640fd .' мин'):''); if ($a7a86c and $m83bce){ $s2cb9d .= ' ('. $m83bce. ')'; } elseif (!$a7a86c){ $s2cb9d .= 'нет'; } $s2cb9d.='</option>'; } $s2cb9d.='</select>'; return $s2cb9d; } function e2s_select_timezone(){ global $n2e5d8; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $n2e5d8['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $n2e5d8['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!k6e52(USER_FOLDER.'settings.psa',serialize($n2e5d8))) { d8a40('Не получается сохранить часовой пояс'); } e2_go_to(f83c8('e2m_settings')) and die (); } function e2_note_timezone($xaad65){ return array ( 'offset' => (int)$xaad65['Offset'], 'is_dst' => (bool)$xaad65['IsDST'], ); } function e2_no_timezone(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function e2_current_timezone(){ global $n2e5d8; return $n2e5d8['timezone']; } function e2_is_dst_in_timezone($yb2c6c,$odf491){ if (@$yb2c6c['is_dst']) { $f30481=(int)date('I',$odf491); $d6b7ea=date('Z',$odf491)-$f30481*SECONDS_IN_AN_HOUR; $w3e61a=$yb2c6c['offset']; $y178ae=$w3e61a-$d6b7ea; $t75b02=date('I',$odf491+$y178ae); return $t75b02; } else { return 0; } } function e2_timezone_gmt_offset_of_timezone($yb2c6c,$odf491){ global $n2e5d8; return ( $yb2c6c['offset'] + e2_is_dst_in_timezone($yb2c6c,$odf491)*SECONDS_IN_AN_HOUR ); } function e2_timezone_gmt_offset_of_current_timezone($odf491){ return e2_timezone_gmt_offset_of_timezone(e2_current_timezone(),$odf491); } function e2_format_dt_of_timezone($z1ddcb,$g4a202,$yb2c6c){ return gmdate($z1ddcb,$g4a202+e2_timezone_gmt_offset_of_timezone($yb2c6c,$g4a202)); } function e2_format_dt_of_current_timezone($z1ddcb,$g4a202){ return e2_format_dt_of_timezone($z1ddcb,$g4a202,e2_current_timezone()); } function e2_boundaries_in_gmt($p41529,$r6f8f5=false,$n8277e=false){ if(is_numeric($n8277e)) { $kea2b2=gmmktime(0,0,0,$r6f8f5,$n8277e,$p41529); $m7f021=gmmktime(0,0,0,$r6f8f5,$n8277e+1,$p41529)-1; } elseif(is_numeric($r6f8f5)) { $kea2b2=gmmktime(0,0,0,$r6f8f5,1,$p41529); $m7f021=gmmktime(0,0,0,$r6f8f5+1,1,$p41529)-1; } else { $kea2b2=gmmktime(0,0,0,1,1,$p41529); $m7f021=gmmktime(0,0,0,1,1,$p41529+1)-1; } return array ($kea2b2,$m7f021); } function e2_boundaries_in_timezone($yb2c6c,$p41529,$r6f8f5=false,$n8277e=false){ list ($kea2b2,$m7f021)=e2_boundaries_in_gmt($p41529,$r6f8f5,$n8277e); $kea2b2 -= e2_timezone_gmt_offset_of_timezone($yb2c6c,$kea2b2); $m7f021 -= e2_timezone_gmt_offset_of_timezone($yb2c6c,$m7f021); return array ($kea2b2,$m7f021); } function e2_boundaries_in_current_timezone($p41529,$r6f8f5=false,$n8277e=false){ return e2_boundaries_in_timezone(e2_current_timezone(),$p41529,$r6f8f5,$n8277e); } function e2_boundaries_worldwide($p41529,$r6f8f5=false,$n8277e=false){ $s32038=0; $dda4f0=0; $s32038=13; $dda4f0=-12; $s32038+=1; $dda4f0 -= 1; list ($kea2b2,$m7f021)=e2_boundaries_in_gmt($p41529,$r6f8f5,$n8277e); $kea2b2 -= $s32038*3600; $m7f021 -= $dda4f0*3600; return array ($kea2b2,$m7f021); } function e2_plusminus_gmt_offset($a7a86c){ if ((int) @$a7a86c > 0) return (string)'+'.abs(@$a7a86c); elseif ((int) @$a7a86c < 0) return (string)'-'.abs(@$a7a86c); else return ''; } function e2_timezone_gmt_offset_of_current_timezone_rfc2822($odf491){ $w2ab64=e2_timezone_gmt_offset_of_current_timezone($odf491); $x04b29=($w2ab64 >= 0)?'+':'-'; $w2ab64=abs($w2ab64); $a03c7c=$w2ab64 % 60; $w2ab64 -= $a03c7c; $r6f8f5=$w2ab64 % 3600/60; $w2ab64 -= $r6f8f5*60; $e2510c=$w2ab64/3600; if ($e2510c < 10)$e2510c='0'.$e2510c; if ($r6f8f5 < 10)$r6f8f5='0'.$r6f8f5; return $x04b29.$e2510c.$r6f8f5; } function e2_timezone_from_posted_offset($jaa759){ global $n2e5d8; if(is_numeric($jaa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$jaa759; $result['is_dst']=false; $qd8935=SECONDS_IN_A_MINUTE*$jaa759-SECONDS_IN_AN_HOUR; $fa6cfc=array ('offset' => $qd8935,'is_dst' => true); $fa6cfc=(int)e2_timezone_gmt_offset_of_timezone($fa6cfc,time()); if($result['offset']==$fa6cfc){ $result['offset']=$qd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$n2e5d8)) { $result=$n2e5d8['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function v692f($g96b8c){ $e2510c=e2_format_dt_of_current_timezone('H',$g96b8c); if ($e2510c <= 4) return 4; elseif ($e2510c <= 10) return 1; elseif ($e2510c <= 16) return 2; elseif ($e2510c <= 22) return 3; else return 4; } function e2_ru_ago($u0e524,$kb65f7=null){ $yb2c6c=e2_current_timezone(); $i97bc5=time(); $i0b375=v692f($i97bc5); $w3dfda=v692f($u0e524); $ldb42a=e2_format_dt_of_timezone('d.m.Y',$i97bc5,$yb2c6c); $f33284=e2_format_dt_of_timezone('d.m.Y',$u0e524,$yb2c6c); $g74459=$i97bc5-$u0e524; if ($g74459 < 0){ return 'Из будущего'; } if ($g74459 >= 0 and $g74459 < 5){ return 'Только что'; } if ($g74459 >= 5 and $g74459 < 25){ $u98bd1=$g74459 .' секунд'; if (($g74459 < 10) || ($g74459 >= 20)) { if (($g74459 % 10)==1)$u98bd1.='у'; if ((($g74459 % 10) >= 2) && (($g74459 % 10) <= 4))$u98bd1.='ы'; } } if ($g74459 >= 25 and $g74459 < 35){ $u98bd1='Полминуты'; } if ($g74459 >= 35 and $g74459 < 55){ $u98bd1='Меньше минуты'; } if ($g74459 >= 55 and $g74459 < 75){ $u98bd1='Минуту'; } if ($g74459 >= 75 and $g74459 < 105){ $u98bd1='Полторы минуты'; } if ($g74459 >= 105 and $g74459 < 25*SECONDS_IN_A_MINUTE){ $z7eccb=$g74459+20; $l7828e=floor($z7eccb/60); $u98bd1=$l7828e .' минут'; if (($l7828e < 10) || ($l7828e >= 20)) { if (($l7828e % 10)==1)$u98bd1.='у'; if ((($l7828e % 10) >= 2) && (($l7828e % 10) <= 4))$u98bd1.='ы'; } } if ($g74459 >= 25*SECONDS_IN_A_MINUTE and $g74459 < 35*SECONDS_IN_A_MINUTE){ $u98bd1='Полчаса'; } if ($g74459 >= 35*SECONDS_IN_A_MINUTE and $g74459 < 60*SECONDS_IN_A_MINUTE){ $u98bd1='Меньше часа'; } if ($g74459 >= 55*SECONDS_IN_A_MINUTE and $g74459 < 75*SECONDS_IN_A_MINUTE){ $u98bd1='Час'; } if ($g74459 >= 75*SECONDS_IN_A_MINUTE and $g74459 < 105*SECONDS_IN_A_MINUTE){ $u98bd1='Полтора часа'; } if ($g74459 >= 105*SECONDS_IN_A_MINUTE and $g74459 < 4*SECONDS_IN_AN_HOUR){ $z7eccb=$g74459+20*SECONDS_IN_A_MINUTE; $pfa816=floor($z7eccb/SECONDS_IN_AN_HOUR); $z7eccb=$z7eccb-$pfa816*SECONDS_IN_AN_HOUR; $u98bd1.=' '.$pfa816.' час'; if (($pfa816 < 10) || ($pfa816 >= 20)) { if ((($pfa816 % 10) >= 2) && (($pfa816 % 10) <= 4))$u98bd1.='а'; if ((($pfa816 % 10) >= 5) || (!($pfa816 % 10)))$u98bd1.='ов'; } else $u98bd1.='ов'; } if ($g74459 >= 4*SECONDS_IN_AN_HOUR and $i0b375 > $w3dfda and $ldb42a==$f33284){ return 'Сегодня в '. e2_format_dt_of_timezone('G:i',$u0e524,$yb2c6c); } if ($u98bd1!=''){ return ltrim($u98bd1). ' назад'; } else { return e2_format_dt_of_timezone('j',$u0e524,$kb65f7). ' '. e2_ru_month_genitive(e2_format_dt_of_timezone('m',$u0e524,$kb65f7)). ((($i97bc5-$u0e524) > YEAR_DISPLAY_THRESH)? (' '. e2_format_dt_of_timezone('Y',$u0e524,$kb65f7)) : ''). ', '. e2_format_dt_of_timezone('G:i',$u0e524,$kb65f7); } } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT( 1 ) DEFAULT '0' NOT NULL", '1' => "TINYINT( 1 ) DEFAULT '1' NOT NULL", 'v15' => "VARCHAR( 15 ) DEFAULT '' NOT NULL", 'v32' => "VARCHAR( 32 ) DEFAULT '' NOT NULL", 'fid' => "VARCHAR( 32 ) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR( 255 ) DEFAULT '' NOT NULL", 'text' => "TEXT DEFAULT '' NOT NULL", ); $_model=array ( 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('URLName', 'v32'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('IsPublished', '0'), array ('IsIssue', '0'), array ('IsCommentable', '1'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IP', 'v15'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified','time'), array ('IP', 'v15'), ), 'Keywords' => array ( array ('ID', 'key'), array ('ParentKeywordID', 'pkey'), array ('Keyword', 'v255'), array ('URLName', 'v32'), array ('Description', 'text'), array ('IsFavourite', '0'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), ); function yf1ac($raab9e){ global $n2e5d8,$_model,$_model_contractions; if(array_key_exists($raab9e,$_model)) { $e54ca8=array(); foreach($_model[$raab9e] as $v1afd3){ list ($qb0689,$y599dc)=$v1afd3; $e54ca8[] = "`". $qb0689 ."` ". $_model_contractions[$y599dc]; } $t1b1cc=( "CREATE TABLE `". $n2e5d8['db']['table_prefix'].$raab9e ."` ". "(". implode(" ,",$e54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=cp1251" ); if (t0738($t1b1cc)) return true; } } function n9943($raab9e,$nde17f){ global $n2e5d8; $ed05b6="`". implode("`, `",array_keys($nde17f)). "`"; $ef09cc="'". implode("', '",array_values($nde17f)). "'"; $t1b1cc=( "INSERT INTO `". $n2e5d8['db']['table_prefix'].$raab9e ."` ". "(".$ed05b6 .") VALUES (". $ef09cc .");" ); if (t0738($t1b1cc)) { $nde17f['ID']=mysql_insert_id(); return $nde17f; } } function baa79($raab9e,$nde17f,$z7692d=false){ global $n2e5d8; if(__LOG)__log('Model: update record, table <'. $raab9e .'>'); $w6a7f2=array(); foreach(e2model__soft_fields_for_table_($raab9e) as $h06e3d){ if(array_key_exists($h06e3d,$nde17f)) { $w6a7f2[] = '`'. $h06e3d .'`'."='". h7928($nde17f[$h06e3d]) ."'"; } } $vb5b39=array(); if(is_array($z7692d)) { foreach(e2model__soft_fields_for_table_($raab9e) as $h06e3d){ if(array_key_exists($h06e3d,$z7692d)) { $vb5b39[] = '`'. $h06e3d .'`'."='". h7928($z7692d[$h06e3d]) ."'"; } } } if(count($vb5b39)) { $h56790=implode(" AND ",$vb5b39); } else { if (!array_key_exists('ID',$nde17f) or !is_numeric($nde17f['ID'])) { die ('API MISUSE: e2_update_record must be called with an ID field in $record when updating single row'); } $h56790="`ID`=". $nde17f['ID']; } if(count($w6a7f2) > 0){ $t1b1cc=( "UPDATE `". $n2e5d8['db']['table_prefix'].$raab9e ."` ". "SET ". implode(', ',$w6a7f2) ." WHERE ". $h56790 ); if (t0738($t1b1cc)) return true; } } function e2model__soft_fields_for_table_($raab9e){ global$_model; $s2cb9d=array(); if(array_key_exists($raab9e,$_model)) { foreach($_model[$raab9e] as $h06e3d){ if (!in_array($h06e3d[1], array ('key'))) { $s2cb9d[] = $h06e3d[0]; } } } return $s2cb9d; } function e2m_install(){ global $n2e5d8; $s2cb9d=array(); if(e2_is_installed()) { d8a40('Движок уже установлен'); e2_go_to(''); } else { $s2cb9d['heading']='Новый блог'; $tc50d0='Установить движок и начать блог'; $md77d5['server'] = @$_COOKIE[w8c3b('install_db_server')]; $md77d5['user_name'] = @$_COOKIE[w8c3b('install_db_user_name')]; $md77d5['passw'] = @$_COOKIE[w8c3b('install_db_passw')]; $md77d5['name'] = @$_COOKIE[w8c3b('install_db_name')]; $md77d5['table_prefix'] = @$_COOKIE[w8c3b('install_db_table_prefix')]; $md77d5['exists'] = @$_COOKIE[w8c3b('install_db_exists')]; $s2cb9d['form-install'] = array ( 'form-action' => f83c8('e2s_install'), 'form-check-db-config-action' => f83c8('e2j_check_db_config'), 'form-list-databases-action' => f83c8('e2j_list_databases'), 'submit-text' => $tc50d0, 'db-server' => htmlspecialchars(@$md77d5['server']? $md77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$md77d5['user_name']? $md77d5['user_name']:'root'), 'db-password' => htmlspecialchars(DB_PASSWORD_RECOVER_AND_SHOW? (@$md77d5['passw']) : ''), 'db-database' => htmlspecialchars(@$md77d5['name']), 'db-prefix' => htmlspecialchars(@$md77d5['table_prefix']? $md77d5['table_prefix']:'e2Blog'), 'db-exists?' => (bool)$md77d5['exists'], ); $e444bc=true; $jb5d6c=array (USER_FOLDER,CACHES_FOLDER,PICTURES_FOLDER); $r90fec=array(); $l45a93=array(); foreach ($jb5d6c as $e45684){ @baf42($e45684); if(is_dir($e45684)) { if(false !== @vcd2d($pfa816=$e45684 .'installer-check.tmp','')) { @unlink($pfa816); } else { $l45a93[] = $e45684; } } else { $r90fec[] = $e45684; } } if(count($r90fec)==0 and count($l45a93)==0){ $s2cb9d['form-install']['installation-possible?']=true; } else { $s2cb9d['form-install']['installation-possible?']=false; $s2cb9d['message']='<p>Так, нужно кое-что поправить.</p>'; if(count($r90fec) > 0){ $s2cb9d['message'].='<p>Не найдены следующие папки из дистрибутива движка:<br />'; foreach ($r90fec as $b987dd){ $s2cb9d['message'].='&nbsp;&nbsp;&nbsp;<tt>'. $b987dd .'</tt>'; } $s2cb9d['message'].='</p>'; $s2cb9d['message'].='<p>Создать их автоматически не удалось из-за недостатка прав. Загрузите на сервер полный дистрибутив.</p>'; } if(count($l45a93) > 0){ $s2cb9d['message'].='<p>Дайте скриптам права на запись в папках:<br />'; foreach ($l45a93 as $t23ce6){ $s2cb9d['message'].='&nbsp;&nbsp;&nbsp;<tt>'. $t23ce6 .'</tt><br />'; } $s2cb9d['message'].='</p>'; } $s2cb9d['message'].='<p>И перезагрузите установщик.</p>'; } } return $s2cb9d; } function e2_instantiate($m2af72){ global$_instance; $_instance['version']=$m2af72; k6e52(USER_FOLDER. '/instance.psa',serialize($_instance)); return true; } function e2s_instantiate($parameters){ if(e2_is_installed()) { d8a40('Сначала удалите <tt>'. USER_FOLDER .'instance.psa</tt>'); e2_go_to(f83c8('e2m_frontpage')); die; } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { d8a40('Инстанциирована версия v'. $parameters['version']); e2_go_to(f83c8('e2m_frontpage')); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global $n2e5d8,$_instance; if(e2_is_installed()) { e2_go_to(f83c8('e2m_install')); die; } else { e2_drop_all_kinds_of_cache(); $md77d5['server'] = @$_POST['db-server']; $md77d5['user_name'] = @$_POST['db-user']; $md77d5['passw'] = @$_POST['db-password']; $md77d5['name'] = @$_POST['db-database']; $md77d5['table_prefix'] = @$_POST['db-prefix']; $md77d5['exists'] = isset ($_POST['db-exists']); $yb2c6c=e2_timezone_from_posted_offset(@$_POST['gmt-offset']); foreach ($md77d5 as $f8ce4b => $x9e366){ gc64a('install_db_' .$f8ce4b,$x9e366); } @session_start(); if (!array_key_exists('password',$_POST) or $_POST['password']==''){ d8a40('Вы не ввели пароль'); } if (!u4193()) { $e444bc=true; $e88162=trim($_POST['password']); $s2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => de8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); if (!g1d21($s2d6d8)) { $e444bc=false; } if (!@k6e52(USER_FOLDER.'password-hash.psa',serialize(j4c49($e88162)))) { $e444bc=false; } if (!$md77d5['exists']) { $n2e5d8=array(); } $n2e5d8['db']=$md77d5; $n2e5d8['timezone']=$yb2c6c; if (!@k6e52(USER_FOLDER.'settings.psa',serialize($n2e5d8))) { $e444bc=false; } if (!$e444bc){ d8a40('Возникли проблемы при записи файлов, возможно недостаточно прав доступа'); } else { if ($md77d5['exists']) { if(__LOG)__log('Installer: No need to create DB'); $sba46b=u0f7c(); if (!$sba46b){ if(__LOG)__log('Installer: DB not OK'); d8a40('Перепроверьте реквизиты базы'); } } else { if(__LOG)__log('Installer: Creating DB...'); $sba46b=( yf1ac('Notes') and yf1ac('Comments') and yf1ac('Keywords') and yf1ac('NotesKeywords') ); if (!$sba46b){ if(__LOG)__log('Installer: DB not OK'); d8a40('Ошибка при создании таблиц в базе данных. Перепроверьте реквизиты базы'); } } if ($sba46b){ if(__LOG)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(__LOG)__log('Installer: Done'); if (!$md77d5['exists']) { if(__LOG)__log('Installer: Adding indexes...'); t0738( "ALTER TABLE `". $n2e5d8['db']['table_prefix']."Notes` ". "ADD FULLTEXT (`Title`, `Text`)" ); t0738( "ALTER TABLE `". $n2e5d8['db']['table_prefix']."NotesKeywords` ". "ADD INDEX (`NoteID`)" ); if(__LOG)__log('Installer: Done'); } if(__LOG)__log('Installer: Complete'); e2_go_to(); die; } } } if (u4193()) { e2_go_to(f83c8('e2m_install')); die; } } } function e2_is_installed(){ global$_instance; return (bool)$_instance; } function e2_make_sure_that_installed(){ global $p57de2,$ra57c1,$_instance; if(__LOG)__log('Installer: making sure that engine is installed'); if(e2_is_installed()) { if(__LOG)__log('Installer: done'); if(E2_VERSION < $_instance ['version']) { header('HTTP/1.1 503 Service Unavailable'); die ('<big style="background: #a00; color: #ccc; padding: .1em .33em">DOWNDATE</big>'); } elseif(E2_VERSION > $_instance ['version']) { header('Location: http://'. $p57de2.$ra57c1 .'/perform_update/'); header('Location: '. f83c8('e2s_update_perform')); die; } else { return; } } $e601f0=f83c8('e2m_install'); if(__LOG)__log('Installer: not yet, will need to install, going to '. $e601f0); e2_go_to($e601f0); die; } function e2_dbserver_usable_databases($dcf1e8,$qee11c,$a5f4dc){ $n32e95=array(); if (($h2a304=mysql_connect($dcf1e8,$qee11c,$a5f4dc)) !== false){ $ee61ce=mysql_list_dbs($h2a304); while ($jf1965=mysql_fetch_row($ee61ce)) { if ( mysql_select_db($jf1965[0],$h2a304) and !in_array($jf1965[0], array ('information_schema','mysql')) ) { $n32e95[] = $jf1965[0]; } } } return $n32e95; } function e2j_check_db_config(){ $y0b2a6=array ( 'Notes', 'Keywords', 'NotesKeywords', 'Comments', ); $dcf1e8=$qee11c=$a5f4dc=$y11e0e=$w851f5=''; if(array_key_exists('server',$_POST)) $dcf1e8= $_POST['server']; if(array_key_exists('user',$_POST)) $qee11c= $_POST['user']; if(array_key_exists('password',$_POST))$a5f4dc=$_POST['password']; if(array_key_exists('database',$_POST))$y11e0e=$_POST['database']; if(array_key_exists('prefix',$_POST)) $w851f5= $_POST['prefix']; $ce0879=(bool) ($_POST['exists']=='true'); ini_set('mysql.connect_timeout',1); if (($d098f6=mysql_connect($dcf1e8,$qee11c,$a5f4dc)) === false){ if (($d098f6=mysql_connect($dcf1e8)) === false){ die ('no-connect'); } else { die ('server-responding'); } } else { if (!$y11e0e){ $n32e95=e2_dbserver_usable_databases($dcf1e8,$qee11c,$a5f4dc); $y11e0e=$n32e95[0]; } if(mysql_select_db($y11e0e,$d098f6)===false){ die ('server-lets-in'); } else { $y08cfc=false; $k35f9b=array(); $wac5c7='SHOW TABLES FROM `'. mysql_escape_string($y11e0e). '`'; $result=mysql_query($wac5c7,$d098f6); if($result){ while ($jf1965=mysql_fetch_row($result)) { foreach ($y0b2a6 as $sd2ffa){ if(strcasecmp($jf1965[0],$w851f5.$sd2ffa)===0){ $y08cfc=true; $k35f9b[] = $sd2ffa; } } } } $r6cfe6=true; foreach ($y0b2a6 as $sd2ffa){ if (!in_array($sd2ffa,$k35f9b)) { $r6cfe6=false; } } if (!$ce0879 and $y08cfc){ die ('prefix-occupied'); } if ($ce0879 and !$y08cfc){ die ('prefix-not-found'); } die ('bingo'); } } } function e2j_list_databases(){ $dcf1e8=$qee11c=$a5f4dc=''; if(array_key_exists('server',$_POST)) $dcf1e8= $_POST['server']; if(array_key_exists('user',$_POST)) $qee11c= $_POST['user']; if(array_key_exists('password',$_POST))$a5f4dc=$_POST['password']; $n32e95=e2_dbserver_usable_databases($dcf1e8,$qee11c,$a5f4dc); if ($n32e95) die (implode('|',$n32e95)); die; } function e2m_update(){ global $n2e5d8,$_config,$_update_status; $b71860=''; $s2cb9d['update-page']['check-updates-action']=f83c8('e2j_check_updates'); $s2cb9d['update-page']['describe-updates-action']=f83c8('e2j_describe_updates'); $s2cb9d['update-page']['download-href']=$_config['update_server']; $s2cb9d['heading']='Обновление движка'; $s2cb9d['title']='Обновление движка'; return $s2cb9d; } function e2m_update_install(){ global $n2e5d8,$_config,$kf97aa,$stopwatch; $s2cb9d['body']=''; $s2cb9d['heading']='Установка обновления'; $s2cb9d['title']='Установка обновления'; $b71860=''; if (qe852()) { ignore_user_abort(1); $wd0525=xdcc1(); if(is_array($wd0525)) { $nbcc58=E2_WEBSITE. 'download/updates'; if (isset ($_config['download_server'])) $nbcc58='http://'.$_config['download_server']; $g45b96=array(); foreach ($wd0525 as $o7b774){ if (@$o7b774['files']) { foreach(explode(';',$o7b774['files']) as $c8c7dd) if (@trim($c8c7dd)) $g45b96[] = (trim($c8c7dd)=='core')?'system/core.php':trim($c8c7dd); } else { $g45b96[] = 'system/core.php'; } } $g45b96=array_unique($g45b96); $b71860.='<ul>'; foreach ($g45b96 as $c8c7dd){ if ($k6c922[$c8c7dd] = @ocdf0($nbcc58.'/'.$c8c7dd)) { $b71860.='<li><tt>'.$c8c7dd.'</tt> скачан успешно</li>'; } else { $j435ed=$c8c7dd; $fe1118=1; break; } } $b71860.='</ul>'; if (@$fe1118){ $b71860.='<p>Не удалось скачать файл <tt>'.$j435ed.'</tt>. Обновление отменяется.</p>'; } else { $b71860.='<p>Скачаны все необходимые файлы.</p>'; $l04c18=e7f78()-$stopwatch; $o655f1=ini_get('max_execution_time'); if ($o655f1==''){ $o655f1=30; } $vec527=$o655f1-$l04c18; if ($vec527 < 5){ $b71860.='<p>Скрипту осталось выполняться меньше 5 секунд ('.$vec527.'), на всякий случай обновление отменяется. Попробуйте ещё раз.</p>'; } else { $e444bc=1; foreach ($g45b96 as $c8c7dd){ if (baf42(substr($c8c7dd,0,strrpos($c8c7dd,'/')))) { $e444bc=$e444bc and k6e52($c8c7dd,$k6c922[$c8c7dd]); } } if (@$e444bc){ $b71860 .= ( '<p>Старые файлы заменены новыми. <a href="'. f83c8('e2s_update_perform'). '">Продолжить обновление</a></p>' ); } else { $b71860.='<p>Произошли какие-то проблемы при замене старых файлов новыми.</p>'; } } } } else { if ($wd0525===false){ $b71860.='<p>Сервер обновлений недоступен.</p>'; } } $s2cb9d['body']=$b71860; } return $s2cb9d; } function e2s_update_perform(){ global$_instance,$n2e5d8; $dd98a0=max((int) ($_instance['version']), 1634); if($_instance['version']==E2_VERSION){ d8a40('Обновление уже выполнено'); f4930(); die; } if ($dd98a0 < 1674){ if (@$n2e5d8['appearance']['most_commented_frontpage']) { $n2e5d8['appearance']['hot_on_frontpage_period']='month'; } else { $n2e5d8['appearance']['hot_on_frontpage_period']='none'; } if (isset ($n2e5d8['appearance']['most_commented_frontpage'])) unset ($n2e5d8['appearance']['most_commented_frontpage']); } if ($dd98a0 < 1696){ if (isset ($n2e5d8['write']['is_visible_def'])) unset ($n2e5d8['write']['is_visible_def']); } if ($dd98a0 < 1717){ if (isset ($n2e5d8['appearance']['iconize_extlink'])) unset ($n2e5d8['appearance']['iconize_extlink']); if (isset ($n2e5d8['appearance']['iconize_email'])) unset ($n2e5d8['appearance']['iconize_email']); if (isset ($n2e5d8['appearance']['iconize_ljuser'])) unset ($n2e5d8['appearance']['iconize_ljuser']); } if ($dd98a0 < 1739){ if (isset ($n2e5d8['notifications']['new_comment_mail_subject'])) unset ($n2e5d8['notifications']['new_comment_mail_subject']); if (isset ($n2e5d8['notifications']['comment_reply_mail_subject'])) unset ($n2e5d8['notifications']['comment_reply_mail_subject']); } if ($dd98a0 < 1759){ t0738("DROP TABLE IF EXISTS `". $n2e5d8['db']['table_prefix']."TrackBacks`"); if (isset ($n2e5d8['appearance']['separators'])) unset ($n2e5d8['appearance']['separators']); if (isset ($n2e5d8['appearance']['image_size'])) unset ($n2e5d8['appearance']['image_size']); if (isset ($n2e5d8['appearance']['latest_note_title'])) unset ($n2e5d8['appearance']['latest_note_title']); if (isset ($n2e5d8['appearance']['most_commented_frontpage'])) unset ($n2e5d8['appearance']['most_commented_frontpage']); if (isset ($n2e5d8['appearance']['thumb_size'])) unset ($n2e5d8['appearance']['thumb_size']); if (isset ($n2e5d8['appearance']['doubleclick_edit'])) unset ($n2e5d8['appearance']['doubleclick_edit']); if (isset ($n2e5d8['appearance']['num_titles_on_frontpage'])) unset ($n2e5d8['appearance']['num_titles_on_frontpage']); if (isset ($n2e5d8['write']['trackback'])) unset ($n2e5d8['write']['trackback']); if (isset ($n2e5d8['write']['is_visible_def'])) unset ($n2e5d8['write']['is_visible_def']); if (isset ($n2e5d8['write']['is_commentable_def'])) unset ($n2e5d8['write']['is_commentable_def']); if (isset ($n2e5d8['comments']['in_rss'])) unset ($n2e5d8['comments']['in_rss']); if (isset ($n2e5d8['comments']['accept_trackback'])) unset ($n2e5d8['comments']['accept_trackback']); if (isset ($n2e5d8['notifications']['let_subscribe'])) unset ($n2e5d8['notifications']['let_subscribe']); if (isset ($n2e5d8['notifications']['new_comment_mail_subject'])) unset ($n2e5d8['notifications']['new_comment_mail_subject']); if (isset ($n2e5d8['notifications']['comment_reply_mail_subject'])) unset ($n2e5d8['notifications']['comment_reply_mail_subject']); if (isset ($n2e5d8['security']['login_mode'])) unset ($n2e5d8['security']['login_mode']); if (isset ($n2e5d8['security']['max_comment_length'])) unset ($n2e5d8['security']['max_comment_length']); if (isset ($n2e5d8['keywords']['keywords_frontpage'])) unset ($n2e5d8['keywords']['keywords_frontpage']); if (isset ($n2e5d8['nowplayin'])) unset ($n2e5d8['nowplayin']); if (isset ($n2e5d8['trackback'])) unset ($n2e5d8['trackback']); if (isset ($n2e5d8['stdl'])) unset ($n2e5d8['stdl']); if (isset ($n2e5d8['cp'])) unset ($n2e5d8['cp']); @unlink('stdl.psa'); } if ($dd98a0 < 1760){ if (isset ($n2e5d8['cache'])) unset ($n2e5d8['cache']); if (isset ($n2e5d8['debug'])) unset ($n2e5d8['debug']); } if ($dd98a0 < 1761){ } if ($dd98a0 < 1763){ if (isset ($n2e5d8['keywords']['whole_family'])) unset ($n2e5d8['keywords']['whole_family']); } if ($dd98a0 < 1765){ if (isset ($n2e5d8['settings']['spesta'])) unset ($n2e5d8['settings']['spesta']); } if ($dd98a0 < 1767){ if (isset ($n2e5d8['keywords']['write_iface'])) unset ($n2e5d8['keywords']['write_iface']); } if ($dd98a0 < 1770){ if (isset ($n2e5d8['appearance']['def_cut'])) unset ($n2e5d8['appearance']['def_cut']); } if ($dd98a0 < 1770){ if (isset ($n2e5d8['appearance']['def_cut'])) unset ($n2e5d8['appearance']['def_cut']); } if ($dd98a0 < 1788){ if (isset ($n2e5d8['keywords']['sort_by'])) unset ($n2e5d8['keywords']['sort_by']); } if ($dd98a0 < 1807){ if (isset ($n2e5d8['appearance']['calendar_frontpage'])) unset ($n2e5d8['appearance']['calendar_frontpage']); } if ($dd98a0 < 1808){ if (isset ($n2e5d8['keywords']['on'])) unset ($n2e5d8['keywords']['on']); if (isset ($n2e5d8['keywords']['in_rss'])) unset ($n2e5d8['keywords']['in_rss']); } if ($dd98a0 < 1846){ if (isset ($n2e5d8['keywords']['display_mode'])) unset ($n2e5d8['keywords']['display_mode']); } if ($dd98a0 < 1873){ if (isset ($n2e5d8['security']['login_interface'])) unset ($n2e5d8['security']['login_interface']); } if ($dd98a0 < 2028){ if (isset ($n2e5d8['comments']['ability_period']) and is_numeric($n2e5d8['comments']['ability_period'])) { unset ($n2e5d8['comments']['ability_period']); } if (isset ($n2e5d8['settings_shortcuts'])) unset ($n2e5d8['settings_shortcuts']); if (isset ($n2e5d8['func'])) unset ($n2e5d8['func']); if (isset ($n2e5d8['write'])) unset ($n2e5d8['write']); if (isset ($n2e5d8['appearance']['prevnext_order'])) unset ($n2e5d8['appearance']['prevnext_order']); if (isset ($n2e5d8['appearance']['one_line_calendar'])) unset ($n2e5d8['appearance']['one_line_calendar']); } if ($dd98a0 < 2030){ if (isset ($n2e5d8['appearance']['rss_items'])) unset ($n2e5d8['appearance']['rss_items']); } if ($dd98a0 < 2037){ if (isset ($n2e5d8['user']['pasha'])) { k6e52(USER_FOLDER. '/password-hash.psa',serialize($n2e5d8['user']['pasha'])); unset ($n2e5d8['user']['pasha']); } e2_instantiate(2037); } if ($dd98a0 < 2046){ t0738( "ALTER TABLE `". $n2e5d8['db']['table_prefix']."Comments` ". "ADD `IsSpamSuspect` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsSubscriber`" ); e2_drop_all_kinds_of_cache(); e2_instantiate(2046); } if ($dd98a0 < 2104){ t0738( "ALTER TABLE `". $n2e5d8['db']['table_prefix']."Comments` ". "ADD `IsNew` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsSpamSuspect`" ); e2_drop_all_kinds_of_cache(); e2_instantiate(2104); } if ($dd98a0 < 2210){ if (isset ($n2e5d8['appearance']['kavychki'])) unset ($n2e5d8['appearance']['kavychki']); } if ($dd98a0 < 2344){ @unlink(USER_FOLDER. 'last-update.psa'); e2_instantiate(2344); } if ($dd98a0 < 2411){ t0738( "ALTER TABLE `". $n2e5d8['db']['table_prefix']."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); e2_drop_all_kinds_of_cache(); e2_instantiate(2411); } if ($dd98a0 < 2425){ t0738( "ALTER TABLE `". $n2e5d8['db']['table_prefix']."Notes` ". "CHANGE `URLName` `URLName` VARCHAR( 32 ) DEFAULT '' NOT NULL" ); e2_drop_all_kinds_of_cache(); e2_instantiate(2425); } @k6e52(USER_FOLDER.'settings.psa',serialize($n2e5d8)); e2_instantiate(E2_VERSION); $pcaf9b['last-check']=time(); @k6e52(USER_FOLDER.'update-info.psa',serialize($pcaf9b)); d8a40('Выполнено обновление с версии v'. $dd98a0 .' до версии v'. $_instance['version']); e2_go_to(); die; } function e2_check_updates(){ global$_config,$_update_info; if (@$_update_info){ $pcaf9b=$_update_info; } else { $pcaf9b=@unserialize(ocdf0(USER_FOLDER. '/update-info.psa')); } $i3ef9a=$_config['update_server'].E2_VERSION; if(__LOG)__log('Update check: UA IS '. $_SERVER['HTTP_USER_AGENT']); if(__LOG)__log('Update check: address is '. $i3ef9a.'/status/'); $pcaf9b['last-check']=time(); $db4582=false; if ($s9acb4=@ocdf0($i3ef9a.'/status/')) { if(__LOG)__log('Update check: read successful'); $pcaf9b['status']=unserialize($s9acb4); if ($pcaf9b['status']['available?']) { $db4582=true; } } else { if(__LOG)__log('Update check: read unsuccessful'); $pcaf9b['status'] = array (); } if ($db4582 and DOWNLOAD_UPDATES){ $ff6f37=$pcaf9b['status']['version-to-download']; if ($pcaf9b['version-downloaded']==$ff6f37){ if(__LOG)__log('Update check: latest version already downloaded, '. $pcaf9b['version-downloaded']); } else { $pcaf9b['client-hash']=''; unset ($pcaf9b['version-downloaded']); $pcaf9b['version-downloaded-partially']=$ff6f37; @k6e52(USER_FOLDER.'update-info.psa',serialize($pcaf9b)); $c0861a=true; if(__LOG)__log('Update check: we should update to version '. $ff6f37); $c0800f=''; if ($x14451=@ocdf0($i3ef9a.'/file-list/')) { if(trim($x14451)) { $g45b96=explode("\n",$x14451); if(__LOG)__log('Update check: downloading '. count($g45b96). ' files'); foreach ($g45b96 as $c8c7dd){ $b572d4=$pcaf9b['status']['download-from'].$c8c7dd; if (($u39b01=@file_get_contents($b572d4)) !== false){ $zd2324=$c8c7dd; $zd2324=str_replace('/','---',$zd2324); $c0800f.=md5($u39b01); } else { if(__LOG)__log('Update check: file not found '. $b572d4); } } } } $c0800f=md5($c0800f); $pcaf9b['client-hash']=$c0800f; if ($pcaf9b['client-hash']!=$pcaf9b['status']['server-hash']) { $c0861a=true; } if (!$c0861a){ unset ($pcaf9b['version-downloaded-partially']); unset ($pcaf9b['client-hash']); $pcaf9b['version-downloaded']=$ff6f37; } } } else { unset ($pcaf9b['version-downloaded-partially']); unset ($pcaf9b['version-downloaded']); unset ($pcaf9b['client-hash']); } k6e52(USER_FOLDER.'update-info.psa',serialize($pcaf9b)); return $pcaf9b; } function e2s_check_updates(){ $pcaf9b=e2_check_updates(); echo '<pre>'; print_r($pcaf9b); echo '</pre>'; if(__LOG)__log('Update check: finished'); die; } function e2j_check_updates(){ $pcaf9b=e2_check_updates(); if(DOWNLOAD_UPDATES and array_key_exists('version-downloaded',$pcaf9b)) { die ('ready|'. $pcaf9b['version-downloaded']); } elseif (@$pcaf9b['status']['available?']) { die ('ready|'. $pcaf9b['status']['version-to-download']); } else { die ('no-updates'); } die; } function e2j_describe_updates(){ global$_config; $b71860=file_get_contents($_config['update_server'].E2_VERSION .'/'); $b71860=wedd9($b71860,true); die ($b71860); } function u0f7c(){ global $n2e5d8,$c3afe6,$_db_error; if (@$c3afe6['connected']!==true){ if ( ( $c3afe6['link'] = @mysql_connect( $n2e5d8['db']['server'],$n2e5d8['db']['user_name'],$n2e5d8['db']['passw'] ) ) !== false ){ if(mysql_select_db($n2e5d8['db']['name'])) { $c3afe6['connected']=true; return true; } else { $_db_error=DB_CANNOT_FIND; return false; } } else { $_db_error=DB_CANNOT_CONNECT; return false; } } else { return true; } } function t0738($d7694f,$e8e815='cp1251'){ global $u11755,$c3afe6,$_db_error,$n2e5d8; if(__LOG)__log('DB: query <'. $d7694f .'>'); $q9b54f=e7f78(); @$u11755 ++; if (u0f7c()) { if ( version_compare(mysql_get_server_info(),'4.1','>=') and @$c3afe6['latest_setnames']!=$e8e815 ){ mysql_query("SET NAMES ". $e8e815); $c3afe6['latest_setnames']=$e8e815; } if ($c3afe6['result']=mysql_query($d7694f,$c3afe6['link'])) { if(__LOG)__log('DB: done in '. round(e7f78()-$q9b54f,3)); return true; } else { d8a40('Ошибка при запросе: <br /><code>'.nl2br($d7694f).'</code><br /><br />'. 'mySQL said: <i>'.mysql_error().'</i><br />'); return false; } } else { if($_db_error==DB_CANNOT_FIND){ if(__LOG)__log('DB: cannot find db'); d8a40('Не удаётся найти базу данных'); } elseif($_db_error==DB_CANNOT_CONNECT){ if(__LOG)__log('DB: cannot connect to db'); d8a40('Нет соединения с базой данных'); } else { if(__LOG)__log('DB: db error '. $_db_error); d8a40('Произошла ошибка ('. $_db_error .')'); } return false; } } function t0d6b($y599dc=MYSQL_ASSOC){ global $c3afe6; $s2cb9d=array(); while ($l0cc17=@mysql_fetch_array($c3afe6['result'],$y599dc)) { foreach ($l0cc17 as $m865c0 => $f4921c){ if(is_string($f4921c)) { $l0cc17[$m865c0]=$f4921c; } } $s2cb9d[] = $l0cc17; } return $s2cb9d; } function h7928($mb45cf){ return mysql_escape_string($mb45cf); } function e2m_note($parameters=array ()) { global $n2e5d8,$p57de2,$v5c4a6,$_config; if(__LOG)__log('Note: working...'); $xaad65=e2_published_noterec_with_parameters_($parameters); $w229c3=$parameters['day-number']; while (1){ if ( $xaad65==false or !($xaad65['IsVisible'] or qe852()) ) { if ($w229c3 > 1){ -- $w229c3; $xaad65=pa90d($parameters['day'],$parameters['month'],$parameters['year'],$w229c3); continue; } return e2_error404_mode(); } else { break; } } if ($w229c3!=$parameters['day-number']) { $parameters['day-number']=$w229c3; e2_go_to(f83c8('e2m_note',$parameters)); } $td58c0=f83c8('e2m_note', array ('*note' => $xaad65)); y3010( 'Комментарии к этой заметке', f83c8('e2m_note_comments_rss',$parameters) ); if(__LOG)__log('Note: navigation...'); $rfcb08=ncca7($xaad65,'prev'); $hd0cab=ncca7($xaad65,'next'); if ($rfcb08){ $vb3b32['prev-href']=f83c8('e2m_note', array ('*note' => $rfcb08)); $vb3b32['prev-title']='<a>'. u6f10(htmlspecialchars(oea9c($rfcb08),ENT_NOQUOTES)) .'</a>'; $v5c4a6['navigation_links']['prev']=$vb3b32['prev-href']; } if ($hd0cab){ $vb3b32['next-href']=f83c8('e2m_note', array ('*note' => $hd0cab)); $vb3b32['next-title']='<a>'. u6f10(htmlspecialchars(oea9c($hd0cab),ENT_NOQUOTES)) .'</a>'; $v5c4a6['navigation_links']['next']=$vb3b32['next-href']; } $vb3b32['numbered']=false; $vb3b32['title']='Заметки'; $vb3b32['this-title']=u6f10(htmlspecialchars(oea9c($xaad65),ENT_NOQUOTES)); $v5c4a6['navigation_links']['up']=f83c8('e2m_day',$parameters); if(__LOG)__log('Note: packaging...'); $xaad65['_']['_id']=$xaad65['ID']; $xaad65['_']['_ord']=0; $xaad65['_']['_ord_max']=0; $u8e4cd=r6791($xaad65); $ye35b1=''; $h01a5b=''; $v33ff2=false; $n905f7=false; $p7bae4=''; $zd09b4=''; if (@$n2e5d8['comments']['on']) { $f83625=e2_note_cache_filename_with_id_($xaad65['_']['_id'] .'-comments'); $v1e8cc=null; if(CACHE_NOTES_COMMENTS and !qe852() and is_file($f83625)) { $v1e8cc=@unserialize(ocdf0($f83625)); } if(__LOG)__log('Note: comments...'); if(is_array($v1e8cc)) { if(__LOG)__log('Note: retrieve cached ctree'); $ye35b1=$v1e8cc; } else { if(__LOG)__log('Note: assemble ctree...'); $bc1fdc=b1baf($xaad65['ID'],"ORDER BY `Stamp`"); $ia5d49=array(); $t04c25=true; foreach ($bc1fdc as $f8ce4b => $w4032b){ if ($w4032b['IsVisible']) { $w4032b['_']['_id']=$w4032b['ID']; $w4032b['_']['_ord']=$f8ce4b; $w4032b['_']['_ord_max']=count($bc1fdc)-1; $i06d4c=g86f8( $xaad65, $w4032b, $f8ce4b+1 ); if ($i06d4c['new?'] and $t04c25){ $i06d4c['first-new?']=true; $t04c25=false; } $ia5d49[] = $i06d4c; } } $ye35b1=$ia5d49; if(CACHE_NOTES_COMMENTS and !qe852())k6e52($f83625,serialize($ye35b1)); } $h01a5b=f83c8('e2m_note_comments_rss', array ('*note' => $xaad65)); if ($u8e4cd['commentable-now?']) { $n80f02=y66aa($xaad65); } if (qe852() and ub387($xaad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($xaad65['IsCommentable']) { $p7bae4['href']=f83c8('e2m_note_flag', array ( '*note' => $xaad65, 'flag' => 'IsCommentable', 'value' => 0, )); $p7bae4['text']='Закрыть комментарии к заметке'; } else { $p7bae4['href']=f83c8('e2m_note_flag', array ( '*note' => $xaad65, 'flag' => 'IsCommentable', 'value' => 1, )); $p7bae4['text']='Открыть комментарии к заметке'; } } } if ( qe852() and array_key_exists('new-comments-count',$u8e4cd) and $u8e4cd['new-comments-count'] ) { if(__LOG)__log('Note: mark comments as not new'); e2_drop_caches_for_note_($s21158); baa79('Comments', array ('IsNew' => 0), array ('NoteID' => $xaad65['_']['_id'])); } if(__LOG)__log('Note: more work...'); $se70c4['class']='note'; $se70c4['title']=oea9c($xaad65); $se70c4['pages']=$vb3b32; $se70c4['notes'] = array ('only' => $u8e4cd); if ($ye35b1) $se70c4['comments']=$ye35b1; if ($h01a5b) $se70c4['comments-rss-href']=$h01a5b; if ($p7bae4) $se70c4['comments-toggle']=$p7bae4; if ($n80f02) $se70c4['form-comment']=$n80f02; if(__LOG)__log('Note: done'); return $se70c4; } function e2m_note_finetune($parameters=array ()) { global $n2e5d8; $xaad65=e2_published_noterec_with_parameters_($parameters); if ($xaad65===false) return e2_error404_mode(); $s2cb9d['title']=$s2cb9d['heading']='Время публикации заметки'; $s2cb9d['form']='form-note-finetune'; $s2cb9d['form-note-finetune'] = array ( '.note-id' => $xaad65['ID'], 'edit-href' => f83c8('e2m_note_edit', array ('*note' => $xaad65)), 'form-action' => f83c8('e2s_note_finetune'), 'submit-text' => 'Применить', 'timezone-selector' => e2_timezone_selector($xaad65['Offset'],1), 'default-timezone-href' => f83c8('e2m_timezone'), 'dst-checked?' => $xaad65['IsDST']? 'checked="checked"':'', 'stamp-formatted' => e2_format_dt_of_timezone('d.m.Y H:i:s',$xaad65['Stamp'],e2_note_timezone($xaad65)), 'lastmodified-formatted' => e2_format_dt_of_timezone('d.m.Y H:i:s',$xaad65['LastModified'],e2_note_timezone($xaad65)), ); return $s2cb9d; } function e2m_note_withdraw($parameters=array ()) { global $n2e5d8; $xaad65=e2_published_noterec_with_parameters_($parameters); if ($xaad65===false) return e2_error404_mode(); $s2cb9d['title']=$s2cb9d['heading']='Отзыв заметки'; $s2cb9d['form']='form-note-withdraw'; $s2cb9d['form-note-withdraw'] = array ( '.note-id' => $xaad65['ID'], 'form-action' => f83c8('e2s_note_withdraw'), 'note-title' => u6f10(htmlspecialchars(oea9c($xaad65),ENT_NOQUOTES)), ); return $s2cb9d; } function e2m_note_delete($parameters=array()) { global $n2e5d8; if(array_key_exists('draft',$parameters)) { $xaad65=m4627($parameters['draft']); $wf91b2=true; } else { $xaad65=e2_published_noterec_with_parameters_($parameters); $wf91b2=false; } if ($xaad65===false) return e2_error404_mode(); $q57529=array ( '.note-id' => $xaad65['ID'], '.is-draft' => (int)$wf91b2, 'form-action' => f83c8('e2s_note_delete'), 'submit-text' => 'Удалить', 'draft?' => (int)$wf91b2, 'note-title' => htmlspecialchars($xaad65['Title']), ); $ud5d3d=$wf91b2? 'Удаление черновика':'Удаление заметки'; $s2cb9d=array ( 'title' => $ud5d3d. ': '. htmlspecialchars($xaad65['Title']), 'heading' => $ud5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $q57529, ); return $s2cb9d; } function e2m_note_delete_spam($parameters=array ()) { global $n2e5d8; if (!@$n2e5d8['comments']['on']) return e2_error404_mode(); $z39a37=e2_published_noterec_with_parameters_($parameters); $s21158=$z39a37['ID']; if (!$z39a37) return e2_error404_mode(); e2_drop_caches_for_note_($s21158); if (t0738( "DELETE FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID` = '".((int)$s21158)."' AND `IsSpamSuspect` = 1" )) { } else { d8a40('Ошибка при удалении спама'); } f4930(); die; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; if (z7e6c($parameters)) { $p67142=$parameters; $p67142['value'] = !$parameters['value']; if($parameters['value']==1){ $q99859=f83c8('e2m_note_flag_favourite',$p67142); $f1fa03='on-rehref|'. $q99859; } else { $q99859=f83c8('e2m_note_flag_favourite',$p67142); $f1fa03='off-rehref|'. $q99859; } } else { $f1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($f1fa03); } else { e2_go_to(f83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ z7e6c($parameters); e2_go_to(f83c8('e2m_note',$parameters)); die; } function z7e6c($parameters){ if(array_key_exists('draft',$parameters)) { $s21158=$parameters['draft']; } else { $s21158=g8a8a($parameters['day'],$parameters['month'],$parameters['year'],$parameters['day-number']); } e2_drop_caches_for_note_($s21158); $result=baa79('Notes', array ( 'ID' => $s21158, $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_note_edit($parameters=array ()) { return r7dd3('edit',$parameters); } function r7dd3($u60cd8,$parameters=array ()) { global $kf97aa,$n2e5d8; $ud5d3d='Новая заметка'; $lf74f5='Новая заметка'; $s21158='new'; if ($u60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $lf74f5='Правка черновика'; $xaad65=m4627($parameters['draft']); if ($xaad65['IsPublished']) { e2_go_to(f83c8('e2m_note_edit', array ('*note' => $xaad65))); die; } } else { $lf74f5='Правка заметки'; $xaad65=e2_published_noterec_with_parameters_($parameters); } if (!$xaad65) return e2_error404_mode(); $s21158=$xaad65['ID']; $ud5d3d=oea9c($xaad65); } $b04868=u3873(); $o77b75=array(); foreach ($b04868 as $dd7df5){ $o77b75[] = htmlspecialchars($dd7df5['Keyword']); } natcasesort($o77b75); $j9dbb8=htmlspecialchars($xaad65['Tags']); if ($u60cd8=='edit' and count($o77b75)) { $b04868=qa463($xaad65['ID']); $jd2e3e=array(); foreach ($b04868 as $dd7df5){ $jd2e3e[] = htmlspecialchars($dd7df5['Keyword']); } $jd2e3e=implode(', ',$jd2e3e); if ($jd2e3e)$j9dbb8=$jd2e3e; } if ($u60cd8=='write'){ $tc50d0='Сохранить и посмотреть'; } if ($u60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $tc50d0='Сохранить и посмотреть'; } else { $tc50d0='Сохранить изменения'; } } $x59b51=array(); if(preg_match_all('/\(\(([^ ]*)( |\)\))/',$xaad65['Text'],$i9c28d)) { foreach ($i9c28d[1] as $re3cc9){ if(is_file(PICTURES_FOLDER.$re3cc9)) { if ($vf1210=r291d($re3cc9)) { $x59b51[] = array ('name' => $re3cc9,'thumb' => $vf1210); } } } } $s2cb9d['title']=$ud5d3d; $s2cb9d['heading']=$lf74f5; $s2cb9d['form']='form-note'; $s2cb9d['form-note'] = array ( '.note-id' => $s21158, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($kf97aa)+1), '.old-tags-hash' => md5($j9dbb8), '.instant-publish' => 'no', '.action' => $u60cd8, 'form-action' => f83c8('e2s_note_process'), 'form-note-livesave-action' => f83c8('e2j_note_livesave'), 'form-file-upload-action' => f83c8('e2j_file_upload'), 'form-file-remove-action' => f83c8('e2j_file_remove'), 'create:edit?' => (bool) ($u60cd8=='write'), 'title' => htmlspecialchars($xaad65['Title']), 'tags' => $j9dbb8, 'text' => htmlspecialchars($xaad65['Text'],ENT_NOQUOTES), 'images' => $x59b51, 'submit-text' => $tc50d0, 'all-tags' => $o77b75, ); if ($u60cd8=='edit'){ $s2cb9d['form-note']['delete-href']=f83c8( 'e2m_note_delete', array ('*note' => $xaad65) ); if (!array_key_exists('draft',$parameters)) { $xaad65['_']['_id']=$xaad65['ID']; $xaad65['_']['_ord']=0; $xaad65['_']['_ord_max']=0; $s2cb9d['form-note']['note']=r6791($xaad65); $s2cb9d['form-note']['edit-time-href']=f83c8( 'e2m_note_finetune', array ('*note' => $xaad65) ); $s2cb9d['form-note']['withdraw-href']=f83c8( 'e2m_note_withdraw', array ('*note' => $xaad65) ); } } return $s2cb9d; } function e2m_write(){ return r7dd3('write'); } function e2s_note_process(){ global$_fp_error; $s21158=ha21e(); if (!$s21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ d8a40('У заметки должны быть название и текст'); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { d8a40('Произошла ошибка ('. $_fp_error .')'); } e2_go_to(f83c8('e2m_write')); die; } $xaad65=m4627($s21158); if ($xaad65['IsPublished']) { e2_go_to(f83c8('e2m_note', array ('*note' => $xaad65))); } else { e2_go_to(f83c8('e2m_draft', array ('draft' => $xaad65['ID']))); } die; } function e2s_note_publish(){ global $n2e5d8; $s21158=false; if(array_key_exists('note-id',$_POST)) { $s21158=$_POST['note-id']; $tea59a=array ( 'ID' => $s21158, 'IsPublished' => 1, 'IsFavourite' => 0, 'Stamp' => time(), 'Offset' => (int)$yb2c6c['offset'], 'IsDST' => (int)$yb2c6c['is_dst'], 'IP' => $_SERVER['REMOTE_ADDR'], ); $yb2c6c=e2_timezone_from_posted_offset(@$_POST['gmt-offset']); if ($yb2c6c){ $tea59a['Offset'] = (int)$yb2c6c['offset']; $tea59a['IsDST'] = (int)$yb2c6c['is_dst']; } e2_drop_caches_for_note_($s21158); if (baa79('Notes',$tea59a)) { e2_go_to(f83c8('e2m_note', array ('*note' => $tea59a))); die; } else { d8a40('Ошибка при публикации заметки'); f4930(); die; } } e2_go_to(); die; } function e2s_note_delete(){ global $n2e5d8; $s21158=$_POST['note-id']; $wf91b2=(bool)$_POST['is-draft']; if (!t0738( "DELETE FROM `". $n2e5d8['db']['table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$s21158) )) { d8a40('Ошибка при удалении лишних связей из таблицы NotesKeywords'); } e2_drop_caches_for_note_($s21158); if (t0738( "DELETE FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `ID` = '".((int)$s21158)."'" )) { if ($wf91b2){ e2_go_to(f83c8('e2m_drafts')); } else { e2_go_to(); } die; } else { d8a40('Ошибка при удалении заметки') and e2_go_to() and die; } } function e2s_note_withdraw(){ global $n2e5d8; $s21158=$_POST['note-id']; $tea59a=array ( 'ID' => $s21158, 'IsPublished' => (int) !array_key_exists('withdraw',$_POST), 'IsVisible' => (int) !array_key_exists('hide',$_POST), 'Stamp' => time(), 'Offset' => (int)$n2e5d8['timezone']['offset'], 'IsDST' => (int)$n2e5d8['timezone']['is_dst'], 'IP' => $_SERVER['REMOTE_ADDR'], ); e2_drop_caches_for_note_($s21158); if (baa79('Notes',$tea59a)) { if ($tea59a['IsPublished']) { e2_go_to(f83c8('e2m_note', array ('*note' => $tea59a))); } else { e2_go_to(f83c8('e2m_draft', array ('draft' => $s21158))); } } else { d8a40('Ошибка при отзыве заметки'); f4930(); } die; } function e2s_note_finetune(){ global $n2e5d8,$p57de2; $s21158=@$_POST['note-id']; $yb2c6c=array ( 'offset' => @$_POST['offset']*SECONDS_IN_A_MINUTE, 'is_dst' => isset ($_POST['is_dst']), ); $vd17d3='/(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2})/'; $haddfe=@$_POST['stamp']; $tdefcd=@$_POST['stamp_radio']; if ($tdefcd=='shift'){ } if ($tdefcd=='update'){ $g96b8c=time(); } if ($tdefcd=='new'){ if(preg_match($vd17d3,$haddfe,$r6f8f5)) { $g96b8c=gmmktime($r6f8f5[4],$r6f8f5[5],$r6f8f5[6],$r6f8f5[2],$r6f8f5[1],$r6f8f5[3]); $g96b8c -= e2_timezone_gmt_offset_of_timezone($yb2c6c,$g96b8c); } else { d8a40('Неправильный формат даты. Должен быть: "dd.mm.yyyy hh:mm:ss"'); unset ($g96b8c); } } $b20c6b=@$_POST['lastmodified']; $c2c010=@$_POST['lastmodified_radio']; if ($c2c010=='shift'){ } if ($c2c010=='update'){ $v3028c=time(); } if ($c2c010=='new'){ if(preg_match($vd17d3,$b20c6b,$r6f8f5)) { $v3028c=gmmktime($r6f8f5[4],$r6f8f5[5],$r6f8f5[6],$r6f8f5[2],$r6f8f5[1],$r6f8f5[3]); $v3028c -= e2_timezone_gmt_offset_of_timezone($yb2c6c,$v3028c); } else { d8a40('Неправильный формат даты. Должен быть: "dd.mm.yyyy hh:mm:ss"'); unset ($v3028c); } } e2_drop_caches_for_note_($s21158); if (t0738("UPDATE `". $n2e5d8['db']['table_prefix']."Notes` SET ". "`Offset`=". ((int)$yb2c6c['offset']) .", ". "`IsDST`=". ((int)$yb2c6c['is_dst']) . ( isset ($g96b8c)? ( ", `Stamp`=".((int)$g96b8c) ) : ( '' ) ). ( isset ($v3028c)? ( ", `LastModified`=".((int)$v3028c) ) : ( '' ) ). " WHERE ". "`ID`=".((int)$s21158) )) { if (isset ($g96b8c)) { $jec4a1=array ( 'ID' => $s21158, 'IsPublished' => 1, 'Stamp' => $g96b8c, 'Offset' => $yb2c6c['offset'], 'IsDST' => $yb2c6c['is_dst'], ); e2_go_to(f83c8('e2m_note', array ('*note' => $jec4a1))); } else { e2_go_to(f83c8('e2m_note', array ('*note' => m4627($s21158)))); } die; } else { d8a40('Ошибка при изменении заметки') and f4930() and die; } } function e2j_note_livesave(){ die (ha21e('ajaxresult')); } function r6791($xaad65,$v4dd42=array ()) { global $n2e5d8, $_config, $_candy, $_current_tag, $p57de2, $re5564, $se9bf8, $l097cc; $jda497=e2_note_cache_filename_with_id_($xaad65['_']['_id']); $ke244c=null; if(CACHE_NOTES and is_file($jda497)) { $ke244c=@unserialize(ocdf0($jda497)); } if(__LOG)__log('Notes: package note <'. $xaad65['_']['_id'] .'>...'); $oe919a=e7f78(); if(CACHE_NOTES and is_array($ke244c)) { if(__LOG)__log('Notes: retrieve cached ctree'); $zc6827=$ke244c; } else { if(__LOG)__log('Notes: assemle cacheable ctree...'); $zc6827['title'] = u6f10(htmlspecialchars(oea9c($xaad65),ENT_NOQUOTES)); $zc6827['text'] = r154e($xaad65['FormatterID'], @$xaad65['Text'],'full'); $zc6827['time'] = array ((int)$xaad65['Stamp'],e2_note_timezone($xaad65)); $zc6827['last-modified'] = array ((int)$xaad65['LastModified'],e2_note_timezone($xaad65)); $zc6827['last-ip'] = $xaad65['IP']; $zc6827['published?'] = (bool)$xaad65['IsPublished']; $zc6827['commentable?'] = (bool) ($xaad65['IsCommentable'] && $xaad65['IsPublished']); $zc6827['favourite?'] = (bool) ($xaad65['IsFavourite'] && $xaad65['IsPublished']); $zc6827['visible?'] = (bool) ($xaad65['IsVisible'] || !$xaad65['IsPublished']); $f0dff3=wce23($xaad65['ID']); $od57ac=array(); foreach ($f0dff3 as $m865c0 => $ub19ad){ $le4d23['name']=htmlspecialchars($ub19ad['Keyword'],ENT_NOQUOTES); $le4d23['href']=f83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($ub19ad['Keyword'])) : array ('tag-urlname' => $ub19ad['URLName']) ); $od57ac[] = $le4d23; } $zc6827['tags']=$od57ac; $n905f7=l254f($xaad65['ID']); if ($zc6827['published?']) { $zc6827['comments-count']=$n905f7; $zc6827['your-comment-href'] = ( f83c8('e2m_note_comment', array ('*note' => $xaad65)) ); } $ke244c=$zc6827; if(CACHE_NOTES) @k6e52($jda497,serialize($ke244c)); } if(__LOG)__log('Notes: continue with the uncacheable, '. round(e7f78()-$oe919a,3) .' so far...'); $zc6827['commentable-now?']=ub387($xaad65); $zc6827['can-be-commentable?']=$n2e5d8['comments']['on'] && $zc6827['published?']; foreach ($zc6827['tags'] as $f8ce4b => $x9e366){ $zc6827['tags'][$f8ce4b]['current?'] = (bool) ($zc6827['tags'][$f8ce4b]['name']==$_current_tag); } if ($xaad65['IsPublished']) { $td58c0=f83c8('e2m_note', array ('*note' => $xaad65)); } else { $td58c0=f83c8('e2m_draft', array ('draft' => $xaad65['ID'])); } $zc6827['href']=$td58c0; $zc6827['comments-link?'] = (bool) ( $n2e5d8['comments']['on'] && $xaad65['IsPublished'] && (ub387($xaad65) or ($zc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (qe852()) { $pfe9e2=l254f($xaad65['ID'],'new'); $zc6827['new-comments-count']=$pfe9e2; if ($xaad65['IsPublished']) { if ($xaad65['IsFavourite']) { $zc6827['favourite-toggle-href']=f83c8( 'e2m_note_flag_favourite', array ('*note' => $xaad65,'value' => 0) ); } else { $zc6827['favourite-toggle-href']=f83c8( 'e2m_note_flag_favourite', array ('*note' => $xaad65,'value' => 1) ); } } $zc6827['edit-href']=f83c8( 'e2m_note_edit', array ('*note' => $xaad65) ); $q9920c=$zc6827['edit-href']; if (!$xaad65['IsPublished']) { $zc6827['delete-href']=f83c8( 'e2m_note_delete', array ('*note' => $xaad65) ); } } if (@is_array($v4dd42) and count($v4dd42) > 0){ foreach (array ('title','text') as $b65d3b){ $zc6827[$b65d3b]=preg_replace_callback('#<[^>]+>#is','hel_savetag',$zc6827[$b65d3b]); foreach ($v4dd42 as $e2510c){ $zc6827[$b65d3b]=preg_replace('/\b('.preg_quote($e2510c,'/').')\b/i','<span class="'.CSS_CLASS_HIGHLIGHT.'">$1</span>',$zc6827[$b65d3b]); } $zc6827[$b65d3b]=str_replace('</span> <span class="'.CSS_CLASS_HIGHLIGHT.'">',' ',$zc6827[$b65d3b]); $zc6827[$b65d3b]=hel_restore_tags($zc6827[$b65d3b]); } } if(array_key_exists('_',$xaad65))$zc6827['_']=$xaad65['_']; if(__LOG)__log('Notes: package note done in '. round(e7f78()-$oe919a,3)); return $zc6827; } function m4627($eb80bb){ global $n2e5d8; if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `ID` = '".$eb80bb."'" )) { $pfa816=t0d6b(); if(count($pfa816) > 0){ return $pfa816[0]; } else { return false; } } else { d8a40('Не удалось извлечь заметку из базы') and f4930() and die; } } function ncca7($xaad65,$tb4ca4,$l8f888=1){ global $n2e5d8; $o7ffc4=($tb4ca4=='next')?'>':'<'; $r1dee8=($tb4ca4=='next')?'':'DESC '; if (!qe852()) $t91d12=' AND `IsVisible`=1'; if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=". $l8f888 ." AND `Stamp` ".$o7ffc4." '".$xaad65['Stamp']."'".@$t91d12." ". "ORDER BY STAMP ".$r1dee8. "LIMIT 1" )) { $pfa816=t0d6b(); if(count($pfa816) > 0) return $pfa816[0]; else return FALSE; } else { d8a40('Не удалось извлечь заметку из базы') and f4930() and die; } } function oea9c($xaad65){ if ($xaad65['Title']) { return $xaad65['Title']; } else { return '#'. $xaad65['ID']; } } function e50d7($fd5566,$b71860=1){ global $n2e5d8,$_config; $lb01a5=$fd5566; $o8b7af='all'; if ('rss'==$fd5566 or !qe852()) { $m25715="AND `IsVisible`=1 "; $o8b7af='visible'; } if ('web'==$fd5566)$lb01a5.='_'.$o8b7af; if ('web'==$fd5566){ $f19ee4=($b71860-1)*$n2e5d8['appearance']['notes_per_page']; $qaa9f7=$f19ee4 .', '. $n2e5d8['appearance']['notes_per_page']; } if ('rss'==$fd5566){ $qaa9f7=$_config['rss_items']; } if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 " .@$m25715. "ORDER BY `Stamp` DESC ". "LIMIT ". $qaa9f7 )) { $result=t0d6b(); return$result; } else { return FALSE; } } function e82dc($p41529,$r6f8f5){ global $n2e5d8; list ($pfc6b2,$a10df4)=e2_boundaries_worldwide($p41529,$r6f8f5); if (!qe852())$if79b1="`IsVisible`=1 AND "; if (t0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND " .@$if79b1. "`Stamp` BETWEEN '". $pfc6b2 ."' AND '". $a10df4 ."'" )) { $result=t0d6b(); $a44fde=array(); foreach($result as $l65afd){ if ( ((int)$p41529) .'/'. ((int)$r6f8f5) == e2_format_dt_of_timezone('Y/n',$l65afd['Stamp'],e2_note_timezone($l65afd)) ) { $a44fde[] = (int)e2_format_dt_of_timezone('j',$l65afd['Stamp'],e2_note_timezone($l65afd)); } } $a44fde=@array_unique($a44fde); sort($a44fde); return $a44fde; } else { return false; } } function sb92c($p41529){ global $n2e5d8; list ($s5a603,$sc2b31)=e2_boundaries_worldwide($p41529); if (!qe852())$if79b1="`IsVisible`=1 AND "; if (t0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND ". @$if79b1. "`Stamp` BETWEEN '". $s5a603. "' AND '". $sc2b31 ."'" )) { $result=t0d6b(); foreach($result as $l65afd){ if ( ((int)$p41529) == e2_format_dt_of_timezone('Y',$l65afd['Stamp'],e2_note_timezone($l65afd)) ) { $uda36c[] = (int)e2_format_dt_of_timezone('n',$l65afd['Stamp'],e2_note_timezone($l65afd)); } } $uda36c=@array_unique($uda36c); sort($uda36c); return $uda36c; } else { return false; } } function gd864($b8d777){ global $n2e5d8,$b71860,$v5c4a6; $d7694f=$b8d777['query']; $cd7e5d=$n2e5d8['appearance']['notes_per_page']; $vb3b32=array(); if (isset ($b8d777['page'])) { $b71860=$b8d777['page']; $d7694f.=' LIMIT '.($b8d777['page']-1)*$cd7e5d.', '.$cd7e5d; $h61e23=str_replace('SELECT *','SELECT count(*)',$b8d777['query']); if (t0738($h61e23)) { $result=t0d6b(); $ufbb44=$result[0]['count(*)']; $iae0fe=ceil($ufbb44/$cd7e5d); $vb3b32['numbered?']=true; $vb3b32['count']=$iae0fe; $vb3b32['this']=$b71860; for ($m865c0=1; $m865c0 <= $iae0fe; $m865c0++) { $v920fa=$b8d777['parameters']; $v920fa['page']=$m865c0; $vb3b32['each'][$m865c0]=f83c8($b8d777['candy'],$v920fa); } $vb3b32['title']='Страницы'; $vb3b32['prev-title']='<a>предыдущая</a>'; $vb3b32['next-title']='<a>следующая</a>'; if ($b71860 > 1){ $vb3b32['prev-href']=$vb3b32['each'][$b71860-1]; } if ($b71860 < $iae0fe){ $vb3b32['next-href']=$vb3b32['each'][$b71860+1]; } } else { return array (); } } $o4358b=array(); if (t0738($d7694f)) { $result=$de5b87=t0d6b(); if (@$b8d777['query-returns-only-ids']) { $result=array(); foreach ($de5b87 as $xaad65){ $xaad65=m4627($xaad65['ID']); if ($xaad65['IsPublished'] and ($xaad65['IsVisible'] or qe852())) { $result[] = $xaad65; } } } foreach($result as $f8ce4b => $xaad65){ $xaad65['_']['_id']=$xaad65['ID']; $xaad65['_']['_ord']=k; $xaad65['_']['_ord_max']=count($result)-1; $o4358b[] = r6791($xaad65,$b8d777['highlight']); } } else { return array (); } $a05a16=$o4358b; if (!isset ($b8d777['show-all-notes']) or @$b8d777['show-all-notes']!=true){ $a05a16=array_slice($o4358b,0,$cd7e5d); } $s2cb9d['robots']='noindex, follow'; if (!count($o4358b) and array_key_exists('no-notes-text',$b8d777)) { $s2cb9d['no-notes-text']=$b8d777['no-notes-text']; } $ocd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', 'related-rss-href', ); foreach ($ocd0fd as $tf97bf){ if(array_key_exists($tf97bf,$b8d777)) { $s2cb9d[$tf97bf]=$b8d777[$tf97bf]; } } if ($ufbb44){ $q5cde2=eace2($ufbb44. ' замет(ка,ки,ок)'); } else { $q5cde2='Нет заметок'; } foreach (array ('title','heading','superheading') as $q4b24c){ if(strstr($b8d777[$q4b24c],'%total%')) { $s2cb9d[$q4b24c]=str_replace('%total%', $q5cde2,$b8d777[$q4b24c]); } } $s2cb9d['notes']=$a05a16; $s2cb9d['pages']=$vb3b32; return $s2cb9d; } function yf9fb($p41529,$r6f8f5,$n8277e=false){ global $n2e5d8; list ($k7b314,$ba1f20)=e2_boundaries_worldwide($p41529,$r6f8f5,$n8277e); if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$k7b314. " AND " .$ba1f20. ")". "ORDER BY Stamp" )) { $result=t0d6b(); $mb1bc2=1; $s2cb9d=array(); foreach($result as $l65afd){ if(is_numeric($n8277e)) { $l3f917=((int)$p41529) .'/'. ((int)$r6f8f5) .'/'. ((int)$n8277e) == e2_format_dt_of_timezone('Y/n/j',$l65afd['Stamp'],e2_note_timezone($l65afd)); } elseif(is_numeric($r6f8f5)) { $l3f917=((int)$p41529) .'/'. ((int)$r6f8f5) == e2_format_dt_of_timezone('Y/n',$l65afd['Stamp'],e2_note_timezone($l65afd)); } else { $l3f917=((int)$p41529) == e2_format_dt_of_timezone('Y',$l65afd['Stamp'],e2_note_timezone($l65afd)); } if ($l3f917){ if(is_numeric($n8277e)) { $l65afd['day_number']=$mb1bc2; } $s2cb9d[] = $l65afd; $mb1bc2 ++; } } return $s2cb9d; } else { return false; } } function g8a8a($n8277e,$r6f8f5,$p41529,$b7b8b9){ $pfa816=pa90d($n8277e,$r6f8f5,$p41529,$b7b8b9); return $pfa816['ID']; } function pa90d($n8277e,$r6f8f5,$p41529,$b7b8b9){ $o4358b=yf9fb($p41529,$r6f8f5,$n8277e); if (@$o4358b[$b7b8b9-1]) { return $o4358b[$b7b8b9-1]; } } function e2_published_noterec_with_parameters_($parameters=array ()) { $uc2d18=yf9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$uc2d18[$parameters['day-number']-1]) { return $uc2d18[$parameters['day-number']-1]; } } function ae56b($ud5d3d,$p1cb25,$yb2c6c){ global$_config; ke2f1(); $z39a37=array ( 'Title' => h7928($ud5d3d), 'Text' => h7928($p1cb25), 'FormatterID' => $_config['default_formatter'], 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'Offset' => (int)$yb2c6c['offset'], 'IsDST' => (int)$yb2c6c['is_dst'], 'IP' => h7928($x957b5), ); if (($z39a37=n9943('Notes',$z39a37)) !== false){ return $z39a37['ID']; } } function ha21e($q98ea6=''){ global $n2e5d8,$_fp_error; $_fp_error=false; $s21158=$ud5d3d=$od57ac=$p1cb25=$nb4960=''; if(array_key_exists('note-id',$_POST)) $s21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $ud5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $od57ac=trim($_POST['tags']); if(array_key_exists('text',$_POST)) $p1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $nb4960=$_POST['old-tags-hash']; if(preg_match('//u',$ud5d3d))$ud5d3d=wedd9($ud5d3d,false); if(preg_match('//u',$od57ac))$od57ac=wedd9($od57ac,false); if(preg_match('//u',$p1cb25))$p1cb25=wedd9($p1cb25,true); $jffa71=$p1cb25; $jffa71=str_replace("\n",'\n'."\n",$jffa71); $jffa71=str_replace("\r",'\r'."\r",$jffa71); if(__LOG)__log('e2fp_note: Text is ['. $jffa71 .'] ('. strlen($p1cb25) .')'); $da6168=n163d(',',$od57ac,'sort'); $od57ac=implode(', ',$da6168); $s65f31=md5($od57ac); if(array_key_exists('gmt-offset',$_POST)) { $yb2c6c=e2_timezone_from_posted_offset(@$_POST['gmt-offset']); } else { $yb2c6c=false; } if ($s21158){ if ($ud5d3d!='' and $p1cb25!=''){ if ($s21158=='new'){ if ($s21158=ae56b($ud5d3d,$p1cb25,$yb2c6c)) { $f1fa03='id|'. (int)$s21158; $result=(int)$s21158; } else { $f1fa03='error|Cannot create record ('. mysql_error(). ')'; $result=false; } } else { $tea59a=array ( 'ID' => $s21158, 'Title' => $ud5d3d, 'Text' => $p1cb25, 'LastModified' => time(), ); e2_drop_caches_for_note_($s21158); if (baa79('Notes',$tea59a)) { $f1fa03='saved'; $result=(int)$s21158; } else { $f1fa03='error|Cannot update record ('. mysql_error(). ')'; $result=false; }; } if ($s65f31!=$nb4960){ e93c2(array ('NoteID' => $s21158)); foreach ($da6168 as $le4d23){ $z70b77=j0188($le4d23); if (!$z70b77){ $td7ca3=qec0d($le4d23); $z70b77['ID']=d478d($le4d23,$td7ca3,0,'',0); } t0738( "INSERT INTO `". $n2e5d8['db']['table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$s21158) .", ". ((int)$z70b77['ID']). ")" ); } } if ( $q98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$s21158; e2s_note_publish(); } } else { $f1fa03='error|Title or text is empty'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $f1fa03='error|No note id/new specified'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } if ($q98ea6=='ajaxresult') return $f1fa03; else return$result; } function tcc02($t92c58){ global $n2e5d8; $o8b7af='p1'; if (!qe852()) { $o8b7af='p1v1'; $if79b1="AND `IsVisible`=1"; } $ld29bb=CACHES_FOLDER.$t92c58 .'-stamp-'. $o8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($ld29bb)) { $result=@unserialize(ocdf0($ld29bb)); } if(is_array($result)) { return$result; } else { if ($t92c58=='start'){ t0738( "SELECT Stamp, Offset, IsDST FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $if79b1 ." ORDER BY Stamp LIMIT 1" ); } elseif ($t92c58=='end'){ t0738( "SELECT Stamp, Offset, IsDST FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $if79b1 ." ORDER BY Stamp DESC LIMIT 1" ); } $result=t0d6b(); if(count($result)) { $result=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => e2_note_timezone($result[0]), ); if(CACHE_EDGE_TIMEINFO)k6e52($ld29bb,serialize($result)); return$result; } else { return null; } } } function z8ca0($s1653c,$z0604c){ global $n2e5d8; if (!($s1653c and $z0604c) and !qe852()) { die ('API MISUSE: e2_notes_count_general cannot be called for invisible notes or drafts unsecurely :-('); } if (!is_bool($s1653c) or !is_bool($z0604c)) { die ('API MISUSE: e2_notes_count_general must be called with bool params :-('); } if (!$s1653c and !$z0604c){ die ('API MISUSE: e2_notes_count_general called with nonsensical parameters'); } $ld29bb=CACHES_FOLDER . 'notes-count-p'. (int)$s1653c . ($s1653c ? ('v'. (int)$z0604c):'') . '.txt'; $result=false; if(CACHE_NOTES_COUNTS and is_file($ld29bb)) { $result=@ocdf0($ld29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { t0738( "SELECT COUNT(*) As NotesCount FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$s1653c. " ". ($s1653c ? ( "AND   `IsVisible`=". (int)$z0604c ):"") ); $result=t0d6b(); $result=$result[0]['NotesCount']; if($result){ if(CACHE_NOTES_COUNTS)k6e52($ld29bb,$result); return$result; } else { return null; } } } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$n2e5d8; $zda3ad='Stamp'; $zda3ad='LastModified'; $tda48a=array(); if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `". $zda3ad ."` DESC" )) { $result=t0d6b(); $o4358b=array(); foreach($result as $f8ce4b => $z39a37){ $xaad65['_']['_id']=$z39a37['ID']; $xaad65['_']['_ord']=k; $xaad65['_']['_ord_max']=count($result)-1; $xaad65['href']=f83c8('e2m_draft', array ( 'draft' => $z39a37['ID'], )); $xaad65['title']=u6f10(htmlspecialchars(oea9c($z39a37),ENT_NOQUOTES)); if (isset ($xaad65['image-href'])) unset ($xaad65['image-href']); if(preg_match_all('/\(\(([^ ]*)( |\)\))/',$z39a37['Text'],$i9c28d)) { foreach ($i9c28d[1] as $re3cc9){ if(is_file(PICTURES_FOLDER.$re3cc9)) { if ($vf1210=r291d($re3cc9)) { $xaad65['image-href']=$vf1210; break; } } } } $xaad65['text-fragment']=strip_tags(r154e($z39a37['FormatterID'],str_replace("\n",' ',$z39a37['Text']), 'simple')); $w2ab2d=false; if(strlen($xaad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $w2ab2d=strpos($xaad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($w2ab2d!==false){ $xaad65['text-fragment']=substr($xaad65['text-fragment'],0,$w2ab2d+1); } $tda48a[] = $xaad65; } } return array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], 'drafts' => $tda48a, ); } function e2m_draft($parameters=array ()) { global$_strings,$p57de2; $xaad65=m4627($parameters['draft']); $td58c0=f83c8('e2m_note', array ('*note' => $xaad65)); if ($xaad65['IsPublished']) { return e2_go_to($td58c0); } $xaad65['_']['_id']=$xaad65['ID']; $xaad65['_']['_ord']=0; $xaad65['_']['_ord_max']=0; $u8e4cd=r6791($xaad65); $v45513=array ( '.note-id' => $xaad65['ID'], 'form-action' => f83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], ); return array ( 'title' => oea9c($xaad65).' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $u8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $v45513, ); } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@instantiate:version' => 'e2://e2s_instantiate', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_frontpage_rss', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', ':note' => 'e2://e2m_note', ':note/comment' => 'e2://e2m_note_comment', ':note/@edit' => 'e2://e2m_note_edit?is_published=1', ':note/@edit/time' => 'e2://e2m_note_finetune?is_published=1', ':note/@favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/@unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/@show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/@hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/@discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/@quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/@withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/@delete' => 'e2://e2m_note_delete?is_published=1', ':note/@delete-spam' => 'e2://e2m_note_delete_spam?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/comments-rss' => 'e2://e2m_note_comments_rss', ':comment' => 'e2://e2m_comment', ':comment/@edit' => 'e2://e2m_comment_edit', ':comment/@important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':comment/@usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':comment/@replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':comment/@remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':comment/@spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':comment/@good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':comment/@wipe' => 'e2://e2m_comment_delete', ':comment/reply/@edit' => 'e2://e2m_comment_reply', ':comment/reply/@important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':comment/reply/@usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':comment/reply/@replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':comment/reply/@remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':comment/reply/@delete' => 'e2://e2m_comment_reply_delete', '@drafts' => 'e2://e2m_drafts', '@drafts/:draft' => 'e2://e2m_draft', '@drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', '@drafts/:draft/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=0&value=0', '@drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'uploads/:file' => '', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found?page=1&query=', 'found/:query' => 'e2://e2m_found?page=1', 'found/:query:page' => 'e2://e2m_found', 'found/:query/rss' => 'e2://e2m_found_rss', 'everything' => 'e2://e2m_everything', '@new' => 'e2://e2m_write', '@settings' => 'e2://e2m_settings', '@name' => 'e2://e2m_name_and_author', '@install' => 'e2://e2m_install', '@update' => 'e2://e2m_update', '@update/install' => 'e2://e2m_update_install', '@database' => 'e2://e2m_database', '@password' => 'e2://e2m_password', '@sessions' => 'e2://e2m_sessions', '@timezone' => 'e2://e2m_timezone', '@sign-in' => 'e2://e2m_sign_in', '@sign-out' => 'e2://e2m_sign_out', ); $_url_chunks=array ( '\:page' => '\~(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', '\:comment' => '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)\/'. 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => TRANS_TAGS_UTF8_URLS? '(?P<tag>.*?)':'(?P<tag_urlname>.*?)', '\:query' => '(?P<query>.*?)', '\:draft' => '(?P<draft>\d+)', '\:version' => '\:(?P<version>\d+)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.*?)\:(?P<unsubscribe_key>[0-9a-f]{32})', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^no\-tags(\~.+)?$/i' => 'untagged\\1', '/^no\-tags\/(.+)/i' => 'untagged/\\1', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', ); function rb6b0($b572d4){ global$_url_autoredirects,$ra57c1; $b572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$b572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$b572d4,$i9c28d)) { if(2==strlen($i9c28d[3]))$i9c28d[3]='20'.$i9c28d[3]; return ($i9c28d[3].'/'.$i9c28d[2].'/'.$i9c28d[1].$i9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$b572d4,$i9c28d)) { $le4d23=substr($i9c28d[1],strrpos($i9c28d[1],'/')+1); return ('tags/'. $le4d23.'/rss/'); } return $b572d4; } function m7059(){ global$__synthetic_urls,$_config; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } } function f83c8($ic48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$p57de2,$ra57c1; $zc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $p57de2=$_config['preferred_domain_name']; } $b572d4='http://'. $p57de2.$ra57c1 .'/'; $v9c464='e2://'. $ic48ba; if(array_key_exists('page',$parameters)) { $b71860=$parameters['page']; } else { $b71860=1; } if($parameters){ $v9c464.='?'; $x1c61f=array(); $s21711=array(); foreach($parameters as $l3c6e0 => $v2063c){ if (@$l3c6e0[0]=='*'){ $s21711[] = $l3c6e0; $x1c61f[] = cbdf6($l3c6e0,$v2063c); } } foreach ($s21711 as $l3c6e0) unset($parameters[$l3c6e0]); foreach ($x1c61f as $n58e2a){ $parameters=array_merge($parameters,$n58e2a); } foreach($parameters as $l3c6e0 => $v2063c) if (!@$l3c6e0[0]=='_'){ if(array_key_exists('\:'. $l3c6e0,$_url_chunks)) { $q93316=$_url_chunks['\:'. $l3c6e0]; if(preg_match_all('/\<(.*?)\>/',$q93316,$i9c28d)) { foreach ($i9c28d[1] as $re3cc9){ if(array_key_exists($re3cc9,$parameters)) { $v9c464.=$re3cc9 .'='. urlencode($parameters[$re3cc9]) .'&'; } } } } else { $v9c464.=$l3c6e0 .'='. urlencode($v2063c) .'&'; } } $v9c464=substr($v9c464,0, -1); } if(0 and array_key_exists($v9c464,$zc2bd7)) { if ($zc2bd7[$v9c464]!='')$b572d4.=$zc2bd7[$v9c464] .'/'; return $b572d4; } else { $v44907=false; foreach ($zc2bd7 as $o45ea8 => $b9ea44){ $xb7365=$o45ea8; $xb7365=preg_quote($xb7365,'/'); if(strstr($o45ea8,'::')) { $xb7365=str_replace('\:\:','(.*)',$xb7365); $xb7365='/^'. $xb7365 .'$/s'; if(preg_match($xb7365,$v9c464,$i9c28d)) { $j0dc02=str_replace('_','-',$i9c28d[1]); $s95a17=str_replace('::',$j0dc02,$b9ea44); if($__synthetic_urls){ $b572d4.=$s95a17 .'/'; } else { $b572d4.='?go='. $s95a17 .'/'; } return $b572d4; } } $lebe09=parse_url($o45ea8); $t2f532=$lebe09['host']; $v54435=false; if ($ic48ba==$t2f532){ $v44907=true; if ($lebe09['query']) { $d22c38=explode('&',$lebe09['query']); foreach ($d22c38 as $s8822b){ list ($l3c6e0,$v2063c)=explode('=',$s8822b); $v2063c=urldecode($v2063c); $l3c6e0=str_replace('_','-',$l3c6e0); if ( array_key_exists($l3c6e0,$parameters) and $parameters[$l3c6e0]!=$v2063c ){ $v54435=true; break; } } } if (!$v54435){ if(preg_match_all('/\:[\-a-z]+/i',$b9ea44,$i9c28d)) { foreach ($i9c28d[0] as $ofc413){ $w05f62=$_url_chunks['\\'. $ofc413]; $sf9e1e=preg_replace( '/\(\?P\<(.*?)\>.*?\)/e','$parameters[str_replace ("_", "-", "\\1")]',$w05f62 ); $sf9e1e=stripslashes($sf9e1e); $b9ea44=str_replace($ofc413,$sf9e1e,$b9ea44); } } $t15214=array(); if ($b9ea44){ if($__synthetic_urls){ $b572d4.=$b9ea44 .'/'; } else { $t15214[] = 'go='. $b9ea44 .'/'; } } foreach($_GET as $f8ce4b => $x9e366) if(in_array($f8ce4b, array ('result','raw','themeless','part','of'))) { $t15214[] = $f8ce4b . ($x9e366? ('='. urlencode($x9e366)) : ''); } if(count($t15214)) { $b572d4.='?'. implode('&',$t15214); } return $b572d4; } } } if ($v44907){ return $b572d4; } else { die ('Cannot compose url for candy '. $ic48ba); } } } function ab7e9($b572d4){ global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$p57de2,$ra57c1; $i196c2=$b572d4; $b572d4=trim($b572d4,'/'); $b572d4=rb6b0($b572d4); $parameters=array(); foreach($_url_map as $l12a24 => $o45ea8){ $sd532d=$l12a24; $sd532d=preg_quote($sd532d,'/'); if(strstr($l12a24,'::')) { $sd532d=str_replace('\:\:','(.*)',$sd532d); $sd532d='/^'. $sd532d .'$/s'; if(preg_match($sd532d,$b572d4,$i9c28d)) { $w53b9e=str_replace('-','_',$i9c28d[1]); $v9c464=str_replace('::',$w53b9e,$o45ea8); } } elseif(strstr($l12a24,':')) { $sd532d=str_replace( array_keys($_url_chunks), array_values($_url_chunks), $sd532d ); $sd532d='/^'. $sd532d .'$/s'; if(preg_match($sd532d,$b572d4,$i9c28d)) { $v9c464=$o45ea8; foreach ($i9c28d as $l3c6e0 => $v2063c) if (!is_numeric($l3c6e0)) { $l3c6e0=str_replace('_','-',$l3c6e0); $parameters[$l3c6e0]=$v2063c; } } } else { if ($l12a24==$b572d4){ $v9c464=$o45ea8; break; } } } $lfafdd=(bool)$v9c464; if (!$v9c464)$v9c464='e2://e2m_404'; $lebe09=parse_url($v9c464); $ic48ba=$lebe09['host']; if ($lebe09['query']) { $d22c38=explode('&',$lebe09['query']); foreach ($d22c38 as $s8822b){ list ($l3c6e0,$v2063c)=explode('=',$s8822b); $v2063c=urldecode($v2063c); $l3c6e0=str_replace('_','-',$l3c6e0); $parameters[$l3c6e0]=$v2063c; } } $s2cb9d=false; if ($lfafdd){ if($_config['force_canonical_urls']) { $m95d32=f83c8($ic48ba,$parameters); $ta37bf='http://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']; $g5d6ba='http://'.$_SERVER['HTTP_HOST'].urldecode($_SERVER['REQUEST_URI']); if ($ta37bf!=$m95d32 and $g5d6ba!=$m95d32){ e2_go_to($m95d32); } } if(TRANS_TAGS_UTF8_URLS){ foreach($parameters as $f8ce4b => $x9e366){ $parameters[$f8ce4b]=wedd9($parameters[$f8ce4b]); } } if(is_callable($ic48ba)) { $s2cb9d=array ($ic48ba,$parameters); } else { $s2cb9d=array (null, array ()); } } else { $s2cb9d=array (null, array ()); } return $s2cb9d; } function cbdf6($l3c6e0,$v2063c){ $parameters=array(); if ($l3c6e0=='*note')$parameters=e2urls__tricky_parameters_for_note_($v2063c); return$parameters; } function e2urls__tricky_parameters_for_note_($xaad65){ global $n2e5d8,$ra57c1; if (!isset ($xaad65['IsPublished'])) { return array (); } if (!$xaad65['IsPublished']) { $parameters['draft']=$xaad65['ID']; $parameters['is-published']=0; return$parameters; } $eb80bb=$xaad65['ID']; $g96b8c=$xaad65['Stamp']; $yb2c6c=e2_note_timezone($xaad65); list ($p41529,$r6f8f5,$n8277e)=explode('/', e2_format_dt_of_timezone('Y/m/d',$g96b8c,$yb2c6c) ); $parameters['year']=$p41529; $parameters['month']=$r6f8f5; $parameters['day']=$n8277e; $parameters['is-published']=1; if (isset ($xaad65['day_number'])) { $parameters['day-number']=$xaad65['day_number']; } else { list ($vd9d0f, ) = e2_boundaries_worldwide($p41529,$r6f8f5,$n8277e); if (t0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$vd9d0f. " AND " .$g96b8c. ") ". "ORDER BY `Stamp`" )) { $result=t0d6b(); $mb1bc2=1; foreach($result as $l65afd){ if ( $p41529.'/'.$r6f8f5.'/'.$n8277e == e2_format_dt_of_timezone('Y/m/d',$l65afd['Stamp'],e2_note_timezone($l65afd)) ) { if ($l65afd['ID']==$eb80bb){ $e444bc=1; break; } $mb1bc2 ++; } } if (@$e444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('<big style="background: #a00; color: #ccc; padding: .1em .33em">CANDIDATES_ENUMERATION_FAILED</big>'); } } $parameters['day-number']=$mb1bc2; } return$parameters; } function e2m_tags(){ global $n2e5d8; $result=e2_keywords(); $t59aeb=array(); foreach($result['keywords'] as $c0ac27){ $zc6827['tag']=htmlspecialchars($c0ac27['Keyword']); $zc6827['href']=f83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => $zc6827['tag']) : array ('tag-urlname' => $c0ac27['URLName']) ); $zc6827['favourite?'] = (bool)$c0ac27['IsFavourite']; $zc6827['notes-count']=0; $zc6827['last-used']=0; $zc6827['freshness']=0; $zc6827['weight']=0; $t59aeb[$c0ac27['ID']] = $zc6827; } $s9fdd5=0; $m8f57c=0; $o06894=0; foreach($result['ordering_info'] as $f28a42){ $zc6827 =& $t59aeb[$f28a42['KeywordID']]; $zc6827['notes-count']=$f28a42['Count']; if (@$zc6827['last-used'] < $f28a42['LastUsed']) { $zc6827['last-used']=$f28a42['LastUsed']; $c452b4=(time()-$zc6827['last-used']) / SECONDS_IN_A_YEAR; $zc6827['freshness']=pow(1/2,$c452b4); } $s9fdd5=max($s9fdd5,$zc6827['notes-count']); $m8f57c=max($m8f57c,$zc6827['freshness']); $o06894=max($o06894,$zc6827['notes-count']*$zc6827['freshness']); } $k86d7e=array(); foreach ($t59aeb as $m865c0 => $x9e366){ $t95e80=strtolower($x9e366['tag']); $k86d7e[$t95e80]=$x9e366; if ($m8f57c!=0){ $k86d7e[$t95e80]['freshness']=$x9e366['freshness']/$m8f57c; } else { $k86d7e[$t95e80]['freshness']=0; } if ($o06894!=0){ $k86d7e[$t95e80]['weight'] = ( $x9e366['freshness']*$x9e366['notes-count']/$o06894 ); } else { $k86d7e[$t95e80]['weight']=0; } if ($k86d7e[$t95e80]['favourite?'])$k86d7e[$t95e80]['weight']=1; } ksort($k86d7e); $s2cb9d=array ( 'title' => 'Теги', 'heading' => 'Теги', ); if(count($k86d7e) > 0){ $s2cb9d['tags'] = array ( 'many?' => count($k86d7e) > KEYWORDS_MANY_THRESH, 'each' => $k86d7e, ); } return $s2cb9d; } function e2m_tag($parameters=array ()) { global $n2e5d8, $_config, $_current_tag, $b71860,$kf97aa; if(array_key_exists('_tagrec',$parameters)) { $dd7df5=$parameters['_tagrec']; $d7186e=$parameters['tag-urlname']; } else { return e2_error404_mode(); } $_current_tag=$dd7df5['Keyword']; $b71860=$parameters['page']; $if79b1='AND `IsVisible`=1'; if (qe852())$if79b1=''; $hc2b7b=$n2e5d8['db']['table_prefix']; $h56790[] = "`". $hc2b7b."NotesKeywords`.KeywordID=". $dd7df5['ID']; $h56790=implode(' OR ',$h56790); $d76595=( "SELECT DISTINCT `". $hc2b7b."Notes`.* FROM `". $hc2b7b."Notes` ". "INNER JOIN `". $hc2b7b."NotesKeywords` ". "ON `". $hc2b7b."NotesKeywords`.NoteID=`". $hc2b7b."Notes`.ID ". "WHERE `IsPublished`=1 AND (". $h56790 .") ". $if79b1 ." ". "ORDER BY `". $hc2b7b."Notes`.`Stamp` DESC" ); $cd7e5d=$n2e5d8['appearance']['notes_per_page']; $d7694f=$d76595.' LIMIT '.($b71860-1)*$cd7e5d.', '.$cd7e5d; $h61e23=str_replace( "SELECT DISTINCT `". $n2e5d8['db']['table_prefix']."Notes`.*", "SELECT COUNT(DISTINCT `". $n2e5d8['db']['table_prefix']."Notes`.`ID`) AS NotesCount", $d76595 ); $vb3b32=array(); if (t0738($h61e23)) { $result=t0d6b(); $ufbb44=$result[0]['NotesCount']; $iae0fe=ceil($ufbb44/$cd7e5d); $vb3b32['numbered?']=true; $vb3b32['count']=$iae0fe; $vb3b32['this']=$b71860; for ($m865c0=1; $m865c0 <= $iae0fe; $m865c0++) { $v920fa=$parameters; $v920fa['page']=$m865c0; $vb3b32['each'][$m865c0]=f83c8('e2m_tag',$v920fa); } $vb3b32['title']='Страницы'; $vb3b32['prev-title']='<a>предыдущая</a>'; $vb3b32['next-title']='<a>следующая</a>'; if ($b71860 > 1){ $vb3b32['prev-href']=$vb3b32['each'][$b71860-1]; } if ($b71860 < $iae0fe){ $vb3b32['next-href']=$vb3b32['each'][$b71860+1]; } } if (t0738($d7694f)) { $result=t0d6b(); foreach($result as $f8ce4b => $xaad65){ $xaad65['_']['_id']=$xaad65['ID']; $xaad65['_']['_ord']=k; $xaad65['_']['_ord_max']=count($result)-1; $o4358b[] = r6791($xaad65); } } if (qe852()) { $v97a59['edit-href']=f83c8( 'e2m_tag_edit', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($dd7df5['Keyword'])) : array ('tag-urlname' => $d7186e) ); } if (''!=$dd7df5['Description']) { $x67daf=ib7f1($dd7df5['Description'],'simple','nocache'); $v97a59['description']=$x67daf; } if(TRANS_TAGS_UTF8_URLS){ $t3ad42=f83c8('e2m_tag_rss', array ('tag' => htmlspecialchars($dd7df5['Keyword']))); } else { $t3ad42=f83c8('e2m_tag_rss', array ('tag-urlname' => $d7186e)); } y3010( 'Заметки с тегом: '. htmlspecialchars($dd7df5['Keyword']), $t3ad42 ); $w96963=eace2($ufbb44. ' замет(ка,ки,ок)'). ' с тегом'; $s2cb9d=array ( 'title' => $w96963 .': '. $dd7df5['Keyword'], 'superheading' => $w96963, 'heading' => $dd7df5['Keyword'], 'related-rss-href' => $t3ad42, 'pages' => $vb3b32, 'notes' => $o4358b, 'tag' => $v97a59, ); if (qe852()) { $s2cb9d['related-edit-href']=$v97a59['edit-href']; $s2cb9d['related-edit-title']='Править параметры и описание тега'; } return $s2cb9d; } function e2m_tag_edit($parameters=array()) { global $n2e5d8; if(array_key_exists('_tagrec',$parameters)) { $dd7df5=$parameters['_tagrec']; } else { return e2_error404_mode(); } $rcd831=array ( '.tag-id' => $dd7df5['ID'], 'form-action' => f83c8('e2s_tag_edit'), 'submit-text' => 'Сохранить изменения', 'tag' => htmlspecialchars($dd7df5['Keyword']), 'urlname' => htmlspecialchars($dd7df5['URLName']), 'description' => htmlspecialchars($dd7df5['Description']), 'favourite?' => (bool)$dd7df5['IsFavourite'], 'delete-href' => f83c8( 'e2m_tag_delete', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($dd7df5['Keyword'])) : array ('tag-urlname' => $dd7df5['URLName']) ), ); $s2cb9d=array ( 'title' => 'Изменение тега:'. $dd7df5['Keyword'], 'heading' => 'Изменение тега', 'form' => 'form-tag', 'form-tag' => $rcd831, ); return $s2cb9d; } function e2m_tag_flag_ajax($parameters){ if (v2e88($parameters)) { $p67142=$parameters; $p67142['value'] = !$parameters['value']; if($parameters['value']==1){ $q99859=f83c8('e2m_tag_flag_ajax',$p67142); $f1fa03='on-rehref|'. $q99859; } else { $q99859=f83c8('e2m_tag_flag_ajax',$p67142); $f1fa03='off-rehref|'. $q99859; } } else { $f1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($f1fa03); } else { e2_go_to(f83c8('e2m_tag',$parameters)); die; } } function v2e88($parameters){ if(array_key_exists('_tagrec',$parameters)) { $dd7df5=$parameters['_tagrec']; } else { return false; } @unlink(CACHE_FILENAME_FAVTAGS); $result=baa79('Keywords', array ( 'ID' => $dd7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_tag_delete($parameters=array()) { global $n2e5d8; if(array_key_exists('_tagrec',$parameters)) { $dd7df5=$parameters['_tagrec']; } else { return e2_error404_mode(); } $wecc14=array ( '.tag-id' => $dd7df5['ID'], 'form-action' => f83c8('e2s_tag_delete'), 'submit-text' => 'Удалить', 'tag' => htmlspecialchars($dd7df5['Keyword']), ); $s2cb9d=array ( 'title' => 'Удаление тега: '. $dd7df5['Keyword'], 'heading' => 'Удаление тега', 'form' => 'form-tag-delete', 'form-tag-delete' => $wecc14, ); return $s2cb9d; } function e2m_untagged(){ global $n2e5d8; $if79b1='AND `IsVisible`=1'; if (qe852())$if79b1=''; return gd864(array ( 'query' => "SELECT n.* FROM `". $n2e5d8['db']['table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $n2e5d8['db']['table_prefix']."NotesKeywords` nk ". "ON nk.NoteID = n.ID ". "WHERE `IsPublished`=1 AND nk.KeywordID IS NULL ".$if79b1." ". "ORDER BY n.Stamp DESC", 'title' => 'Заметки без тегов', 'heading' => 'Заметки без тегов', 'no-notes-text' => 'Заметок без тегов нет', 'show-all-notes' => true, )); } function e2s_tag_edit(){ global $n2e5d8; $p89e37=1; if (!v01d3($_POST['urlname'])) { d8a40('Такой вид в адресной строке не может быть использован'); $p89e37=0; } if (t0738( "SELECT Keyword, URLName FROM `". $n2e5d8['db']['table_prefix']."Keywords` ". "WHERE (Keyword = '".h7928($_POST['tag'])."' ". "OR URLName = '".h7928($_POST['urlname'])."') ". "AND (ID != ".((int)$_POST['tag-id']).")")) { if(count(t0d6b()) == 0){ z7996(); @unlink(CACHE_FILENAME_FAVTAGS); if (t0738( "UPDATE `". $n2e5d8['db']['table_prefix']."Keywords` "."SET ". "`Keyword`='".h7928($_POST['tag'])."', ". ($p89e37? "`URLName`='".h7928($_POST['urlname'])."', ":''). "`Description`='".h7928($_POST['description'])."'". ' WHERE `ID`='.((int)$_POST['tag-id']))) { if ($p89e37 and TRANS_TAGS_UTF8_URLS){ e2_go_to(f83c8('e2m_tag', array ('tag' => $_POST['tag']))); } elseif (!TRANS_TAGS_UTF8_URLS){ e2_go_to(f83c8('e2m_tag', array ('tag-urlname' => $_POST['urlname']))); } else { f4930(); } die; } else { d8a40('Ошибка при обновлении описания в таблице тегов'); f4930(); die; } } else { d8a40('Такое имя или вид в адресной строке уже используются другим тегом') and f4930() and die; } } else { d8a40('Ошибка при обновлении описания в таблице тегов') and f4930() and die; } } function e2s_tag_delete(){ global $n2e5d8; $eb80bb=((int)$_POST['tag-id']); z7996(); @unlink(CACHE_FILENAME_FAVTAGS); $e444bc=( t0738( "DELETE FROM `". $n2e5d8['db']['table_prefix']."Keywords` WHERE `ID`=". $eb80bb ) and t0738( "DELETE FROM `". $n2e5d8['db']['table_prefix']."NotesKeywords` WHERE `KeywordID`=". $eb80bb ) ); if ($e444bc){ e2_go_to(f83c8('e2m_tags')); die; } else { d8a40('Ошибка при удалении тега'); f4930(); die; } } function e2_unfold_tag_parameters($parameters=array ()) { global $n2e5d8; if(TRANS_TAGS_UTF8_URLS){ if(array_key_exists('tag',$parameters)) { $f8ce4b=j0188($parameters['tag']); if ($f8ce4b)$parameters['_tagrec']=$f8ce4b; $parameters['tag-urlname']=$parameters['_tagrec']['URLName']; } } else { if(array_key_exists('tag-urlname',$parameters)) { $f8ce4b=u812d($parameters['tag-urlname']); if ($f8ce4b)$parameters['_tagrec']=$f8ce4b; $parameters['tag']=$parameters['_tagrec']['Keyword']; } } return$parameters; } function e2_keywords(){ global $n2e5d8; t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Keywords`" ); $t59aeb=t0d6b(); t0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $n2e5d8['db']['table_prefix']."NotesKeywords` nk, ". "`". $n2e5d8['db']['table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". (qe852()? "":"AND n.IsVisible=1 " ). "GROUP BY nk.KeywordID" ); $i0c6dc=t0d6b(); return array ('keywords' => $t59aeb,'ordering_info' => $i0c6dc); } function vaf16($z07f25){ global $n2e5d8,$l097cc,$_current_tag; $c9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $c9df9d=@unserialize(ocdf0(CACHE_FILENAME_FAVTAGS)); } if (!is_array($c9df9d)) { t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`" ); $t9cdff=t0d6b(); $c9df9d=array(); foreach ($t9cdff as $s04ff0){ $zc6827['tag']=htmlspecialchars($s04ff0['Keyword'],ENT_NOQUOTES); $zc6827['href']=f83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => $zc6827['tag']) : array ('tag-urlname' => $s04ff0['URLName']) ); $c9df9d[] = $zc6827; } if(CACHE_FAVTAGS)k6e52(CACHE_FILENAME_FAVTAGS,serialize($c9df9d)); } $y8a4f1=false; foreach ($c9df9d as $f8ce4b => $x9e366){ $c9df9d[$f8ce4b]['current?'] = ( $c9df9d[$f8ce4b]['tag']==$_current_tag ); if ($c9df9d[$f8ce4b]['current?']) { $y8a4f1=true; $e08187=$z07f25; $e08187['flag']='IsFavourite'; $e08187['value']=0; if (qe852()) { $c9df9d[$f8ce4b]['pinnable?']=true; $c9df9d[$f8ce4b]['pinned?']=true; $c9df9d[$f8ce4b]['pinned-toggle-href'] = ( f83c8('e2m_tag_flag_ajax',$e08187) ); } } } if (qe852()) { if (!$y8a4f1 and array_key_exists('_tagrec',$z07f25)) { $ea55a9=$z07f25; $ea55a9['flag']='IsFavourite'; $ea55a9['value']=1; $sd5a7a=array ( 'tag' => htmlspecialchars($z07f25['_tagrec']['Keyword'],ENT_NOQUOTES), 'href' => f83c8('e2m_tag',$z07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => f83c8('e2m_tag_flag_ajax',$ea55a9), ); $c9df9d[] = $sd5a7a; } } return $c9df9d; } function wce23($s21158,$parameters=''){ global $n2e5d8; $f0dff3=array(); if (t0738( "SELECT `". $n2e5d8['db']['table_prefix']."Keywords`.* ". "FROM `". $n2e5d8['db']['table_prefix']."Keywords`, ". "`". $n2e5d8['db']['table_prefix']."NotesKeywords` ". "WHERE `". $n2e5d8['db']['table_prefix']."NotesKeywords`.NoteID=". ((int)$s21158) ." ". "AND `". $n2e5d8['db']['table_prefix']."Keywords`.ID=`". $n2e5d8['db']['table_prefix']."NotesKeywords`.KeywordID" )) { $f0dff3=t0d6b(); } return $f0dff3; } function e93c2($leaa60){ global $n2e5d8; $a316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $h06e3d) if(array_key_exists($h06e3d,$leaa60)) { $w6a7f2[] = '`'. $h06e3d .'`'."='". h7928($leaa60[$h06e3d]) ."'"; if ($h06e3d=='ID')$l729d6='tagbinging-id'; if ($h06e3d=='NoteID')$l729d6='tagbinging-note-id'; if ($h06e3d=='KeywordID')$l729d6='tagbinging-tag-id'; $a316e8[$l729d6]=$leaa60[$h06e3d]; } $t1b1cc=( "DELETE FROM `". $n2e5d8['db']['table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$w6a7f2) ); if (t0738($t1b1cc)) { return true; } } function ycbd4($leaa60){ global $n2e5d8; if (!array_key_exists('ID',$leaa60) or !is_numeric($leaa60['ID'])) { die ('API MISUSE: e2q_update_tagbinding must be called with an ID field in $tagbinding_record'); } $w6a7f2=array(); foreach (array ( 'NoteID', 'KeywordID', ) as $h06e3d) if(array_key_exists($h06e3d,$leaa60)) { $w6a7f2[] = '`'. $h06e3d .'`'."='". h7928($leaa60[$h06e3d]) ."'"; } if(count($w6a7f2) > 0){ $t1b1cc = "UPDATE `". $n2e5d8['db']['table_prefix']."NotesKeywords` ". "SET ". implode(', ',$w6a7f2) ." ". "WHERE `ID`=". $leaa60['ID']; if (t0738($t1b1cc)) { return true; } } } function d478d( $dd7df5,$td7ca3,$n71883,$x67daf,$s8b087 ){ global $n2e5d8; $e444bc=t0738( "INSERT INTO `". $n2e5d8['db']['table_prefix']."Keywords` (". "`Keyword`, `URLName`, `ParentKeywordID`, `Description`, `IsFavourite`". ") VALUES (". "'". h7928($dd7df5) ."', ". "'". h7928($td7ca3) ."', ". "'". h7928($n71883) ."', ". "'". h7928($x67daf) ."', ". "'".((int)$s8b087)."' ". ")" ); if ($e444bc){ return mysql_insert_id(); } else { return false; } } function e9298( $dd7df5, $td7ca3='', $n71883=0, $x67daf='', $s8b087=false ){ $ye8c6e=$dd7df5; $bea599=$dd7df5; $xce0b4=2; while (j0188($dd7df5)) { $dd7df5=$bea599 .' ('. ($xce0b4 ++) .')'; } if ($dd7df5!=$ye8c6e){ d8a40( 'Тег &laquo;'. $ye8c6e .'&raquo; уже есть, '. 'поэтому был создан тег &laquo;'. $dd7df5 .'&raquo;' ); } if(strstr($dd7df5,',') or strstr($dd7df5,'/')) { $dd7df5=str_replace(',','-',$dd7df5); $dd7df5=str_replace('/','-',$dd7df5); d8a40( 'Тег не может содержать символов &laquo;,&raquo; и &laquo;/&raquo;, '. 'т.к. они используются как разделители в списке '. 'и иерархии. Неправильные символы заменены на дефисы.' ); } $abb832=$td7ca3; if (''==$td7ca3){ $td7ca3=qec0d($dd7df5); } if (!v01d3($td7ca3)) { $td7ca3=qec0d($dd7df5); $lc0fe7=true; d8a40( 'Такой вид в адресной строке не может быть использован. '. 'Корректный вид сгенерирован автоматически.' ); } $r6274a=$td7ca3; $eefa7d=2; while (u812d($td7ca3)) { $td7ca3=$r6274a .'-'. ($eefa7d ++); } if ($abb832 and !$lc0fe7 and $td7ca3!=$abb832){ d8a40( 'Тег с видом в адресной строке &laquo;'. $abb832 .'&raquo; уже есть, '. 'поэтому вид в адресной строке будет &laquo;'. $td7ca3.'&raquo;' ); } $eb80bb=d478d( $dd7df5, $td7ca3, $n71883, $x67daf, $s8b087 ); return $eb80bb; } function qec0d($mb45cf){ $mb45cf=strtr($mb45cf, array ( 'а' => 'a', 'б' => 'b', 'в' => 'v', 'г' => 'g', 'д' => 'd', 'е' => 'e', 'ё' => 'yo', 'ж' => 'zh', 'з' => 'z', 'и' => 'i', 'й' => 'y', 'к' => 'k', 'л' => 'l', 'м' => 'm', 'н' => 'n', 'о' => 'o', 'п' => 'p', 'р' => 'r', 'с' => 's', 'т' => 't', 'у' => 'u', 'ф' => 'f', 'х' => 'kh', 'ц' => 'ts', 'ч' => 'ch', 'ш' => 'sh', 'щ' => 'sch', 'ъ' => '', 'ы' => 'y', 'ь' => '', 'э' => 'e', 'ю' => 'yu', 'я' => 'ya', 'А' => 'A', 'Б' => 'B', 'В' => 'V', 'Г' => 'G', 'Д' => 'D', 'Е' => 'E', 'Ё' => 'Yo', 'Ж' => 'Zh', 'З' => 'Z', 'И' => 'I', 'Й' => 'Y', 'К' => 'K', 'Л' => 'L', 'М' => 'M', 'Н' => 'N', 'О' => 'O', 'П' => 'P', 'Р' => 'R', 'С' => 'S', 'Т' => 'T', 'У' => 'U', 'Ф' => 'F', 'Х' => 'Kh', 'Ц' => 'Ts', 'Ч' => 'Ch', 'Ш' => 'Sh', 'Щ' => 'Sch', 'Ъ' => '', 'Ы' => 'Y', 'Ь' => '', 'Э' => 'E', 'Ю' => 'Yu', 'Я' => 'Ya', ' ' => '-', '/' => '-', '<' => '-', '>' => '-', '.' => '-', ',' => '-', ':' => '-', '"' => '\'\'', '&' => '-and-', )); $mb45cf=preg_replace('/\-+/','-',$mb45cf); $mb45cf=preg_replace('/[^a-z0-9-\']*/i','',$mb45cf); $mb45cf=strtolower($mb45cf); if(__LOG)__log('Gen urlname'); $result=$mb45cf; $mb1bc2='2'; while (u812d($result)!==false){ $result=$mb45cf .'-'. $mb1bc2; ++ $mb1bc2; } return$result; } function u3873($zda3ad='Keyword'){ global $n2e5d8; if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Keywords` ORDER BY `".$zda3ad."`") ) { $pfa816=t0d6b(); } else { $pfa816=array(); } $t59aeb=array(); foreach ($pfa816 as $pe358e)$t59aeb[] = $pe358e; return $t59aeb; } function qa463($s21158,$zda3ad='Keyword'){ global $n2e5d8; if (t0738( "SELECT `". $n2e5d8['db']['table_prefix']."Keywords`.* ". "FROM `". $n2e5d8['db']['table_prefix']."Keywords`, ". "`". $n2e5d8['db']['table_prefix']."NotesKeywords` ". "WHERE `". $n2e5d8['db']['table_prefix']."NotesKeywords`.NoteID=".((int)$s21158)." AND ". "`". $n2e5d8['db']['table_prefix']."Keywords`.ID=". "`". $n2e5d8['db']['table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `".$zda3ad."`" ))$pfa816=t0d6b(); else $pfa816=array(); $t59aeb=array(); foreach ($pfa816 as $pe358e)$t59aeb[] = $pe358e; return $t59aeb; } function d7d5e($dd7df5){ global $n2e5d8; if (t0738( "SELECT `URLName` FROM `". $n2e5d8['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".h7928($dd7df5)."'" )) $pfa816=t0d6b(); else $pfa816=array(); if (isset ($pfa816[0]['URLName'])) return $pfa816[0]['URLName']; else return false; } function j0188($dd7df5){ global $n2e5d8; if (($t5b0b7=strrpos($dd7df5,'/')) !== FALSE) $dd7df5=substr($dd7df5,$t5b0b7+1); if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".h7928($dd7df5)."'" )) { $f8ce4b=t0d6b(); if (isset ($f8ce4b[0])) return $f8ce4b[0]; } return NULL; } function u812d($td7ca3){ global $n2e5d8; $w6a7f2=explode('/',trim($td7ca3,'/')); $ub17d0=array_pop($w6a7f2); if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Keywords` ". "WHERE `URLName`='".h7928($ub17d0)."'" )) $pfa816=t0d6b(); else $pfa816=array(); if (isset ($pfa816[0])) return $pfa816[0]; else return FALSE; } function h4e28($eb80bb){ global $n2e5d8; if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Keywords` ". "WHERE `ID`='".((int)$eb80bb)."'" )) { $f8ce4b=t0d6b(); if (isset ($f8ce4b[0])) { $f8ce4b=$f8ce4b[0]; return $f8ce4b; } else { return NULL; } } return NULL; } function e2m_comment($parameters=array ()) { e2_go_to(f83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return c4fb7('edit',$parameters); } function e2m_note_comment($parameters=array ()) { return c4fb7('write',$parameters); } function c4fb7($u60cd8,$parameters=array ()) { global$_strings,$kf97aa,$n2e5d8; if (!@$n2e5d8['comments']['on']) { return e2_error404_mode(); } $ud5d3d=$lf74f5=$_strings['pt--new-comment']; $z69b97='new'; if ($u60cd8=='edit'){ $w4032b=e2_commentrec_with_parameters_($parameters); $tc50d0=$_strings['fb--save-changes']; $z39a37=$w4032b['noterec']; $ud5d3d=$lf74f5=$_strings['pt--edit-comment']; $z69b97=$maca8d['ID']; if (!$w4032b){ return e2_error404_mode(); } $n80f02=array ( '.note-id' => $w4032b['NoteID'], '.comment-id' => $w4032b['ID'], '.already-subscribed?' => false, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($kf97aa)+1), 'create:edit?' => false, 'form-action' => f83c8('e2s_comment_process'), 'submit-text' => $tc50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$w4032b['IsSubscriber'], 'name' => htmlspecialchars($w4032b['AuthorName']), 'email' => htmlspecialchars($w4032b['AuthorEmail']), 'text' => htmlspecialchars($w4032b['Text'],ENT_NOQUOTES), 'email-field-name' => 'elton-john', ); } else { $z39a37=e2_published_noterec_with_parameters_($parameters); $n80f02=y66aa($z39a37); } return array ( 'title' => $ud5d3d, 'heading' => $lf74f5, 'form' => 'form-comment', 'form-comment' => $n80f02, ); } function e2m_comment_reply($parameters=array ()) { global$_strings,$n2e5d8; if (!@$n2e5d8['comments']['on']) return e2_error404_mode(); $w4032b=e2_commentrec_with_parameters_($parameters); if (!$w4032b){ return e2_error404_mode(); } $z39a37=$w4032b['noterec']; $r1aec6=g86f8($z39a37,$w4032b,$parameters['comment-number']); $r1aec6['_']['_id']=$w4032b['ID']; $r1aec6['_']['_ord']=0; $r1aec6['_']['_ord_max']=0; $r1aec6['replying?'] = (bool)true; $r817c7=($w4032b['Reply']=='' or !$w4032b['IsReplyVisible']); $ud5d3d=$r817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $j4dc70=array ( '.note-id' => $z39a37['ID'], '.comment-id' => $w4032b['ID'], '.reply-action' => $r817c7? 'new':'edit', 'form-action' => f83c8('e2s_comment_edit_reply'), 'submit-text' => $r817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($r817c7), 'reply-text' => htmlspecialchars($w4032b['Reply'],ENT_NOQUOTES), 'mail-back?' => (bool) ($r817c7), ); return array ( 'title' => $ud5d3d, 'heading' => $ud5d3d, 'comments' => array ('only' => $r1aec6), 'form' => 'form-comment-reply', 'form-comment-reply' => $j4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$n2e5d8,$gcbcce; if (!@$n2e5d8['comments']['on']) return e2_error404_mode(); $w4032b=e2_commentrec_with_parameters_($parameters); $s21158=$w4032b['NoteID']; if (!$w4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($s21158); if (t0738( "DELETE FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `ID` = '".((int)$w4032b['ID'])."'" )) { @unlink(USER_FOLDER. '/last-comment.psa'); } else { d8a40($_strings['er--error-removing-comment']); } f4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$n2e5d8; if (!@$n2e5d8['comments']['on']) return e2_error404_mode(); $w4032b=e2_commentrec_with_parameters_($parameters); if (!$w4032b){ return e2_error404_mode(); } if (t0738( "UPDATE `". $n2e5d8['db']['table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$w4032b['ID']) )) { } else { d8a40($_strings['er--error-removing-comment-reply']); } f4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$n2e5d8; $y70a17="ORDER BY `ID` DESC"; $z39a37=e2_published_noterec_with_parameters_($parameters); $s21158=$z39a37['ID']; $z0c83f=$parameters['unsubscribe-email']; $d1bc29=$parameters['unsubscribe-key']; $z0c83f=str_replace(' ','+',$z0c83f); if ($s21158){ if (t0738( "SELECT `ID`, `Stamp` FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". $s21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $z0c83f ."' ". $y70a17 )) { $result=t0d6b(); if(count($result) < 1) { $s2cb9d['unsubscription-status']['success?']=false; $s2cb9d['unsubscription-status']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $i06d4c=@$result[0]; $o97f69=md5($i06d4c['ID'].$i06d4c['Stamp'] .'x'); $x260ca=false; if ($d1bc29==$o97f69){ if (t0738( "UPDATE `". $n2e5d8['db']['table_prefix']."Comments` SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $s21158 ." AND `AuthorEmail` = '".h7928($z0c83f)."'" )) { $x260ca=true; $s2cb9d['unsubscription-status']['success?']=true; $s2cb9d['unsubscription-status']['note-title']=u6f10( htmlspecialchars(oea9c($z39a37),ENT_NOQUOTES) ); $s2cb9d['unsubscription-status']['note-href']=f83c8( 'e2m_note', array ('*note' => $z39a37) ); } } if (!$x260ca){ $s2cb9d['unsubscription-status']['success?']=false; $s2cb9d['unsubscription-status']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $s2cb9d['unsubscription-status']['success?']=false; $s2cb9d['unsubscription-status']['error-message']=$_strings['gs--comment-not-found']; } } else { $s2cb9d['unsubscription-status']['success?']=false; $s2cb9d['unsubscription-status']['error-message']=$_strings['gs--post-not-found']; } return $s2cb9d; } function e2m_comment_flag($parameters){ b6e30($parameters); e2_go_to(f83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ if (b6e30($parameters)) { $p67142=$parameters; $p67142['value'] = !$parameters['value']; if($parameters['value']==1){ $q99859=f83c8('e2m_comment_flag_ajax',$p67142); $f1fa03='on-rehref|'. $q99859; } else { $q99859=f83c8('e2m_comment_flag_ajax',$p67142); $f1fa03='off-rehref|'. $q99859; } } else { $f1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($f1fa03); } else { e2_go_to(f83c8('e2m_note',$parameters)); die; } } function b6e30($parameters){ $w4032b=e2_commentrec_with_parameters_($parameters); $s21158=$w4032b['NoteID']; $result=false; if ($w4032b){ $result=baa79('Comments', array ( 'ID' => $w4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($s21158); } return$result; } function e2s_comment_process(){ global$_strings,$n2e5d8,$_fp_error; list ($s21158,$z69b97,$f9d090)=d1a90(); if (!$z69b97){ $i05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ d8a40($_strings['er--post-not-commentable']); } elseif($_fp_error==FP_EMPTY_FIELD){ d8a40($_strings['er--name-email-text-required']); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $qaa731=$_strings['gs--comment-too-long']; $i05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $qaa731=$_strings['gs--comment-double-post']; $i05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $qaa731=$_strings['gs--comment-spam-suspect']; $i05c36=$_strings['gs--comment-spam-suspect-description']; } else { d8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($i05c36){ $s2cb9d['title']=$qaa731; $s2cb9d['heading']=$qaa731; $s2cb9d['form']='form-unaccepted-comment'; $s2cb9d['form-unaccepted-comment'] = array ( 'reason' => $i05c36, 'text' => @htmlspecialchars($f9d090['text'],ENT_NOQUOTES), ); return $s2cb9d; } } e2_go_to(f83c8('e2m_note', array ('*note' => m4627($s21158)))); die; } function e2s_comment_edit_reply(){ global$_strings,$n2e5d8,$p57de2; $ee84af=@$_POST['text']; if(trim($ee84af)=='')$ee84af=''; $s21158=@$_POST['note-id']; $xaad65=m4627($s21158); $z69b97=@$_POST['comment-id']; $i06d4c=rb559($z69b97); $n54eb6=isset ($_POST['mail-back']); $i54fa9=time(); if(preg_match('//u',$ee84af))$ee84af=wedd9($ee84af,true); if (@$_POST['reply-action']=='new'){ $me0e30=time(); } @unlink(e2_note_cache_filename_with_id_($s21158 .'-comments')); if ($i06d4c and t0738( "UPDATE `". $n2e5d8['db']['table_prefix']."Comments` SET ". "`Reply`='". h7928($ee84af) ."', ". ( isset ($me0e30)? ( "`ReplyStamp`='". $me0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $i54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$z69b97) )) { $td58c0=f83c8('e2m_note', array ('*note' => $xaad65)); if ($n54eb6 and $ee84af!=''){ $zc6827['comment-time'] = array ($i06d4c['Stamp'],e2_current_timezone()); $zc6827['commenter']=$i06d4c['AuthorName']; $zc6827['commenter-email']=$i06d4c['AuthorEmail']; $zc6827['comment-text']=$i06d4c['Text']; $zc6827['note-title']=u6f10(oea9c($xaad65)); $zc6827['reply-time'] = array (time(),e2_current_timezone()); $zc6827['blog-author']=r2640(); $zc6827['note-href']=$td58c0; $zc6827['comment-href']=$td58c0; $zc6827['reply-text']=$ee84af; if(1){ list ($nb904c,$gde7a3)=df8c7( 'comment-reply',$zc6827 ); $o77613=$i06d4c['AuthorEmail']; $l1a49b='From: '. laed2(); aa41b($o77613,$nb904c,$gde7a3,$l1a49b); } if(1){ unset ($zc6827['commenter-email']); $l1a49b='From: '. laed2(); foreach (c4975($xaad65,$i06d4c['AuthorEmail']) as $g39c63){ $aba570=$g39c63['AuthorEmail']; $c6fd85=md5($g39c63['ID'].$g39c63['Stamp'].'x'); $zc6827['unsubscribe-href']=f83c8('e2m_unsubscribe', array ( '*note' => $xaad65, 'unsubscribe-email' => $aba570, 'unsubscribe-key' => $c6fd85, ) ); $o77613=$aba570; list ($nb904c,$gde7a3)=df8c7('comment-reply-to-public',$zc6827); aa41b($o77613,$nb904c,$gde7a3,$l1a49b); } } } e2_go_to($td58c0); die; } else { d8a40($_strings['er--error-editing-comment-reply']); f4930(); die; } } function g86f8($xaad65,$i06d4c,$mb1bc2=false){ global $n2e5d8,$_config; if(__LOG)__log('Comments: package comment <'. $i06d4c['ID'] .'>...'); if ($xaad65===null){ $xaad65=m4627($i06d4c['NoteID']); } if ($mb1bc2!==false)$zc6827['number']=$mb1bc2; $zc6827['name']=htmlspecialchars($i06d4c['AuthorName']); if (qe852()) { $zc6827['email']=htmlspecialchars($i06d4c['AuthorEmail']); if (''!=trim($i06d4c['IP'])) { $zc6827['ip']=$i06d4c['IP']; $zc6827['ip-href']=$_config['whois_service'].$zc6827['ip']; } } $zc6827['author-name']=r2640(); $zc6827['visible?'] = (bool)$i06d4c['IsVisible']; $zc6827['important?'] = (bool)$i06d4c['IsFavourite']; $zc6827['reply-visible?'] = (bool) ($i06d4c['IsVisible'] && $i06d4c['IsReplyVisible']); $zc6827['reply-important?'] = (bool)$i06d4c['IsReplyFavourite']; $zc6827['spam-suspect?'] = (bool)$i06d4c['IsSpamSuspect']; $k10a7e=array ((int)$i06d4c['Stamp'],e2_note_timezone($xaad65)); $zc6827['time']=$k10a7e; $zc6827['last-modified']=$k10a7e; if ($i06d4c['LastModified']) $zc6827['last-modified'] = array ((int)$i06d4c['LastModified'],e2_note_timezone($xaad65)); if ($i06d4c['ReplyStamp']) $zc6827['reply-time'] = array ((int)$i06d4c['ReplyStamp'],e2_note_timezone($xaad65)); if ($i06d4c['ReplyLastModified']) $zc6827['reply-last-modified'] = array ((int)$i06d4c['ReplyLastModified'],e2_note_timezone($xaad65)); if (qe852()) { $zc6827['subscriber?'] = (bool)$i06d4c['IsSubscriber']; $zc6827['new?'] = (bool)$i06d4c['IsNew']; $zc6827['first-new?']=false; if ($i06d4c['IsFavourite']) { $zc6827['important-toggle-href']=f83c8( 'e2m_comment_flag_ajax', array ('*note' => $xaad65,'comment-number' => $mb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $zc6827['important-toggle-href']=f83c8( 'e2m_comment_flag_ajax', array ('*note' => $xaad65,'comment-number' => $mb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($i06d4c['IsReplyFavourite']) { $zc6827['reply-important-toggle-href']=f83c8( 'e2m_comment_flag_ajax', array ( '*note' => $xaad65,'comment-number' => $mb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $zc6827['reply-important-toggle-href']=f83c8( 'e2m_comment_flag_ajax', array ( '*note' => $xaad65,'comment-number' => $mb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $zc6827['edit-href']=f83c8( 'e2m_comment_edit', array ('*note' => $xaad65,'comment-number' => $mb1bc2) ); $zc6827['removed-toggle-href']=f83c8( 'e2m_comment_flag_ajax', array ( '*note' => $xaad65,'comment-number' => $mb1bc2, 'flag' => 'IsVisible','value' => !$i06d4c['IsVisible'] ) ); $zc6827['removed-reply-toggle-href']=f83c8( 'e2m_comment_flag_ajax', array ( '*note' => $xaad65,'comment-number' => $mb1bc2, 'flag' => 'IsReplyVisible','value' => !$i06d4c['IsReplyVisible'] ) ); $ue36ef=f83c8( 'e2m_comment_reply', array ('*note' => $xaad65,'comment-number' => $mb1bc2) ); if ($i06d4c['Reply']=='' or !$i06d4c['IsReplyVisible']) { $zc6827['reply-href']=$ue36ef; } else { $zc6827['edit-reply-href']=$ue36ef; } } $zc6827['text']=r154e($xaad65['FormatterID'],$i06d4c['Text'],'simple'); if ($i06d4c['IsSpamSuspect']) { $zc6827['text']=preg_replace('/\< *a +href *= *\".*?\".*?\>/is','',$zc6827['text']); $zc6827['text']=preg_replace('/\< *\/ *a *\>/is','',$zc6827['text']); $zc6827['text']=str_replace('http://','',$zc6827['text']); } $zc6827['replying?'] = (bool)false; $zc6827['replied?'] = (bool) ( (trim($i06d4c['Reply']) != '') && ($i06d4c['IsReplyVisible']) ); $zc6827['reply']=r154e($xaad65['FormatterID'],$i06d4c['Reply'],'full'); if(array_key_exists('_',$i06d4c))$zc6827['_']=$i06d4c['_']; if(__LOG)__log('Comments: done'); return $zc6827; } function rb559($eb80bb){ global $n2e5d8; if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `ID` = '".$eb80bb."'" )) { $pfa816=t0d6b(); if(count($pfa816) > 0) return $pfa816[0]; } return false; } function re5b6($z0604c){ e2_comment_set_flag('IsVisible',$z0604c); } function i3183($k0dd2c){ e2_comment_set_flag('IsReplyVisible',$k0dd2c); } function y66aa($xaad65){ global$_strings; $he3cb9=@$_COOKIE[w8c3b('commenter_name')]; $of92ee=@$_COOKIE[w8c3b('commenter_email')]; $c3d682=@$_COOKIE[w8c3b('commenter_ph')]; $r92399=false; if ($of92ee and cookie_unsubscribe_key){ foreach (c4975($xaad65) as $g39c63){ $o97f69=md5($g39c63['ID'].$g39c63['Stamp'] .'x'); if ( $g39c63['AuthorEmail']==$of92ee and $c3d682==$o97f69 ){ $r92399=true; break; } } } $tc50d0=$_strings['fb--submit']; $n80f02=array ( '.note-id' => $xaad65['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$r92399, 'create:edit?' => true, 'form-action' => f83c8('e2s_comment_process'), 'submit-text' => $tc50d0, 'show-subscribe?' => (bool) !$r92399, 'subscribe?' => (bool)$r92399, 'subscription-status' => $r92399? $_strings['gs--you-are-already-subscribed']:'', 'visible?' => true, 'email-field-name' => 'elton-john', 'name' => htmlspecialchars($he3cb9), 'email' => htmlspecialchars($of92ee), 'text' => htmlspecialchars($i06d4c['Text'],ENT_NOQUOTES), ); return $n80f02; } function l254f($s21158,$vdaf19=0){ global $n2e5d8; if (!$vdaf19)$if79b1=' AND `IsVisible`=1'; if ('all'===$vdaf19){ $if79b1=''; } if ('new'===$vdaf19){ $if79b1=' AND `IsNew`=1'; } $abc751=0; if (t0738( "SELECT count(*) FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$s21158 . @$if79b1 )) { $result=t0d6b(); $result=(int)$result[0]['count(*)']; $abc751=$result; } return (int)$abc751; } function h2a6b(){ global $n2e5d8; $ue2942=0; $j7ec7e=''; $se8fab=''; if (t0738( "SELECT `NoteID`, `Text` FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`" )) { $result=t0d6b(); $ue2942=count($result); $j7ec7e=array(); foreach($result as $jf1965){ $j7ec7e[] = strip_tags(ib7f1(str_replace("\n",' ',$jf1965['Text']), 'simple')); } $j7ec7e=implode(' &bull; ',$j7ec7e); if(strlen($j7ec7e) > 512){ $j7ec7e=substr($j7ec7e,0,509). '...'; } if ($ue2942){ $s21158=$result[0]['NoteID']; $se8fab=f83c8( 'e2m_note', array ('*note' => m4627($s21158)) ); } else { $se8fab=''; } } return array ((int)$ue2942,$j7ec7e,$se8fab); } function b1baf($s21158,$y641f6){ global $n2e5d8; if(__LOG)__log('Comments: getting comments for note '. $s21158); if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$s21158." ". @$if79b1 ." ". $y641f6 )) { $result=t0d6b(); return$result; } return array (); } function c4975($xaad65,$zd1cc6=''){ global $n2e5d8; $y70a17="ORDER BY `ID` DESC"; $s2cb9d=$saf67c=array(); if (t0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `NoteID`=". @$xaad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". mysql_escape_string($zd1cc6) ."' ". $y70a17 )) { $result=t0d6b(); foreach($result as $g39c63){ if (!in_array($g39c63['AuthorEmail'],$saf67c)) { $s2cb9d[] = $g39c63; } $saf67c[] = $g39c63['AuthorEmail']; } } return $s2cb9d; } function ub387($xaad65,$l3f917=NOTE_COMMENTABLE_NOW){ global $n2e5d8,$_config; $o61f40=$n2e5d8['comments']['on']; $l8f888=$xaad65['IsPublished']; $ebdb20=true; if (@$n2e5d8['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($xaad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $ebdb20=false; $fc770a=$xaad65['IsCommentable']; if ($l3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $fc770a=true; } $j825ff=$xaad65['IsVisible']; return $o61f40 and $l8f888 and $ebdb20 and $fc770a and $j825ff; } function e2_commentrec_with_parameters_($parameters=array ()) { $z39a37=e2_published_noterec_with_parameters_($parameters); $ia5d49=b1baf($z39a37['ID'],"ORDER BY `Stamp`"); $w4032b=@$ia5d49[$parameters['comment-number']-1]; if ($w4032b){ $w4032b['noterec']=$z39a37; return $w4032b; } } function d1a90($q98ea6=''){ global $n2e5d8,$gcbcce,$_config,$_fp_error; $_fp_error=false; $bbe16c='elton-john'; $s21158=$z69b97=$qb0689=$z0c83f=$p1cb25=''; if(array_key_exists('note-id',$_POST)) $s21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $z69b97=trim(@$_POST['comment-id']); if(array_key_exists('name',$_POST)) $qb0689=trim(@$_POST['name']); if(array_key_exists($bbe16c,$_POST)) $z0c83f=trim(@$_POST[$bbe16c]); if(array_key_exists('text',$_POST)) $p1cb25=trim(@$_POST['text']); $e07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $f20612=time(); if(preg_match('//u',$qb0689))$qb0689=wedd9($qb0689,false); if(preg_match('//u',$z0c83f))$z0c83f=wedd9($z0c83f,false); if(preg_match('//u',$p1cb25))$p1cb25=wedd9($p1cb25,true); $f9d090['text']=$p1cb25; if ($z69b97=='new'){ gc64a('commenter_name',$qb0689); gc64a('commenter_email',$z0c83f); } $j848b5=( $z69b97=='new' and (array_key_exists('email',$_POST) and $_POST['email']!='') ); $rc2b1a=1; $result=false; if (!$z69b97){ $_fp_error=FP_NO_ID_OR_NEW; } else { if ($z69b97 and $qb0689=='' or $z0c83f=='' or $p1cb25==''){ $_fp_error=FP_EMPTY_FIELD; } if ($z69b97=='new'){ $s795f1=@unserialize(ocdf0(USER_FOLDER. '/last-comment.psa')); if(md5($qb0689.$z0c83f.$p1cb25)==$s795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ) { $_fp_error=FP_COMMENT_TOO_LONG; } if ($z69b97=='new' and !ub387(m4627($s21158))) { $_fp_error=FP_NOT_COMMENTABLE; } if ($j848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($s21158); if ($z69b97=='new'){ $w4032b=array ( 'NoteID' => (int)$s21158, 'AuthorName' => h7928($qb0689), 'AuthorEmail' => h7928($z0c83f), 'Text' => h7928($p1cb25), 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$e07d3d, 'IsSpamSuspect' => (int)$j848b5, 'IsNew' => (int)$rc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => h7928($_SERVER['REMOTE_ADDR']), ); if (($w4032b=n9943('Comments',$w4032b)) !== false){ $z69b97=$w4032b['ID']; $s795f1=array ( 'id' => $z69b97, 'md5' => md5($qb0689.$z0c83f.$p1cb25), ); k6e52(USER_FOLDER. '/last-comment.psa',serialize($s795f1)); $result=(int)$z69b97; $q303ee=md5($w4032b['ID'].$w4032b['Stamp'].'x'); gc64a('commenter_ph',$q303ee); $g60422=l254f($s21158,'all')-1+1; $xaad65=m4627($s21158); $td58c0=f83c8('e2m_note', array ('*note' => $xaad65)); $zc6827['comment-time'] = array ($f20612,e2_current_timezone()); $zc6827['commenter']=$qb0689; $zc6827['commenter-email']=$z0c83f; $zc6827['comment-text']=$p1cb25; $zc6827['note-title']=oea9c($xaad65); $zc6827['note-href']=$td58c0; $zc6827['comment-href']=$td58c0; $zc6827['comments-disable-href']=f83c8('e2m_note_flag', array ( '*note' => $xaad65, 'flag' => 'IsCommentable', 'value' => 0 )); $zc6827['reply-href']=f83c8( 'e2m_comment_reply', array ('*note' => $xaad65,'comment-number' => $g60422) ); if (isset ($n2e5d8['user']['email']) and @$n2e5d8['notifications']['new_comments']) { list ($nb904c,$gde7a3)=df8c7( 'comment-new-to-author',$zc6827 ); $o77613=$n2e5d8['user']['email']; $l1a49b = 'From: '. laed2() ."\r\n". 'Reply-to: '. $qb0689 .' <'. $z0c83f .">"; aa41b($o77613,$nb904c,$gde7a3,$l1a49b); } if (!$j848b5){ unset ($zc6827['commenter-email']); $l1a49b='From: '. laed2(); foreach (c4975($xaad65,$z0c83f) as $g39c63){ $aba570=$g39c63['AuthorEmail']; $c6fd85=md5($g39c63['ID'].$g39c63['Stamp'].'x'); $zc6827['unsubscribe-href']=f83c8('e2m_unsubscribe', array ( '*note' => $xaad65, 'unsubscribe-email' => $aba570, 'unsubscribe-key' => $c6fd85 ) ); $o77613=$aba570; list ($nb904c,$gde7a3)=df8c7('comment-new-to-public',$zc6827); aa41b($o77613,$nb904c,$gde7a3,$l1a49b); } } } else { $_fp_error=FP_INSERT_ERROR; } } else { $dfd6f3=array ( 'ID' => $z69b97, 'AuthorName' => $qb0689, 'AuthorEmail' => $z0c83f, 'Text' => $p1cb25, 'IsSubscriber' => ((int)$e07d3d), 'LastModified' => time(), ); if (baa79('Comments',$dfd6f3)) { $result=(int)$z69b97; } else { $_fp_error=FP_UPDATE_ERROR; }; } } if ($q98ea6=='ajaxresult') return $f1fa03; else return array ((int)$s21158,$result,$f9d090); } function e2m_most_commented(){ global $n2e5d8,$_config; $xa0acf=@$_GET['period']; if ($xa0acf=='')$xa0acf=$_config['hot_period']; $g632a2=time()-w35c3($xa0acf); $if79b1="AND `IsVisible`=1 "; if (qe852())$if79b1=''; return gd864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE (`Stamp` > ". $g632a2.") ". $if79b1. "GROUP BY `NoteID` ". "ORDER BY c ". "DESC ". "LIMIT ".$n2e5d8['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $n2e5d8['appearance']['notes_per_page'], 'class' => 'most-commented', 'title' => 'Самые комментируемые за '. j54aa($xa0acf), 'heading' => 'Самые комментируемые за '. j54aa($xa0acf), 'no-notes-text' => 'Таких заметок нет.', )); } function e2m_favourites($parameters=array ()) { global $n2e5d8; $if79b1="AND `IsVisible`=1 "; if (qe852())$if79b1=''; return gd864(array ( 'query' => "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". $if79b1 . "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'class' => 'favourites', 'title' => 'Избранное', 'heading' => 'Избранное', 'no-notes-text' => 'Избранного нет.', )); } function w35c3($xa0acf){ if ('year'==$xa0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$xa0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$xa0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$xa0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function j54aa($xa0acf){ if ('year'==$xa0acf) return 'год'; elseif ('month'==$xa0acf) return 'месяц'; elseif ('week'==$xa0acf) return 'неделю'; elseif ('day'==$xa0acf) return 'день'; else return 'всю историю'; } function y09d1(){ global $n2e5d8,$l097cc,$_config; $xa0acf=$_config['hot_period']; if(__LOG)__log('Hot list: working...'); $oe919a=e7f78(); $ga44c0=null; if(CACHE_HOT and is_file(CACHE_FILENAME_HOT) and is_file(CACHE_FILENAME_HOT_EXPIRES)) { $ga44c0=@unserialize(ocdf0(CACHE_FILENAME_HOT)); $i85e91=(int) @ocdf0(CACHE_FILENAME_HOT_EXPIRES); } if(CACHE_HOT and is_array($ga44c0) and (time() < $i85e91)) { if(__LOG)__log('Hot list: retrieve cached ctree'); $bdbb0c=$ga44c0; } else { if(__LOG)__log('Hot list: assemle cacheable ctree...'); $g632a2=time()-w35c3($xa0acf); $o4358b=array(); if (t0738( "SELECT `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $n2e5d8['db']['table_prefix']."Comments` ". "WHERE `Stamp` > ". $g632a2 ." AND IsVisible='1'". "GROUP BY `NoteID` ". "ORDER BY c DESC LIMIT 10" )) { $result=t0d6b(); $bdbb0c=array(); foreach($result as $f8ce4b => $z39a37){ $z39a37=m4627($z39a37['ID']); if ($z39a37['IsVisible'] and $z39a37['IsPublished']) { $xaad65['_']['_id']=$z39a37['ID']; $xaad65['_']['_ord']=$f8ce4b; $xaad65['_']['_ord_max']=count($result)-1; $xaad65['href']=f83c8('e2m_note', array ('*note' => $z39a37)); $xaad65['time'] = array ($z39a37['Stamp'],e2_note_timezone($z39a37)); $xaad65['title']=u6f10(htmlspecialchars(oea9c($z39a37))); $bdbb0c[] = $xaad65; } } $ga44c0=$bdbb0c; if(CACHE_HOT){ k6e52(CACHE_FILENAME_HOT,serialize($ga44c0)); k6e52(CACHE_FILENAME_HOT_EXPIRES,time()+SECONDS_IN_A_DAY); } } } foreach ($bdbb0c as $f8ce4b => $x9e366){ $bdbb0c[$f8ce4b]['current?'] = ($bdbb0c[$f8ce4b]['href']==$l097cc); } if(__LOG)__log('Hot list: done in '. round(e7f78()-$oe919a,3)); return $bdbb0c; } function s3385(){ global $n2e5d8,$l097cc; if(__LOG)__log('Favourites list: working...'); $oe919a=e7f78(); $effbd2=null; if(CACHE_FAVS and is_file(CACHE_FILENAME_FAVS)) { $effbd2=@unserialize(ocdf0(CACHE_FILENAME_FAVS)); } if(CACHE_FAVS and is_array($effbd2)) { if(__LOG)__log('Favourites list: retrieve cached ctree'); $bdbb0c=$effbd2; } else { if(__LOG)__log('Favourites list: assemle cacheable ctree...'); $bdbb0c=array(); if (t0738( "SELECT `IsPublished`, `ID`, `Title`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 AND `IsVisible`=1 ". "ORDER BY `Stamp` DESC" )) { $result=t0d6b(); foreach($result as $f8ce4b => $z39a37){ $xaad65['_']['_id']=$z39a37['ID']; $xaad65['_']['_ord']=$f8ce4b; $xaad65['_']['_ord_max']=count($result)-1; $xaad65['href']=f83c8('e2m_note', array ('*note' => $z39a37)); $xaad65['time'] = array ($z39a37['Stamp'],e2_note_timezone($z39a37)); $xaad65['title']=u6f10(htmlspecialchars(oea9c($z39a37))); $bdbb0c[] = $xaad65; } $effbd2=$bdbb0c; if(CACHE_FAVS)k6e52(CACHE_FILENAME_FAVS,serialize($effbd2)); } } foreach ($bdbb0c as $f8ce4b => $x9e366){ $bdbb0c[$f8ce4b]['current?'] = ($bdbb0c[$f8ce4b]['href']==$l097cc); } if(__LOG)__log('Favourites list: done in '. round(e7f78()-$oe919a,3)); return $bdbb0c; } function e2m_password(){ global $n2e5d8; $s2cb9d['title']='Пароль'; $s2cb9d['heading']='Пароль для доступа к блогу'; $s2cb9d['form']='form-password'; $s2cb9d['form-password'] = array ( 'form-action' => f83c8('e2s_password_save'), 'submit-text' => 'Поменять', ); return $s2cb9d; } function e2m_sessions(){ global $n2e5d8; $s2d6d8=i7785(); $s2cb9d['title']='Открытые сессии'; $s2cb9d['heading']='Открытые сессии'; $t161bc=array(); $l3c6e0=$_COOKIE[w8c3b('key')]; foreach ($s2d6d8['sessions'] as $f8ce4b => $x9e366){ $t161bc[] = array ( 'current?' => j4c49($l3c6e0)==$x9e366['key_hash'], 'opened' => array ((int)$x9e366['stamp'],e2_no_timezone()), 'ip-address' => $x9e366['remote_ip'], 'source' => ($x9e366['remote_ip']=='127.0.0.1')? 'локально':$x9e366['remote_ip'], 'title' => jcc31($x9e366['ua']), 'user-agent' => $x9e366['ua']? $x9e366['ua']:'неизвестен', ); } $t161bc=array_reverse($t161bc); $s2cb9d['sessions']['each']=$t161bc; if(count($t161bc) > 1){ $s2cb9d['form']='form-sessions'; $s2cb9d['form-sessions'] = array ( 'form-action' => f83c8('e2s_drop_other_sessions'), 'submit-text' => 'Завершить все сессии кроме текущей', ); } return $s2cb9d; } function e2m_sign_in(){ if (qe852()) { e2_go_to(f83c8('e2m_frontpage')); } else { return array (); } } function e2m_sign_out(){ $s2d6d8=i7785(); $i48bb9=-1; if(array_key_exists('sessions',$s2d6d8) and is_array($s2d6d8['sessions'])) { foreach ($s2d6d8['sessions'] as $f8ce4b => $x9e366){ $l3c6e0=$_COOKIE[w8c3b('key')]; if (j4c49($l3c6e0)==$x9e366['key_hash']) { $i48bb9=$f8ce4b; break; } } } if ($i48bb9 > -1) unset ($s2d6d8['sessions'][$i48bb9]); g1d21($s2d6d8); gc64a('key',''); f4930(); die; } function e2s_password_save(){ global $n2e5d8; $e88162=trim($_POST['password']); if ( $e88162!='' and k6e52(USER_FOLDER. '/password-hash.psa',serialize(j4c49($e88162))) ) {; d8a40('Пароль изменён'); e2_go_to(); } else { d8a40('Не получилось изменить пароль'); e2_go_to(f83c8('e2m_password')); } die; } function e2s_sign_in_necessary(){ e2_go_to(f83c8('e2m_sign_in')); die; } function e2s_sign_in(){ $s2d6d8=i7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $a5f4dc=@$_POST['password']; $t6bc8e=@$_POST['is_public_pc']; } else { $a5f4dc=@$_GET['password']; $t6bc8e=false; } if (ga8cf($a5f4dc)) { $v21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => de8ed($t6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $s2d6d8['sessions'][] = $v21d6f; } elseif(strlen(trim($a5f4dc)) > 0){ d8a40('Неправильный пароль'); } g1d21($s2d6d8); f4930(); die; } function e2s_drop_other_sessions(){ $s2d6d8=i7785(); foreach ($s2d6d8['sessions'] as $f8ce4b => $x9e366){ $l3c6e0=$_COOKIE[w8c3b('key')]; if (j4c49($l3c6e0)==$x9e366['key_hash']) { $v21d6f=$x9e366; break; } } $s2d6d8['sessions'] = array ($v21d6f); g1d21($s2d6d8); f4930(); die; } function ga8cf($a5f4dc){ $z8e9a8=@unserialize(ocdf0(USER_FOLDER. '/password-hash.psa')); return (j4c49($a5f4dc)==$z8e9a8 and trim($a5f4dc)!=''); } function de8ed($o2a2a4=false){ global $n2e5d8; $l3c6e0=o2a24(); $w3f363=j4c49($l3c6e0); gc64a('key',$l3c6e0, !$o2a2a4); return $w3f363; } function qe852(){ global $u1c0b7,$n2e5d8,$_auth_sessions; if (isset ($u1c0b7)) return $u1c0b7; $u1c0b7=false; if (isset ($_COOKIE[w8c3b('key')])) { $l3c6e0=$_COOKIE[w8c3b('key')]; $s2d6d8=i7785(); $y0f83b=array(); if(array_key_exists('sessions',$s2d6d8) and is_array($s2d6d8['sessions'])) { foreach ($s2d6d8['sessions'] as $v21d6f){ $y0f83b[] = $v21d6f['key_hash']; } $_auth_sessions['count']=count($s2d6d8['sessions']); } if(1){ $u1c0b7=(bool)in_array(j4c49($l3c6e0),$y0f83b); } if (!$u1c0b7){ gc64a('key',''); } } return $u1c0b7; } function j4c49($u25d90){ if(function_exists('sha1')) { return sha1($u25d90); } else { return substr(md5($u25d90).md5(' '.$u25d90),0,40); } } function i7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $s2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($s2d6d8) return $s2d6d8; } return array (); } function g1d21($s2d6d8){ return vcd2d(USER_FOLDER.'auth.psa',serialize($s2d6d8)); } function eff2e(){ if ($l3c6e0=$_COOKIE[w8c3b('key')]) { return 'Cookie: '. w8c3b('key') .'='. $l3c6e0 ."\r\n"; } return ''; } function ye68c($ic48ba){ $u74546=array ( 'e2m_write' => 'написать заметку', 'e2m_note_edit' => 'править заметку', 'e2m_note_finetune' => 'настраивать эту заметку', 'e2m_note_withdraw' => 'отозвать эту заметку', 'e2m_comment_edit' => 'править этот комментарий', 'e2m_comment_reply' => 'ответить на этот комментарий', 'e2m_drafts' => 'открыть черновики', 'e2m_draft' => 'открыть этот черновик', 'e2m_tag_edit' => 'править этот тег', 'e2m_name_and_author' => 'изменять название блога', 'e2m_settings' => 'настраивать блог', 'e2m_password' => 'изменять параметры безопасности', 'e2m_database' => 'изменять параметры базы данных', 'e2m_sessions' => 'просматривать сессии', ); if(array_key_exists($ic48ba,$u74546)) { return 'Чтобы '. $u74546[$ic48ba] .',<br />зайдите под своим паролем'; } else { return 'Зайдите под своим паролем'; } } function jcc31($w5269f){ if(strstr($w5269f,'iPhone')) return 'Айфон'; if(strstr($w5269f,'iPad')) return 'Айпад'; if(strstr($w5269f,'Opera'))$s2cb9d='Опера'; if(strstr($w5269f,'Firefox'))$s2cb9d='Фаерфокс'; if(strstr($w5269f,'Chrome'))$s2cb9d='Хром'; if(strstr($w5269f,'Safari') and !strstr($w5269f,'Chrome'))$s2cb9d='Сафари'; if (!$s2cb9d)$s2cb9d='Неизв.'; if(strstr($w5269f,'Macintosh')) { if ($s2cb9d)$s2cb9d.=' на Маке'; } return $s2cb9d; } function e2j_check_password(){ $z8e9a8=@unserialize(ocdf0(USER_FOLDER. '/password-hash.psa')); $a5f4dc=''; if(array_key_exists('password',$_POST))$a5f4dc=$_POST['password']; if (j4c49($a5f4dc)==$z8e9a8 and trim($a5f4dc)!='') die ('password-correct'); die ('password-wrong'); } function o2a24(){ $qb04ec=''; $jb8d1b='0123456789abcdef'; for ($m865c0=0; $m865c0 < 40; $m865c0++)$qb04ec.=$jb8d1b{mt_rand(0,15)}; $qb04ec.=time(); $qb04ec=j4c49($qb04ec); return $qb04ec; } $_candies_installer=array ( 'e2s_build', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_frontpage', 'e2m_frontpage_rss', 'e2m_note', 'e2m_note_comment', 'e2m_note_comments_rss', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_sign_out', 'e2s_sign_in', 'e2s_comment_process', 'e2s_search', 'e2j_check_password', ); $_candies_sidebarable=array ( 'e2m_frontpage', 'e2m_note', 'e2m_tags', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', ); $_candies_spawning=array ( 'e2m_frontpage', 'e2m_note', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_write', 'e2m_drafts', 'e2m_draft', 'e2m_name_and_author', 'e2m_settings', 'e2m_password', 'e2m_database', 'e2m_timezone', 'e2m_sessions', 'e2m_update', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_unabortable=array ( ); $_candies_parents=array ( 'e2m_note' => 'e2m_tag', 'e2m_tag' => 'e2m_tags', ); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); define('E2_WEBSITE_HOST','blogengine.ru'); define('E2_WEBSITE','http://'. E2_WEBSITE_HOST .'/'); function e2_modes($parameters){ global $u11755,$content,$n2e5d8,$y1e2ad,$kf97aa,$s589b3,$_config,$s_addurl,$stopwatch,$_candy,$_db_error,$_candies_sidebarable; if (!is_array($parameters))$parameters=array(); if(array_key_exists('~',$parameters)) { $b71860=$parameters['~']; } $w45e8f='frontpage'; if(e2_is_installed()) { if(0){ if(__LOG)__log('Modes: archive years'); $tb2442=tcc02('start'); $z8dbc7=tcc02('end'); if (!($tb2442===false or $ad0dac===false)) { $ybaab5=e2_format_dt_of_timezone('Y',$z8dbc7['stamp'],$z8dbc7['timezone']); if($_candy!='e2m_year' or $ybaab5!=$content['year']) { $content['archive']['href']=f83c8('e2m_year', array ('year' => $ybaab5)); } $content['archive']['years'] = array (); for ($m865c0=e2_format_dt_of_timezone('Y',$tb2442['stamp'],$tb2442['timezone']); $m865c0 <= $ybaab5; ++ $m865c0){ $content['archive']['years'][] = array ( 'year' => $m865c0, 'href' => f83c8('e2m_year', array ('year' => $m865c0)), 'current?' => ((bool) ($content['year']==$m865c0) && ($_candy=='e2m_year')), ); } } } $content['content-page?']=false; if(in_array($_candy,$_candies_sidebarable)) { $content['content-page?']=true; if(__LOG)__log('Modes: favourites block'); $j8d029=s3385(); if(count($j8d029) > 0){ $content['favourites'] = array ( 'title' => 'Избранное', 'href' => f83c8('e2m_favourites'), ); if (@$n2e5d8['appearance']['favourites_frontpage']) { $content['favourites']['each']=$j8d029; } } if(__LOG)__log('Modes: hot block'); $r2888a=y09d1(); if(count($r2888a) > 0){ $content['most-commented'] = array ( 'title' => 'Обсуждаемое', 'href' => f83c8('e2m_most_commented'), ); if ((@$n2e5d8['appearance']['hot_frontpage'])) { $content['most-commented']['each']=$r2888a; } } if(__LOG)__log('Modes: tags block'); if(count(u3873()) > 0){ $content['tags-menu']['each']=vaf16($parameters); $content['tags-menu']['not-empty?']=count($content['tags-menu']['each']); } } if (qe852()) { $content['blog']['drafts-count'] = (int)z8ca0(false,true); $content['admin-hrefs'] = array ( 'new-note' => f83c8('e2m_write'), 'drafts' => f83c8('e2m_drafts'), 'name-and-author' => f83c8('e2m_name_and_author'), 'settings' => f83c8('e2m_settings'), 'password' => f83c8('e2m_password'), 'database' => f83c8('e2m_database'), 'timezone' => f83c8('e2m_timezone'), 'sessions' => f83c8('e2m_sessions'), 'update' => f83c8('e2m_update'), 'logout' => f83c8('e2m_sign_out'), ); } else { $content['form-login']['form-action']=f83c8('e2s_sign_in'); $content['form-login']['form-check-password-action']=f83c8('e2j_check_password'); $content['form-login']['login-name'] = @$n2e5d8['author']; $content['form-login']['public-pc?']=false; if(array_key_exists('_login_request_message',$content)) { $content['form-login']['request']=$content['_login_request_message']; } } } if (@$_config['request_logging']) { $d8fa14=fopen(USER_FOLDER. 'log-'. date('Y-m-d') .'.txt','a'); fwrite($d8fa14,date('d.m.Y H:i:s') ."\tT = ". $content['pgt'] ."\tQ = ". $content['total_queries'] ."\tIP = ". $_SERVER['REMOTE_ADDR'] ."\tRequest = ". $_SERVER['REQUEST_URI'] ."\r\n"); fclose($d8fa14); } } function t6f51(){ global $n2e5d8; if ( array_key_exists('site_title',$n2e5d8) and trim($n2e5d8['site_title']) != '' ){ return trim($n2e5d8['site_title']); } else { return DEFAULT_BLOG_TITLE; } } function r2640(){ global $n2e5d8; if ( array_key_exists('author',$n2e5d8) and trim($n2e5d8['author']) != '' ){ return trim($n2e5d8['author']); } else { return DEFAULT_BLOG_AUTHOR; } } function e2_stripslashes_array($qf1f71){ return is_array($qf1f71)?array_map('e2_stripslashes_array',$qf1f71):stripslashes($qf1f71); } function q269a(){ if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function v8e95(){ if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0) and !is_file('.htaccess')) { if(is_file('htaccess')) { if (@rename('htaccess','.htaccess')) { e2_go_to(); } } echo 'Looks like you are using Apache and have lost or forgot to put in place "htaccess" file. Please obtain it from E2 installation package and put into your installation directory.'; die; } } function e2m_frontpage($parameters=array ()) { global $n2e5d8,$v5c4a6, $_config; $b71860=$parameters['page']; $cd7e5d=$n2e5d8['appearance']['notes_per_page']; $u06d2e=z8ca0(true,true); if (qe852())$u06d2e+=z8ca0(true,false); $iae0fe=ceil($u06d2e/$cd7e5d); $ld29bb=CACHE_FILENAME_FRONTPAGE; if (qe852())$ld29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if(CACHE_FRONTPAGE and $b71860==1 and is_file($ld29bb)) { $o4358b=@unserialize(ocdf0($ld29bb)); } if(CACHE_FRONTPAGE and $b71860==1 and is_array($o4358b)) { } else { if (($result=e50d7('web',$b71860)) === false){ d8a40('Невозможно отобразить последние заметки'); return array ( 'title' => htmlspecialchars(t6f51(),ENT_NOQUOTES), ); } $o4358b=array(); if(count($result) > 0){ foreach($result as $f8ce4b => $xaad65){ $xaad65['_']['_id']=$xaad65['ID']; $xaad65['_']['_title']=oea9c($xaad65); $xaad65['_']['_ord']=$f8ce4b; $xaad65['_']['_ord_max']=count($result)-1; $ke244c=r6791($xaad65); $o4358b[] = $ke244c; } } else { if ($b71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $b71860==1)k6e52($ld29bb,serialize($o4358b)); } $vb3b32['numbered']=true; $vb3b32['count']=$iae0fe; $vb3b32['this'] = (int)$b71860; if ($iae0fe > 0){ if ($b71860 > 1)$v5c4a6['navigation_links']['prev'] = f83c8('e2m_frontpage', array ('page' => $b71860-1)); if ($b71860 < $iae0fe)$v5c4a6['navigation_links']['next'] = f83c8('e2m_frontpage', array ('page' => $b71860+1)); if ($b71860 > $iae0fe){ $v5c4a6['navigation_links']['prev'] = $v5c4a6['navigation_links']['next'] = f83c8('e2m_frontpage', array ('page' => $iae0fe)); } if (@$_config['invert_prevnext_order']) { $e3d801=$v5c4a6['navigation_links']['next']; $v5c4a6['navigation_links']['next']=$v5c4a6['navigation_links']['prev']; $v5c4a6['navigation_links']['prev']=$e3d801; $vb3b32['title']='Заметки'; $vb3b32['prev-title']='<a>предыдущие</a>'; $vb3b32['next-title']='<a>следующие</a>'; } else { $vb3b32['title']='Заметки'; $vb3b32['prev-title']='<a>следующие</a>'; $vb3b32['next-title']='<a>предыдущие</a>'; } } if ($v5c4a6['navigation_links']['prev']) $vb3b32['prev-href']=$v5c4a6['navigation_links']['prev']; if ($v5c4a6['navigation_links']['next']) $vb3b32['next-href']=$v5c4a6['navigation_links']['next']; $q05df2=t6f51(); $ud5d3d=''; if(1==$b71860 and @$o4358b[0]['_']['_title']) { $ud5d3d=$q05df2 .': '. $o4358b[0]['_']['_title']; } elseif (@$o4358b[0]['_']['_title']) { $ud5d3d=$o4358b[0]['_']['_title']; } else { $ud5d3d=$q05df2; } return array ( 'frontpage?' => (bool) ($b71860==1), 'title' => $ud5d3d, 'notes' => $o4358b, 'pages' => $vb3b32, ); } function e2m_frontpage_rss($parameters=array ()) { global $n2e5d8; $x8bb85=''; $ef0e70=0; if (($result=e50d7('rss')) !== false){ foreach($result as $xaad65){ if ($xaad65['IsVisible']) { $x8bb85.=m307d($xaad65); $ef0e70=max($ef0e70,$xaad65['Stamp']); } } } hd371( CACHE_FILENAME_FRONTPAGE_RSS,$x8bb85,$ef0e70, $n2e5d8['site_title'], f83c8('e2m_frontpage') ); die; } function e2m_note_comments_rss($parameters=array ()) { global $n2e5d8,$_config; $xaad65=e2_published_noterec_with_parameters_($parameters); $ef0e70=0; if ( ($result=b1baf($xaad65['ID'],"AND `Stamp` > ". (time()-SECONDS_IN_A_MONTH) ." ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'])) !== false ){ foreach($result as $i06d4c){ if ($i06d4c['IsVisible'] and !$i06d4c['IsSpamSuspect']) { $x8bb85.=pc6e2($xaad65,$i06d4c); $ef0e70=max($ef0e70,$i06d4c['Stamp']); } } } hd371( '',$x8bb85,$ef0e70, $n2e5d8['site_title'] .', комментарии к заметке: '. $xaad65['Title'], f83c8('e2m_note', array ('*note' => $xaad65)) ); die; } function e2m_tag_rss($parameters=array ()) { global $n2e5d8,$_config; if(array_key_exists('_tagrec',$parameters)) { $le4d23=$parameters['_tagrec']; } else { return e2_error404_mode(); } $h56790[] = ( "`". $n2e5d8['db']['table_prefix'] . "NotesKeywords`.KeywordID=". $le4d23['ID'] ); $h56790=implode(' OR ',$h56790); $hc2b7b=$n2e5d8['db']['table_prefix']; return xcbfb( "INNER JOIN `". $hc2b7b."NotesKeywords` ". "ON `". $hc2b7b."NotesKeywords`.NoteID=`". $hc2b7b."Notes`.ID ". "WHERE (". $h56790 .") ". "ORDER BY `". $hc2b7b ."Notes`.`Stamp` DESC LIMIT ". $_config['rss_items'], $n2e5d8['site_title'] .', заметки с тегом: '. $le4d23['Keyword'], f83c8('e2m_tag',$parameters) ); } function e2m_found_rss($parameters=array ()) { global$_config,$n2e5d8; $parameters['query']=wedd9(trim($parameters['query'])); $t1b1cc=$parameters['query']; return xcbfb( "WHERE MATCH (`Title`, `Text`) AGAINST ('".h7928(preg_quote($t1b1cc))."') ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'], $n2e5d8['site_title'] .', результаты поиска: '. $t1b1cc, f83c8('e2m_found',$parameters) ); } function xcbfb($b15c46,$ud5d3d,$h2a304){ global $n2e5d8; $x8bb85=''; $ef0e70=0; if ((t0738( "SELECT `". $n2e5d8['db']['table_prefix']."Notes`.* ". "FROM `". $n2e5d8['db']['table_prefix']."Notes` ". $b15c46 )) !== false){ $result=t0d6b(); foreach($result as $xaad65){ if ($xaad65['IsVisible']) { $x8bb85.=m307d($xaad65); $ef0e70=max($ef0e70,$xaad65['Stamp']); } } } hd371( '',$x8bb85,$ef0e70, $ud5d3d, $h2a304 ); die; } function y3010($ud5d3d,$se8fab){ global $v5c4a6; $f336a4=array ('title' => $ud5d3d,'href' => $se8fab); $v5c4a6['newsfeeds'][] = $f336a4; } function m307d($xaad65){ global $n2e5d8,$p57de2; $g90141=f83c8('e2m_note', array ('*note' => $xaad65)); $t59aeb=wce23($xaad65['ID']); foreach ($t59aeb as $m865c0 => $dd7df5){ $t59aeb[$m865c0] = ( '<a href="'. f83c8('e2m_tag', array ('tag-urlname' => $dd7df5['URLName'])). '">'. htmlspecialchars($dd7df5['Keyword'],ENT_NOQUOTES). '</a>' ); } $x8bb85=''; $x8bb85.='<item>'; $x8bb85.='<title>'. (htmlspecialchars(oea9c($xaad65),ENT_NOQUOTES)) .'</title>'; $x8bb85.='<guid isPermaLink="true">'. $g90141 .'</guid>'; $x8bb85.='<link>'. $g90141 .'</link>'; if (@$n2e5d8['comments']['on']) { $x8bb85.='<comments>'. $g90141 .'</comments>'; } $x67daf=r154e($xaad65['FormatterID'], @$xaad65['Text'],'full'); $f8e238[] = '<small>'.implode(', ',$t59aeb).'</small>'; if (@$f8e238){ $x67daf.='<hr />'. implode('<br /><br />',$f8e238); } $x8bb85.='<description>'; $x8bb85.=htmlspecialchars($x67daf,ENT_NOQUOTES); $x8bb85.='</description>'; $y588e0 = e2_format_dt_of_current_timezone('D, d M Y H:i:s ',$xaad65['Stamp']) . e2_timezone_gmt_offset_of_current_timezone_rfc2822($xaad65['Stamp']); $x8bb85.='<pubDate>'. $y588e0 .'</pubDate>'; $x8bb85.='</item>'; return $x8bb85; } function pc6e2($xaad65,$i06d4c){ global $n2e5d8,$p57de2; $g90141=f83c8('e2m_note', array ('*note' => $xaad65)); $o0ad4f = '<b>'. htmlspecialchars($i06d4c['AuthorName'],ENT_NOQUOTES) .'</b>, комментарий к заметке <a href="'. $g90141 .'">"'. u6f10(htmlspecialchars(oea9c($xaad65),ENT_NOQUOTES)) .'"</a>'; $x8bb85=''; $x8bb85.='<item>'; $x8bb85.='<title>'. strip_tags($o0ad4f) .'</title>'; $x8bb85.='<link>'. $g90141 .'</link>'; $x67daf=$o0ad4f.':'; $x67daf.='<br /><br />'; $y64be6=r154e($xaad65['FormatterID'],$i06d4c['Text'],'simple'); $x67daf.=$y64be6; $x8bb85.='<description>'; $x8bb85.=htmlspecialchars($x67daf,ENT_NOQUOTES); $x8bb85.='</description>'; $y588e0 = e2_format_dt_of_current_timezone('D, d M Y H:i:s ',$i06d4c['Stamp']) . e2_timezone_gmt_offset_of_current_timezone_rfc2822($i06d4c['Stamp']); $x8bb85.='<pubDate>'. $y588e0 .'</pubDate>'; $x8bb85.='</item>'; return $x8bb85; } function hd371($u1cd44,$o691d5,$ef0e70,$ud5d3d,$h2a304){ global $n2e5d8; $x8bb85 = '<?xml version="1.0" encoding="utf-8"?>'. '<rss version="2.0">'. '<channel><title>'. htmlspecialchars($ud5d3d,ENT_NOQUOTES) .'</title>'. '<link>'. $h2a304 .'</link>'. '<description>'.'</description>'. '<language>'. RSS_LANGUAGE .'</language>'. '<generator>e2 ('. E2_WEBSITE .')</generator>'. $o691d5. '</channel>'. '</rss>'; $m54870=gmdate('r',$ef0e70); $r1872a=md5($ef0e70); header('Content-type: application/xml; charset=utf-8'); header('Last-modified: '.$m54870); header('Etag: '.$r1872a); header('Cache-Control: public'); header('Expires: '. date('r',$ef0e70+SECONDS_IN_A_DAY)); $j0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']): false; $lc3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']): false; if ( !$j0c3cd && !$lc3522 or $lc3522 && $lc3522!=$r1872a or $j0c3cd && $j0c3cd!=$m54870 ){ $x8bb85=nfd97($x8bb85); if (!empty ($u1cd44) and !qe852()) { k6e52($u1cd44,$x8bb85); } echo $x8bb85; } else { header('HTTP/1.1 304 Not Modified'); } return true; } function e2m_year($parameters=array ()) { global$_strings,$n2e5d8; $m84cdc=$parameters['year']; $d09d6c=e2l_get_string('pt--nth-year', array ('year' => $m84cdc)); if (!a1665($m84cdc)) { return e2_error404_mode(); } $be6e7d=gmmktime(0,0,0,1,1,$m84cdc-1); $v029bd=gmmktime(0,0,0,1,1,$m84cdc+1); list ($b8aebd,$x5a7f3)=e2__fruitful_neighbours_with_ymd_($m84cdc); $pa6d40='e2m_year'; if ($b8aebd){ $vb3b32['prev-href']=f83c8( $pa6d40,e2__parameters_with_timestamp_($b8aebd) ); $vb3b32['prev-jump?'] = (bool) (gmdate('Y',$be6e7d)!=gmdate('Y',$b8aebd)); $vb3b32['prev-title']='<a>'. gmdate('Y',$b8aebd) .'</a>'; } if ($x5a7f3){ $vb3b32['next-href']=f83c8( $pa6d40,e2__parameters_with_timestamp_($x5a7f3) ); $vb3b32['next-jump?'] = (bool) (gmdate('Y',$v029bd)!=gmdate('Y',$x5a7f3)); $vb3b32['next-title']='<a>'. gmdate('Y',$x5a7f3) .'</a>'; } $vb3b32['numbered?']=false; $vb3b32['title']=$_strings['gs--years']; $vb3b32['this']=$m84cdc; $vb3b32['this-title']=$m84cdc; $tb2442=tcc02('start'); $z8dbc7=tcc02('end'); if ( $m84cdc==e2_format_dt_of_timezone('Y',$tb2442['stamp'],$tb2442['timezone']) ) { $bfa098=e2_format_dt_of_timezone('m',$tb2442['stamp'],$tb2442['timezone']); } else { $bfa098=1; } if ( $m84cdc==e2_format_dt_of_current_timezone('Y',time()) ) { $yfd384=e2_format_dt_of_current_timezone('m',time()); } else { $yfd384=12; } $n6eac3=sb92c($m84cdc); for ($l7436f=1; $l7436f <= 12; ++ $l7436f){ $e7f769=gmmktime(0,0,0,$l7436f,1,$m84cdc); $ld039b[$l7436f] = array ( 'number' => $l7436f, 'start-time' => array ($e7f769,e2_no_timezone()), 'href' => gmdate('Y/m/',$e7f769), 'real?' => $l7436f >= $bfa098 and $l7436f <= $yfd384, 'fruitful?' => @in_array(gmdate('n',$e7f769),$n6eac3), ); } list ($k7b314,$ba1f20)=e2_boundaries_worldwide($m84cdc); t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $k7b314 ." ". "AND ". $ba1f20 ." ". "ORDER BY `Stamp`" ); $result=t0d6b(); $o4358b=d28df($result,$m84cdc); return array ( 'title' => $d09d6c, 'heading' => $d09d6c, 'pages' => $vb3b32, 'year' => (int)$m84cdc, 'year-months' => $ld039b, 'notes-list' => $o4358b, ); } function e2m_month($parameters=array ()) { global$_strings,$n2e5d8; $m84cdc= $parameters['year']; $l7436f=$parameters['month']; $d09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $m84cdc,'month' => $l7436f) ); if (!a1665($m84cdc,$l7436f)) { return e2_error404_mode(); } $be6e7d=gmmktime(0,0,0,$l7436f-1,1,$m84cdc); $v029bd=gmmktime(0,0,0,$l7436f+1,1,$m84cdc); list ($b8aebd,$x5a7f3)=e2__fruitful_neighbours_with_ymd_($m84cdc,$l7436f); $pa6d40='e2m_month'; if ($b8aebd){ $vb3b32['prev-href']=f83c8( $pa6d40,e2__parameters_with_timestamp_($b8aebd) ); $vb3b32['prev-jump?'] = (bool) (gmdate('Y/m',$be6e7d)!=gmdate('Y/m',$b8aebd)); $vb3b32['prev-title'] = '<a>'. e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$b8aebd),'month' => gmdate('n',$b8aebd) ) ) .'</a>'; } if ($x5a7f3){ $vb3b32['next-href']=f83c8( $pa6d40,e2__parameters_with_timestamp_($x5a7f3) ); $vb3b32['next-jump?'] = (bool) (gmdate('Y/m',$v029bd)!=gmdate('Y/m',$x5a7f3)); $vb3b32['next-title'] = '<a>'. e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$x5a7f3),'month' => gmdate('n',$x5a7f3) ) ) .'</a>'; } $vb3b32['numbered?']=false; $vb3b32['title']=$_strings['gs--months']; $vb3b32['this-title']=$d09d6c; list ($k7b314,$ba1f20)=e2_boundaries_worldwide($m84cdc,$l7436f); t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $k7b314 ." ". "AND ". $ba1f20 ." ". "ORDER BY `Stamp`" ); $result=t0d6b(); $o4358b=d28df($result,$m84cdc,$l7436f); $se70c4['title']=$d09d6c; $se70c4['heading']=$d09d6c; $se70c4['pages']=$vb3b32; $se70c4['year'] = (int)$m84cdc; $se70c4['month'] = (int)$l7436f; $se70c4['month-days']=e2_pack_month_days_with_ymd_($m84cdc,$l7436f,false); $se70c4['notes-list']=$o4358b; return $se70c4; } function e2m_day($parameters=array ()) { global$_strings; $m84cdc= (int)$parameters['year']; $l7436f=(int)$parameters['month']; $i628b7= (int)$parameters['day']; if (!(a1665($m84cdc,$l7436f,$i628b7))) { return e2_error404_mode(); } $d09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $m84cdc,'month' => $l7436f,'day' => $i628b7) ); $be6e7d=gmmktime(0,0,0,$l7436f,$i628b7-1,$m84cdc); $v029bd=gmmktime(0,0,0,$l7436f,$i628b7+1,$m84cdc); list ($b8aebd,$x5a7f3)=e2__fruitful_neighbours_with_ymd_($m84cdc,$l7436f,$i628b7); $pa6d40='e2m_day'; if ($b8aebd){ $vb3b32['prev-href']=f83c8( $pa6d40,e2__parameters_with_timestamp_($b8aebd) ); $vb3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$be6e7d)!=gmdate('Y/m/d',$b8aebd)); $vb3b32['prev-title'] = '<a>'. e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$b8aebd),'month' => gmdate('n',$b8aebd),'day' => gmdate('j',$b8aebd), ) ) .'</a>'; } if ($x5a7f3){ $vb3b32['next-href']=f83c8( $pa6d40,e2__parameters_with_timestamp_($x5a7f3) ); $vb3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$v029bd)!=gmdate('Y/m/d',$x5a7f3)); $vb3b32['next-title'] = '<a>'. e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$x5a7f3),'month' => gmdate('n',$x5a7f3),'day' => gmdate('j',$x5a7f3), ) ) .'</a>'; } $vb3b32['numbered?']=false; $vb3b32['title']=$_strings['gs--days']; $vb3b32['this-title']=$d09d6c; if (($result=yf9fb($m84cdc,$l7436f,$i628b7)) !== false){ $result=array_reverse($result); foreach($result as $f8ce4b => $xaad65){ if ($xaad65['IsVisible'] or qe852()) { $xaad65['_']['_id']=$xaad65['ID']; $xaad65['_']['_ord']=k; $xaad65['_']['_ord_max']=count($result)-1; $o4358b[] = r6791($xaad65); } } } $se70c4['title']=$d09d6c; $se70c4['heading']=$d09d6c; $se70c4['pages']=$vb3b32; $se70c4['notes']=$o4358b; $se70c4['month-days']=e2_pack_month_days_with_ymd_($m84cdc,$l7436f,$i628b7); return $se70c4; } function e2m_everything($parameters=array ()) { global$_strings,$n2e5d8; $o4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $o4358b=@unserialize(ocdf0(CACHE_FILENAME_FULLLIST)); if(__LOG)__log('Everything: retrieving from cache...'); } if (!is_array($o4358b)) { if(__LOG)__log('Everything: retrieving from database...'); t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "ORDER BY `Stamp`" ); $result=t0d6b(); if(__LOG)__log('Everything: preparing notes list...'); $o4358b=d28df($result); if(__LOG)__log('Everything: saving cache...'); if(CACHE_FULLLIST)k6e52(CACHE_FILENAME_FULLLIST,serialize($o4358b)); } $s1f525=count($o4358b); $d09d6c=e2l_get_string('pt--n-notes', array ('number' => $s1f525)); if(array_key_exists('part',$_GET) and array_key_exists('of',$_GET)) { if(__LOG)__log('Everything: splitting into parts...'); $af4c93=$_GET['part']; $o8bf88=$_GET['of']; $d09d6c.=' ('. e2l_get_string('gs--part-x-of-y', array ('part' => $af4c93,'of' => $o8bf88)) .')'; $y895e3=$s1f525/$o8bf88; $dd98a0=($af4c93-1)*$y895e3; $g01b6e=$af4c93*$y895e3; $o4358b=array_slice($o4358b,round($dd98a0),round($g01b6e-round($dd98a0))); } if(__LOG)__log('Everything: done, returning'); return array ( 'class' => 'everything', 'title' => $d09d6c, 'heading' => $d09d6c, 'notes-list' => $o4358b, ); } function e2_pack_month_days_with_ymd_($m84cdc,$l7436f,$i628b7){ $na6933=e2_format_dt_of_timezone('t',gmmktime(0,0,0,$l7436f,1,$m84cdc),e2_no_timezone()); $tb2442=tcc02('start'); $z8dbc7=tcc02('end'); if ( $m84cdc .'/'. $l7436f == e2_format_dt_of_timezone('Y/n',$tb2442['stamp'],$tb2442['timezone']) ) { $n42eb4=e2_format_dt_of_timezone('d',$tb2442['stamp'],$tb2442['timezone']); } else { $n42eb4=1; } if ( $m84cdc .'/'. $l7436f == e2_format_dt_of_current_timezone('Y/n',time()) ) { $ed5f50=e2_format_dt_of_current_timezone('d',time()); } else { $ed5f50=$na6933; } $qe4602=e82dc($m84cdc,$l7436f); for ($m865c0=1; $m865c0 <= $na6933; ++ $m865c0){ $e7f769=gmmktime(0,0,0,$l7436f,$m865c0,$m84cdc); $i271c1[$m865c0] = array ( 'number' => $m865c0, 'start-time' => array ($e7f769,e2_no_timezone()), 'href' => gmdate('Y/m/d/',$e7f769), 'this?' => (bool) ($m865c0==$i628b7), 'real?' => $m865c0 >= $n42eb4 and $m865c0 <= $ed5f50, 'fruitful?' => @in_array(gmdate('d',$e7f769),$qe4602), ); } return $i271c1; } function a1665($m84cdc,$l7436f=false,$i628b7=false){ $tb2442=tcc02('start'); if ($tb2442===false){ return false; } $cc1f1e=e2_format_dt_of_timezone('Y',$tb2442['stamp'],$tb2442['timezone']); $rebeb3=e2_format_dt_of_current_timezone('Y',time()); if ($l7436f===false){ return (bool) ( $m84cdc >= $cc1f1e and $m84cdc <= $rebeb3 ); } else { $z782fc=e2_format_dt_of_timezone('n',$tb2442['stamp'],$tb2442['timezone']); $l13dd1=e2_format_dt_of_current_timezone('n',time()); if ($i628b7===false){ return (bool) ( $l7436f >= 1 and $l7436f <= 12 and ( ($m84cdc > $cc1f1e and $m84cdc < $rebeb3) or ($m84cdc==$cc1f1e and $l7436f >= $z782fc) or ($m84cdc==$rebeb3 and $l7436f <= $l13dd1) ) ); } else { $c7a9c0=e2_format_dt_of_timezone('j',$tb2442['stamp'],$tb2442['timezone']); $l23209=e2_format_dt_of_current_timezone('j',time()); if(1){ return (bool) ( checkdate($l7436f,$i628b7,$m84cdc) and ( ($m84cdc > $cc1f1e and $m84cdc < $rebeb3) or ($m84cdc==$cc1f1e and $l7436f > $z782fc) or ($m84cdc==$cc1f1e and $l7436f==$z782fc and $i628b7 >= $c7a9c0) or ($m84cdc==$rebeb3 and $l7436f < $l13dd1) or ($m84cdc==$rebeb3 and $l7436f==$l13dd1 and $i628b7 <= $l23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($p41529,$r6f8f5=false,$n8277e=false){ global $n2e5d8,$c3afe6; list ($o3d2fa,$e9468c)=e2_boundaries_worldwide($p41529,$r6f8f5,$n8277e); $hada4b=SECONDS_IN_A_DAY; if ($n8277e===false)$hada4b=SECONDS_IN_A_MONTH; if ($r6f8f5===false)$hada4b=SECONDS_IN_A_YEAR; if (!qe852())$if79b1="`IsVisible`=1 AND "; if (u0f7c()) { $c3afe6['result']=mysql_query( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $n2e5d8['db']['table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$if79b1. "Stamp < '". ($e9468c-$hada4b) ."' ". "ORDER BY Stamp DESC", $c3afe6['link'] ); while ($l6438c=@mysql_fetch_array($c3afe6['result'],MYSQL_ASSOC)) { list ($m84cdc,$l7436f,$i628b7)=explode('/', e2_format_dt_of_timezone('Y/n/j',$l6438c['Stamp'],e2_note_timezone($l6438c)) ); $q7474d=$p41529*10000 + ($r6f8f5? ($r6f8f5*100):0) + ($n8277e? $n8277e:0); $cbd8da=$m84cdc*10000 + ($r6f8f5? ($l7436f*100):0) + ($n8277e? $i628b7:0); if ($cbd8da < $q7474d){ $xbf025=gmmktime(0,0,0,$l7436f,$i628b7,$m84cdc); break; } } $c3afe6['result']=mysql_query( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $n2e5d8['db']['table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$if79b1. "Stamp > '". ($o3d2fa+$hada4b) ."' ". "ORDER BY Stamp", $c3afe6['link'] ); while ($l6438c=@mysql_fetch_array($c3afe6['result'],MYSQL_ASSOC)) { list ($m84cdc,$l7436f,$i628b7)=explode('/', e2_format_dt_of_timezone('Y/n/j',$l6438c['Stamp'],e2_note_timezone($l6438c)) ); $q7474d=$p41529*10000 + ($r6f8f5? ($r6f8f5*100):0) + ($n8277e? $n8277e:0); $cbd8da=$m84cdc*10000 + ($r6f8f5? ($l7436f*100):0) + ($n8277e? $i628b7:0); if ($cbd8da > $q7474d){ $s8dc98=gmmktime(0,0,0,$l7436f,$i628b7,$m84cdc); break; } } return array ($xbf025,$s8dc98); } } function e2__parameters_with_timestamp_($g96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$g96b8c)); return$parameters; } function d28df($uc2d18,$m84cdc=false,$l7436f=false){ $w229c3=0; $o4358b=array(); $af09d8=''; $o4358b=array(); foreach ($uc2d18 as $f8ce4b => $z39a37){ $la88c7=e2_format_dt_of_timezone( 'Y/m/d',$z39a37['Stamp'],e2_note_timezone($z39a37) ); if ($la88c7!=$af09d8)$w229c3=0; $af09d8=$la88c7; ++ $w229c3; list ($p41529,$r6f8f5,$n8277e)=explode('/',$la88c7); $xaad65['href']=f83c8('e2m_note', array ( 'year' => $p41529, 'month' => $r6f8f5, 'day' => $n8277e, 'day-number' => $w229c3, )); $xaad65['time'] = array ((int)$z39a37['Stamp'],e2_note_timezone($z39a37)); $xaad65['last-modified'] = array ((int)$z39a37['LastModified'],e2_note_timezone($z39a37)); $xaad65['favourite?'] = (bool) ($z39a37['IsFavourite'] && $z39a37['IsPublished']); $xaad65['title']=htmlspecialchars(oea9c($z39a37),ENT_NOQUOTES); if ( ($m84cdc and $l7436f and ( ((int)$m84cdc) .'/'. ((int)$l7436f) == e2_format_dt_of_timezone('Y/n',$z39a37['Stamp'],e2_note_timezone($z39a37)) )) or ($m84cdc and !$l7436f and ( (int)$m84cdc == e2_format_dt_of_timezone('Y',$z39a37['Stamp'],e2_note_timezone($z39a37)) )) or (!$m84cdc and !$l7436f) ) { array_unshift($o4358b,$xaad65); } } return $o4358b; } function kdefb($mb1bc2,$d151be,$q418f6=true,$pddef8=true){ if (!is_array($d151be))$d151be=explode('|',$d151be); $bc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($mb1bc2%100 > 10 && $mb1bc2%100 < 20)$acd14c=2; else $acd14c=$bc78bd[$mb1bc2%10]; $ud5d3d=$d151be[$acd14c]; if ($ud5d3d{0} != '-')$ud5d3d=' '. $ud5d3d; if (!$pddef8 and $mb1bc2==1)$mb1bc2=''; if ($q418f6)$ud5d3d=$mb1bc2.$ud5d3d; return $ud5d3d; } function u6b8c($j435ed){ $y599dc=hfd08($j435ed); if ($y599dc==1 and function_exists('imagecreatefromgif')) return array (imagecreatefromgif($j435ed),'gif'); elseif ($y599dc==2 and function_exists('imagecreatefromjpeg')) return array (imagecreatefromjpeg($j435ed),'jpeg'); elseif ($y599dc==3 and function_exists('imagecreatefrompng')) return array (imagecreatefrompng($j435ed),'png'); elseif ($y599dc==16 and function_exists('imagecreatefromxbm')) return array (imagecreatefromxbm($j435ed),'xbm'); } function hfd08($j435ed,$p1b736=0,$ebfe4b=0){ $pcaf9b=getimagesize($j435ed); if (!$pcaf9b) return; if ($p1b736>0 and $ebfe4b>0){ if ($pcaf9b[0]>$p1b736) return; if ($pcaf9b[1]>$ebfe4b) return; } if ($pcaf9b[2]>3) return; return $pcaf9b[2]; } function h15e4($pfce75,$xc69cd,$xd35fb,$qd6663,$m1c925=''){ if (!extension_loaded('gd')) { if (!dl('gd.so')) { header('Content-type: image/gif'); return false; } } list ($w73beb,$y599dc)=u6b8c($pfce75); if (!$w73beb){ return false; } $weaae2=imagesx($w73beb); $zb435e=imagesy($w73beb); $k0cb47=min($xc69cd/$weaae2,$xd35fb/$zb435e); if ($k0cb47 < 1){ $xc69cd=round($weaae2*$k0cb47); $xd35fb=round($zb435e*$k0cb47); } else { $xc69cd=$weaae2; $xd35fb=$zb435e; } $b28e3d=imagecreatetruecolor($xc69cd,$xd35fb); imageinterlace($b28e3d,1); if (empty ($m1c925)) { $h19229=stat($pfce75); $h19229=date('r',$h19229['mtime']); header('Last-Modified: '.$h19229); } imagecopyresampled($b28e3d,$w73beb,0,0,0,0,$xc69cd,$xd35fb,$weaae2,$zb435e); imagejpeg($b28e3d,$m1c925,$qd6663); return true; } function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('Sync done.'); } function e2_note_cache_filename_with_id_($eb80bb){ return str_replace('*',$eb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($s21158){ ke2f1(); j22e7(); @unlink(e2_note_cache_filename_with_id_($s21158)); @unlink(e2_note_cache_filename_with_id_($s21158 .'-comments')); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_FAVS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); @unlink(CACHE_FILENAME_FULLLIST); } function z7996(){ pc5a6(CACHE_FILENAMES_NOTES); pc5a6(CACHE_FILENAMES_NOTES_COMMENTS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); } function ke2f1(){ pc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function j22e7(){ pc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ pc5a6(CACHES_FOLDER.'*'); return true; } function q4e27($m139c8){ global$_template; $saf10b=array(); $h8598c=$m139c8; $y620f7=TEMPLATES_FOLDER.$h8598c .'/'; if ( e2_is_installed() and $m139c8!='' and !array_key_exists('themeless',$_GET) ) { if ( is_dir($y620f7) and is_file($y620f7 .'/theme-info.php') ) { while (1){ $y620f7=TEMPLATES_FOLDER.$h8598c .'/'; array_push($saf10b,$y620f7); $v38226=include $y620f7 .'/theme-info.php'; $s4e502[$y620f7]=$v38226; if(array_key_exists('based_on',$v38226)) { $h8598c=$v38226['based_on']; } else { break; } } } else { } } array_push($saf10b,DEFAULT_TEMPLATE_FOLDER); $_template['name']=$m139c8; $_template['stack']=$saf10b; $_template['infos']=$s4e502; return$_template; }; function u53ee($md436e){ global$content; ++ $_olba_includes; include $md436e; } function s6a97($z52678){ if(0){ echo '<div style="background: #ff0">'.$z52678.'</div>'; } if(is_dir(EXTRAS_FOLDER)) { $a71cae=EXTRAS_FOLDER.$z52678 .'.tmpl.php'; if(is_file($a71cae)) { u53ee($a71cae); } } return ''; } function w166b($z52678){ global$_template,$_olba_includes; $a71cae='templates/'. $z52678 .'.tmpl.php'; if ($md436e=e2o__usable_file_with_basename_($a71cae)) { u53ee($md436e); } else { q1928($a71cae); } } function ybc21(){ global$_config; if (@$_config['raw_template_data'] or array_key_exists('raw',$_GET)) { $d3f7d9='raw'; } else { $d3f7d9='main'; } return w166b($d3f7d9); } function q1928($o8b7af){ sf1da($o8b7af,'_olba_missing_templates'); } function gd4c1($b45ac4){ sf1da($b45ac4,'_olba_used_stylesheets'); } function nd00a($y3205c){ sf1da($y3205c,'_olba_used_scripts'); } function ke655(){ global$_olba_missing_templates; if (isset ($_olba_missing_templates)) { return array_unique($_olba_missing_templates); } } function x94dd(){ global$_template; $vccf6b['']=DEFAULT_TEMPLATE_FOLDER; if ($ce1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($j1f769=readdir($ce1260))) { if(is_dir(TEMPLATES_FOLDER. $j1f769) and $j1f769!='.' and $j1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$j1f769 .'/theme-info.php')) { $vccf6b[$j1f769]=TEMPLATES_FOLDER.$j1f769 .'/'; } } } closedir($ce1260); } $z10ae9=array(); foreach ($vccf6b as $qb0689 => $s85114){ $v38226=include $s85114 .'theme-info.php'; $zc2657=$v38226['display_name']; if (!is_file($obe5fb=$s85114.$c8c7dd .'preview.png')) { $obe5fb=DEFAULTS_FOLDER.'preview.png'; } $z10ae9[] = array ( 'name' => $qb0689, 'display-name' => $zc2657, 'current?' => (bool) ($qb0689==$_template['name']), 'preview' => $obe5fb, ); } return $z10ae9; } function e1492($j435ed){ return e2o__usable_file_with_basename_('images/'. $j435ed); } function g576f($b45ac4){ global$_template; $x954eb='styles/'. $b45ac4 .'.css'; $o95aa1=array(); foreach($_template['stack'] as $y620f7){ if(is_file($j435ed=$y620f7.$x954eb)) { $o95aa1[] = $j435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$y620f7]) and in_array($b45ac4,$_template['infos'][$y620f7]['reset_styles']) ) { break; } } $o95aa1=array_reverse($o95aa1); } function v37ca(){ global$_olba_used_stylesheets,$_template; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $mc7f50=array(); foreach($_olba_used_stylesheets as $b45ac4){ $x954eb='styles/'. $b45ac4 .'.css'; $o95aa1=array(); foreach($_template['stack'] as $y620f7){ if(is_file($j435ed=$y620f7.$x954eb)) { $o95aa1[] = $j435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$y620f7]) and in_array($b45ac4,$_template['infos'][$y620f7]['reset_styles']) ) { break; } } $o95aa1=array_reverse($o95aa1); $mc7f50=array_merge($mc7f50,$o95aa1); } return $mc7f50; } function c4753(){ global$_olba_used_scripts; $_olba_used_scripts=array_unique($_olba_used_scripts); $vd6c58=array(); foreach($_olba_used_scripts as $y3205c){ $x954eb='js/'. $y3205c .'.js'; if(is_file($f9d679=USER_FOLDER.$x954eb)) { $vd6c58[] = $f9d679; } if ($f9d679=e2o__usable_file_with_basename_($x954eb)) { $vd6c58[] = $f9d679; } } return $vd6c58; } function sf1da($v2063c,$qf1f71){ if (!isset ($GLOBALS[$qf1f71])) { $GLOBALS[$qf1f71] = array ($v2063c); } else { $GLOBALS[$qf1f71][] = $v2063c; } } function e2o__usable_file_with_basename_($x954eb){ global$_template; foreach($_template['stack'] as $y620f7){ if(is_file($j435ed=$y620f7.$x954eb)) { return $j435ed; } } return ''; } function e2s_search(){ global $n2e5d8; $t1b1cc=@$_POST['query']; $t1b1cc=nfd97($t1b1cc); e2_go_to(f83c8('e2m_found', array ('query' => $t1b1cc))); die; } function e2m_found($parameters=array ()) { global $n2e5d8; $parameters['query']=wedd9(trim($parameters['query'])); $t1b1cc=$parameters['query']; if (!$t1b1cc){ return array ( 'title' => 'Текст для поиска пуст', 'heading' => 'Поиск', 'no-notes-text' => 'Текст для поиска пуст, напишите что-нибудь.', ); } if(strlen($t1b1cc) < 4){ return array ( 'title' => 'Слишком короткий текст', 'heading' => 'Поиск', 'no-notes-text' => 'Слишком короткий текст, напишите хотя бы 4 буквы.', ); } $r099fb=$t1b1cc; $if79b1="AND `IsVisible`=1 "; if (qe852())$if79b1=''; $x11128=false; if (t0738( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Keywords` ". "WHERE `Keyword`='".h7928($t1b1cc)."'" )) { $pfa816=t0d6b(); if (isset ($pfa816[0]['ID'])) { $x11128=array ( 'href' => f83c8( 'e2m_tag', TRANS_TAGS_UTF8_URLS ? array ('tag' => htmlspecialchars($pfa816[0]['Keyword'])) : array ('tag-urlname' => $pfa816[0]['URLName']) ), 'name' => htmlspecialchars($t1b1cc), ); } } $d75006='Ничего не найдено.'; $t3ad42=f83c8('e2m_found_rss', array ('query' => $t1b1cc)); y3010( 'Результаты поиска: '. htmlspecialchars($t1b1cc),$t3ad42 ); $f36a38=h7928(preg_quote($t1b1cc)); $oeb31b=( "SELECT * FROM `". $n2e5d8['db']['table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $f36a38 ."')". $if79b1 ); $b8d777=array ( 'query' => $oeb31b, 'page' => $parameters['page'], 'candy' => 'e2m_found', 'parameters' => $parameters, 'title' => '%total% по запросу: '. $r099fb, 'superheading' => '%total% по запросу', 'heading' => $r099fb, 'related-rss-href' => $t3ad42, 'highlight' => n163d(' ',$t1b1cc), 'no-notes-text' => $d75006, ); if ($x11128){ $b8d777['search-related-tag']=$x11128; } return gd864($b8d777); } function df8c7($w0c426,$content){ $m52766=MTMPL_FOLDER.$w0c426 .'.mtmpl.php'; if(is_file($m52766)) { ob_start(); include $m52766; $mb4a11=ob_get_contents(); ob_end_clean(); $mb4a11=explode("\n",trim($mb4a11),2); $rc7191=trim($mb4a11[0]); $gde7a3=trim(@$mb4a11[1]); return array ($rc7191,$gde7a3); } } function laed2(){ global$_config; $f9e35a=$_config['mail_from']; if ($f9e35a[strlen($f9e35a)-1]=='@'){ $f9e35a.=$_SERVER['SERVER_NAME']; } return $f9e35a; } function aa41b($g01b6e,$subject,$z78e73,$r145a2='',$gb2cb3=''){ global $p57de2; if ($p57de2==DEV_HOST){ $d8fa14=tempnam('mail-debug',''); $p1cb25=( 'To:       '.$g01b6e."\n". 'Subject:  '.$subject."\n". "——————————————————————————————————————————————————\n". $z78e73 ); k6e52($d8fa14,$p1cb25); chmod($d8fa14,NEW_FILES_RIGHTS); rename($d8fa14,$d8fa14.'.txt'); } else { $subject='=?Windows-1251?B?'. base64_encode($subject) .'?='; $r145a2.="\r\nContent-Type: text/plain; charset=windows-1251"; mail($g01b6e,$subject,$z78e73,$r145a2,$gb2cb3); } } function _A($p1cb25){ global$_candy,$p57de2,$ra57c1,$l097cc; if ( preg_match('/\<a href\=\"(.*?)\"\>(.*?)\<\/a\>/si',$p1cb25,$i9c28d) and ( $i9c28d[1]=='' or $i9c28d[1]==$l097cc or 'http://'. $p57de2.$i9c28d[1]==$l097cc or 'http://'. $p57de2.$ra57c1 .'/'. $i9c28d[1]==$l097cc or $_candy=='e2m_install' ) ) { return '<span class="current">'. $i9c28d[2] .'</span>'; } else { return $p1cb25; } } function _AT($se8fab){ global$_candy,$p57de2,$ra57c1,$l097cc; return ( $se8fab=='' or $se8fab==$l097cc or 'http://'. $p57de2.$se8fab==$l097cc or 'http://'. $p57de2.$ra57c1 .'/'. $se8fab==$l097cc ); } function _IMGSRC($j435ed){ return e1492($j435ed); } function _COLOR($cf97c5,$sb8a9f,$ecc321,$y4efa2=1){ if(strlen($cf97c5)!=3 and strlen($cf97c5)!=6) return 'f0f'; if(strlen($sb8a9f)!=3 and strlen($sb8a9f)!=6) return 'f0f'; if(strlen($cf97c5)==3)$cf97c5=$cf97c5{0}.$cf97c5{0}.$cf97c5{1}.$cf97c5{1}.$cf97c5{2}.$cf97c5{2}; if(strlen($sb8a9f)==3)$sb8a9f=$sb8a9f{0}.$sb8a9f{0}.$sb8a9f{1}.$sb8a9f{1}.$sb8a9f{2}.$sb8a9f{2}; $ef09cc=array ( $cf97c5{0}.$cf97c5{1}, $cf97c5{2}.$cf97c5{3}, $cf97c5{4}.$cf97c5{5}, $sb8a9f{0}.$sb8a9f{1}, $sb8a9f{2}.$sb8a9f{3}, $sb8a9f{4}.$sb8a9f{5}, ); foreach ($ef09cc as $f8ce4b => $x9e366){ $ef09cc[$f8ce4b]=hexdec($x9e366); } $u22af6=array ( $ef09cc[0]+pow($ecc321,$y4efa2) * ($ef09cc[3]-$ef09cc[0]), $ef09cc[1]+pow($ecc321,$y4efa2) * ($ef09cc[4]-$ef09cc[1]), $ef09cc[2]+pow($ecc321,$y4efa2) * ($ef09cc[5]-$ef09cc[2]), ); $n70dda=''; foreach ($u22af6 as $f8ce4b => $x9e366){ $n70dda.=str_pad(dechex($x9e366),2,'0',STR_PAD_LEFT); } return $n70dda; } function _DT($z1ddcb,$yb35c6){ if (!$yb35c6) return ''; list ($g96b8c,$yb2c6c)=$yb35c6; $s2cb9d=$z1ddcb; $l7436f=e2_format_dt_of_timezone('m',$g96b8c,$yb2c6c); $s2cb9d=str_replace('{zone}',iada7(e2_format_timezone_offset($yb2c6c['offset'])), $s2cb9d); $s2cb9d=str_replace('{month}',iada7(e2_ru_month_nominative($l7436f)), $s2cb9d); $s2cb9d=str_replace('{month-short}',iada7(e2_ru_month_short_nominative($l7436f)), $s2cb9d); $s2cb9d=str_replace('{month-g}',iada7(e2_ru_month_genitive($l7436f)), $s2cb9d); $s2cb9d=e2_format_dt_of_timezone($s2cb9d,$g96b8c,$yb2c6c); return $s2cb9d; } function _AGO($yb35c6){ return e2_ru_ago($yb35c6[0], array ('offset' => $yb35c6[1]['offset'],'is_dst' => $yb35c6[1]['is_dst']) ); } function _NUM($p1cb25){ return eace2($p1cb25); } function _SIZE($size,$n3e34b=_SIZE_AUTO){ return q2d88($size,$n3e34b); } function _FIRST($m437b9){ return ($m437b9['_']['_ord']==0); } function _LAST($m437b9){ return ($m437b9['_']['_ord']==$m437b9['_']['_ord_max']); } function _CSS($mc7a62){ return gd4c1($mc7a62); } function _CSS_HREF($mc7a62){ return g576f($mc7a62); } function _JS($l32981){ return nd00a($l32981); } function _T($z52678){ return w166b($z52678); } function _X($z52678){ return s6a97($z52678); } function _T_FOR($z52678,$fd5566=null){ global$content; if ($fd5566===null)$fd5566=$z52678; if(array_key_exists($fd5566,$content)) { w166b($z52678); } else { return ''; } } function _GUIDES($beca07=false){ global$_olba_guides; if(is_array($beca07))$_olba_guides=$beca07; if (!is_array($_olba_guides)) return; $y88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $g1d623=0; $g07d43=$_olba_guides; $g07d43[] = 100; foreach ($g07d43 as $m865c0 => $xd89e2){ if ($xd89e2==100) break; $g1d623+=$xd89e2; $y88408.='<div style="position: fixed; left: '. $xd89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $ya1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($g07d43 [$m865c0+1]-$g07d43 [$m865c0] < 4){ $y88408.='<div style="'. $ya1b01.'; right: '. (100-$xd89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $xd89e2 .'%</div>'; } else { $y88408.='<div style="'. $ya1b01.'; left: '. $xd89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $xd89e2 .'%</div>'; } } $y88408.='</div>'; $_olba_current_col=0; return $y88408; } function _S($mb45cf){ global$_strings; return$_strings[$mb45cf]; } function _SHORTCUT($qb0689){ return ebb8d($qb0689); } function e2l_get_string($ifa206,$b8d777){ global$_strings; $qb0689=$_strings[$ifa206]; if(preg_match_all('/\$\[(.+?)\]/',$qb0689,$i9c28d,PREG_SET_ORDER)) { foreach ($i9c28d as $re3cc9){ $eb2145=$re3cc9[1]; $vf2ffc=''; if(strstr($eb2145,'.')) list ($eb2145,$vf2ffc)=explode('.',$eb2145,2); if(array_key_exists($eb2145,$b8d777)) { if ($vf2ffc){ $qb0689=str_replace($re3cc9[0],e2l_format_value($vf2ffc,$b8d777[$eb2145],$ifa206),$qb0689); } else { $qb0689=str_replace($re3cc9[0],$b8d777[$eb2145],$qb0689); } } } } return $qb0689; } function e2l_format_value($vf2ffc,$v2063c,$ifa206){ list ($vf2ffc,$v3ad73)=explode('.',$vf2ffc,2); $ze6875='e2lstr_'. $vf2ffc; if(function_exists($ze6875)) { return call_user_func($ze6875,$v2063c,$v3ad73,$ifa206); } else { return $v2063c; } return $v2063c; } function e2_ru_month_nominative($mb1bc2){ $pfa816=array ('Декабрь','Январь','Февраль','Март','Апрель','Май','Июнь', 'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь','Январь'); return $pfa816[(int)$mb1bc2]; } function e2_ru_month_short_nominative($mb1bc2){ $pfa816=array ('дек','янв','фев','март','апр','май','июнь', 'июль','авг','сен','окт','ноя','дек','янв'); return $pfa816[(int)$mb1bc2]; } function e2_ru_month_genitive($mb1bc2){ $pfa816=array (0 => 'декабря',1 => 'января',2 => 'февраля',3 => 'марта',4 => 'апреля',5 => 'мая',6 => 'июня', 7 => 'июля',8 => 'августа',9 => 'сентября',10 => 'октября',11 => 'ноября',12 => 'декабря',13 => 'января'); return $pfa816[(int)$mb1bc2]; } function e2l_load_strings(){ return array ( 'pt--nth-year' => '$[year]-й год', 'pt--nth-month-of-nth-year' => '$[month.monthname] $[year] года', 'pt--nth-day-of-nth-month-of-nth-year' => '$[day] $[month.monthname.genitive] $[year]-го', 'pt--n-notes' => '$[number.cardinal]', 'gs--years' => 'Годы', 'gs--months' => 'Месяцы', 'gs--days' => 'Дни', 'gs--nth-month-of-nth-year' => '$[month.monthname] $[year]-го', 'gs--nth-day-of-nth-month-of-nth-year' => '$[day] $[month.monthname.genitive] $[year]-го', 'gs--part-x-of-y' => 'часть $[part] из $[of]', 'ln--new-note' => 'Новая', 'ln--drafts' => 'Черновики', 'pt--drafts' => 'Черновики', 'wd--draft' => 'черновик', 'pt--new-comment' => 'Новый комментарий', 'pt--edit-comment' => 'Правка комментария', 'pt--reply-to-comment' => 'Ответ на комментарий', 'pt--edit-reply-to-comment' => 'Правка ответа на комментарий', 'gs--you-are-not-subscribed' => 'Кажется, вы и так не подписаны на комментарии к этой заметке', 'gs--unsubscription-didnt-work' => 'Почему-то отписка не сработала', 'gs--comment-not-found' => 'Комментарий не найден', 'gs--post-not-found' => 'Заметка не найдена', 'gs--comment-too-long' => 'Слишком длинный комментарий', 'gs--comment-too-long-description' => 'Вы отправили слишком длинный комментарий, поэтому он не был сохранён.', 'gs--comment-double-post' => 'Повторный комментарий', 'gs--comment-double-post-description' => 'Вы отправили комментарий дважды, сохранён был только один.', 'gs--comment-spam-suspect' => 'Комментарий похож на спам', 'gs--comment-spam-suspect-description' => 'Простите, но робот решил, что это спам, поэтому комментарий не был отправлен.', 'gs--you-are-already-subscribed' => 'Вы подписаны на комментарии. Ссылка для отписки приходит в каждом письме с новым комментарием.', 'er--error-removing-comment' => 'Ошибка при удалении комментария', 'er--error-removing-comment-reply' => 'Ошибка при удалении ответа на комментарий', 'er--post-not-commentable' => 'Эту заметку нельзя комментировать', 'er--name-email-text-required' => 'И имя, и эл. адрес, и текст комментария обязательны', 'er--error-editing-comment-reply' => 'Ошибка при изменении ответа на комментарий', 'fb--submit' => 'Отправить', 'fb--save-changes' => 'Сохранить изменения', 'fb--publish' => 'Опубликовать', 'fb--publish-draft' => 'Опубликовать заметку', 'gs--page-not-found' => 'Страница не найдена', 'er--error-occurred' => 'Произошла ошибка', ); } function e2lstr_monthname($mb1bc2,$v3ad73=''){ if ($v3ad73=='genitive'){ $pfa816=array ( 'декабря','января','февраля','марта','апреля','мая','июня', 'июля','августа','сентября','октября','ноября','декабря','января' ); } elseif ($v3ad73=='short'){ $pfa816=array ( 'дек','янв','фев','март','апр','май','июнь', 'июль','авг','сен','окт','ноя','дек','янв' ); } else { $pfa816=array ( 'Декабрь','Январь','Февраль','Март','Апрель','Май','Июнь', 'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь','Январь' ); } return $pfa816[(int)$mb1bc2]; } function e2lstr_cardinal($mb1bc2,$v3ad73='',$ifa206){ $g4a202=$mb1bc2; if ($ifa206=='pt--n-notes')$g4a202=$mb1bc2 .' замет(ка,ки,ок)'; return eace2($g4a202); } $_strings=e2l_load_strings(); if(!$s589b3) @include 'builder.php'; function e2(){ global $p57de2,$n2e5d8,$errors,$m15d61,$aaaabf,$content, $ra57c1,$kf97aa,$stopwatch,$u11755,$l097cc, $v5c4a6, $_instance, $_candy, $_config, $_auth_sessions, $_route, $_candies_installer, $_candies_public, $_candies_spawning, $_candies_unabortable, $_candies_indexable, $_candies_indexable_conditionally, $_update_info, $_olba_includes; v8e95(); q269a(); if(__LOG)__log('System: go'); $errors=array(); $v5c4a6=array(); header('Content-type: text/html; charset='. OUTPUT_CHARSET); $_instance=false; if(is_file(USER_FOLDER.'instance.psa')) { $o0d149=@ocdf0(USER_FOLDER.'instance.psa') or $o0d149=false; if ($o0d149){ $o0d149=@unserialize($o0d149) or $o0d149=false; if ($o0d149){ $_instance=$o0d149; } } } $i66f61=q4e27(@$n2e5d8['template']); if(__LOG)__log('System: resolve url <'. $_GET['go'] .'>'); m7059(); list ($ic48ba,$parameters)=ab7e9($_GET['go']); if(__LOG)__log( 'System: candy <'. $ic48ba .'>' ); $_candy=$ic48ba; if ( @$_config['debug_slow_ajax'] and ( @$parameters['result']=='ajaxresult' or (array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) ) ) { sleep(1+2 * (rand()/getrandmax())); } if(__LOG)__log('System: make sure that installed'); if (!in_array($ic48ba,$_candies_installer)) { e2_make_sure_that_installed(); } if(in_array($ic48ba,$_candies_unabortable)) { ignore_user_abort(1); } $i58387=(bool)qe852(); $n0b448=!in_array($ic48ba,$_candies_public); $a49ecc=$n0b448 && !$i58387; if(__LOG)__log('System: Security check '. (int)$i58387); $zc1f6f=array ( 'done?' => $i58387, 'required?' => $n0b448, 'necessary?' => $a49ecc, ); $v5c4a6['newsfeeds'] = array (); y3010( htmlspecialchars(t6f51(),ENT_NOQUOTES), f83c8('e2m_frontpage_rss') ); $parameters=e2_unfold_tag_parameters($parameters); if(is_callable($ic48ba)) { if ($a49ecc){ if(substr($ic48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']='Вход'; $content['sign-in-prompt']=ye68c($ic48ba); } } else { if(__LOG)__log('System: Candy call'); $content=call_user_func($ic48ba,$parameters); if(__LOG)__log('System: Candy return'); } } else { $zc1f6f['required?']=false; $zc1f6f['necessary?']=false; $content=e2_error404_mode(); } $content['class']=str_replace('_','-',str_replace('e2m_','',$ic48ba)); $he1671=mec07(); if ($he1671){ $content['message']=$he1671; } $content['_debug'] = array ( '_candy' => $ic48ba, '_parameters' => $parameters, ); $content['sign-in']=$zc1f6f; $content['sessions']['count']=$_auth_sessions['count']; $content['sessions']['multiple?'] = ($_auth_sessions['count'] > 1); if(e2_is_installed()) { if($_config['update_check'] and qe852()) { if(__LOG)__log('System: reading update info...'); $_update_info=@unserialize(ocdf0(USER_FOLDER. '/update-info.psa')); if($_update_info){ if(DOWNLOAD_UPDATES){ $content['update-info']['downloaded?']=$content['update-info']['ready?']=array_key_exists('version-downloaded',$_update_info); } else { $content['update-info']['ready?'] = (bool)$_update_info['status']['available?']; } if($content['update-info']['ready?']) { $content['update-info']['important?'] = (bool) @$_update_info['status']['important?']; $content['update-info']['changesets-count'] = @$_update_info['status']['changesets-count']; } } if(in_array($ic48ba,$_candies_spawning)) { if ( !@$_update_info['last-check'] or @$_update_info['last-check'] < time()-$_config['update_check_interval'] ) { if (!jcc38(f83c8('e2s_check_updates', array ()))) { $_update_info['last-check-failed']=true; } } } if(__LOG)__log('System: done with update check'); } if(array_key_exists('pages',$content)) { $s6ea04=false; if(array_key_exists('prev-href',$content['pages'])) { $v5c4a6['navigation_links']['prev']=$content['pages']['prev-href']; $s6ea04=true; } if(array_key_exists('next-href',$content['pages'])) { $v5c4a6['navigation_links']['next']=$content['pages']['next-href']; $s6ea04=true; } if ($s6ea04){ nd00a('e2-navigation'); } } $content['navigation-links'] = array (array ( 'rel' => 'index', 'href' => f83c8('e2m_frontpage'), 'id' => 'link-index', )); if(array_key_exists('navigation_links',$v5c4a6)) { foreach ($v5c4a6['navigation_links'] as $o7ffc4 => $se8fab){ if ($o7ffc4=='prev')$z20512='id="link-prev" '; if ($o7ffc4=='next')$z20512='id="link-next" '; $content['navigation-links'][] = array ( 'rel' => $o7ffc4, 'href' => $se8fab, 'id' => 'link-'. $o7ffc4, ); } } if(array_key_exists('query',$parameters)) { $t1b1cc=wedd9(trim($parameters['query'])); } else { $t1b1cc=''; } $content['form-search'] = array ( 'form-action' => f83c8('e2s_search'), 'query' => htmlspecialchars(@$t1b1cc), ); } $y1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $y1e2ad='index, follow'; } if(in_array($ic48ba,$_candies_indexable)) { $content['robots']='index, follow'; } if(in_array($ic48ba,$_candies_indexable_conditionally)) { $content['robots']=$y1e2ad; } $content['output-charset']=OUTPUT_CHARSET; $content['base-href']=$kf97aa. '/'; $content['current-href']=$l097cc; $content['title']=strip_tags(u6f10(htmlspecialchars($content['title'],ENT_NOQUOTES))); if (@$content['heading']) { $content['heading']=strip_tags(u6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES))); } $content['blog']['author']=htmlspecialchars(r2640(),ENT_NOQUOTES); if(array_key_exists('description',$n2e5d8)) { $content['blog']['description']=htmlspecialchars($n2e5d8['description'],ENT_NOQUOTES); } $content['blog']['live-author'] = '<span id="e2-blog-author">'. $content['blog']['author'] .'</span>'; $content['blog']['live-description'] = '<span id="e2-blog-description">'. $content['blog']['description'] .'</span>'; $content['blog']['title']=htmlspecialchars(t6f51(),ENT_NOQUOTES); $content['blog']['live-title'] = '<span id="e2-blog-title">'. $content['blog']['title'] .'</span>'; $content['blog']['userpic-href']=DEFAULTS_FOLDER.'userpic.png'; if(is_file(USER_FOLDER .'userpic.png')) { $content['blog']['userpic-href']=USER_FOLDER .'userpic.png'; } elseif(is_file(USER_FOLDER .'userpic.jpg')) { $content['blog']['userpic-href']=USER_FOLDER .'userpic.jpg'; } $content['blog']['href']=f83c8('e2m_frontpage'); $content['blog']['rss-href']=f83c8('e2m_frontpage_rss'); $i97bc5=array (time(),e2_current_timezone()); $q5f36b=e2_format_dt_of_current_timezone('Y',$i97bc5[0]); $content['blog']['now']=$i97bc5; $zaa103=$q5f36b; $c33b09=tcc02('start'); if(array_key_exists('stamp',$c33b09)) { $zaa103=e2_format_dt_of_current_timezone('Y',$c33b09['stamp']); $content['blog']['start-time'] = array ((int)$c33b09['stamp'],$c33b09['timezone']); } $j40d73=(int)z8ca0(true,true); if (qe852()) { list ($pfe9e2,$d85ee4,$b20699)=h2a6b(); if ($pfe9e2)$content['new-comments'] = array ( 'count' => $pfe9e2, 'texts' => $d85ee4, 'href' => $b20699, ); } if (qe852()) { $ed0a87=(($j40d73 + (int)z8ca0(true,false)) == 0); } else { $ed0a87=($j40d73==0); } if($_db_error){ $ed0a87=false; } $r9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:'&mdash;'; $content['blog']['years-range']=$zaa103 . (($zaa103==$q5f36b)? '':($r9fbfe.$q5f36b)); $content['blog']['notes-count']=$j40d73; $content['blog']['virgin?']=$ed0a87; if ($ra57c1){ $content['blog']['parent-site-href']=substr($ra57c1, (int)strpos('/',$ra57c1)); } $content['hrefs'] = array ( 'sign-in' => f83c8('e2m_sign_in'), 'tags' => f83c8('e2m_tags'), 'everything' => f83c8('e2m_everything'), ); if(__LOG)__log('System: e2_modes call'); e2_modes($parameters); if(__LOG)__log('System: e2_modes return'); $content['misc']['sape-link']='http://www.sape.ru/r.206a4276c2.php'; $zc8542=round(e7f78()-$stopwatch,3); $content['engine']['pgt']=str_replace('.',',',$zc8542); if(function_exists('memory_get_peak_usage')) { $content['engine']['mp']=q2d88(memory_get_peak_usage(),_SIZE_MB); } $content['engine']['qc'] = (int) @$u11755; $content['engine']['built?']=$s589b3; $content['engine']['installed?']=e2_is_installed(); $content['engine']['version']='v'. E2_VERSION; $content['engine']['version-description']=E2_VERSION_DESCRIPTION; $content['engine']['href']=E2_WEBSITE; $content['engine']['about']='<span title="E2 '.E2_VERSION_DESCRIPTION .'">Движок&nbsp;&mdash; <a href="'. E2_WEBSITE .'">'. E2_VERSION_NAME .'</a></span>'; $content['_debug']['_current_url']=$l097cc; $content['_debug']['_folder_on_server']=$ra57c1; $content['stylesheets']=v37ca(); $content['scripts']=c4753(); ob_start(); ybc21(); $s78e62=ob_get_contents(); ob_end_clean(); $content['stylesheets']=v37ca(); $content['scripts']=c4753(); if(array_key_exists('newsfeeds',$v5c4a6)) { $content['newsfeeds']=$v5c4a6['newsfeeds']; } ob_start(); w166b('head'); $e96e89=ob_get_contents(); ob_end_clean(); $s78e62=str_replace('<e2:head-data />',$e96e89,$s78e62); if ( $la0856=ke655() and !$_config['ignore_missing_template_files'] ) { echo '<h1>Templates missing</h1>'; echo '<ul>'; foreach ($la0856 as $d380ec){ echo '<li>'. $d380ec.' </li>'; } echo '</ul>'; echo '<pre>'; print_r($content); echo '</pre>'; } else { echo $s78e62; } if(__LOG)__log('System: end'); if(DEV_TRACK_TIME and $p57de2==DEV_HOST){ $g06bc4=str_replace('.',',',round(e7f78()-$stopwatch,3)-$zc8542); echo '<div style="font-size: 300%; text-align: center; position: fixed; bottom: 0; width: 100%; background: #ffc; opacity: .88">'. '<span style="color: #f80">'. $content['engine']['pgt'] .' '. '<small>'. $content['engine']['qc'] .'q</small></span>'. '<span style="color: #08f"> + '. $g06bc4.' '. '<small>'. $_olba_includes .'i</small></span>'. '</div>'; } } if(__LOG)__log(''); ?>